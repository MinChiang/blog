<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>内存映射与零拷贝 | MinChiang的博客</title>
    <meta name="generator" content="VuePress 1.5.2">
    <link rel="icon" href="/icon/favicon16.ico">
    <meta name="description" content="专业讨论技术网站">
    <link rel="preload" href="/assets/css/0.styles.a215708e.css" as="style"><link rel="preload" href="/assets/js/app.4bf8400b.js" as="script"><link rel="preload" href="/assets/js/2.7cac40fb.js" as="script"><link rel="preload" href="/assets/js/10.d232617a.js" as="script"><link rel="prefetch" href="/assets/js/11.9b1f2054.js"><link rel="prefetch" href="/assets/js/12.f02da3d1.js"><link rel="prefetch" href="/assets/js/13.8dd2754d.js"><link rel="prefetch" href="/assets/js/14.264de891.js"><link rel="prefetch" href="/assets/js/15.d96e93b9.js"><link rel="prefetch" href="/assets/js/16.571a785a.js"><link rel="prefetch" href="/assets/js/17.a710ab29.js"><link rel="prefetch" href="/assets/js/18.7f2b67c6.js"><link rel="prefetch" href="/assets/js/19.fd14e980.js"><link rel="prefetch" href="/assets/js/20.e9b20029.js"><link rel="prefetch" href="/assets/js/21.6be25a42.js"><link rel="prefetch" href="/assets/js/22.cbdcd3af.js"><link rel="prefetch" href="/assets/js/23.51636cde.js"><link rel="prefetch" href="/assets/js/24.296a53db.js"><link rel="prefetch" href="/assets/js/25.85779d09.js"><link rel="prefetch" href="/assets/js/26.7ed22291.js"><link rel="prefetch" href="/assets/js/27.ca8ff020.js"><link rel="prefetch" href="/assets/js/28.fa34a8cf.js"><link rel="prefetch" href="/assets/js/29.03ce4139.js"><link rel="prefetch" href="/assets/js/3.cf6c9a20.js"><link rel="prefetch" href="/assets/js/30.9482ff4d.js"><link rel="prefetch" href="/assets/js/31.213917d0.js"><link rel="prefetch" href="/assets/js/32.feb8ee82.js"><link rel="prefetch" href="/assets/js/4.e459caa9.js"><link rel="prefetch" href="/assets/js/5.a2a3c506.js"><link rel="prefetch" href="/assets/js/6.aef31d3b.js"><link rel="prefetch" href="/assets/js/7.12b76415.js"><link rel="prefetch" href="/assets/js/8.3434ed34.js"><link rel="prefetch" href="/assets/js/9.87c654bf.js">
    <link rel="stylesheet" href="/assets/css/0.styles.a215708e.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/images/logo.png" alt="MinChiang的博客" class="logo"> <span class="site-name can-hide">MinChiang的博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/technology/java_basis.html" class="nav-link">
  技术
</a></div><div class="nav-item"><a href="/travel/shantou.html" class="nav-link">
  旅游
</a></div><div class="nav-item"><a href="/chat/develop_experience.html" class="nav-link">
  杂谈
</a></div><div class="nav-item"><a href="/entertainment/switch.html" class="nav-link">
  娱乐
</a></div><div class="nav-item"><a href="/about/now.html" class="nav-link">
  关于
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/technology/java_basis.html" class="nav-link">
  技术
</a></div><div class="nav-item"><a href="/travel/shantou.html" class="nav-link">
  旅游
</a></div><div class="nav-item"><a href="/chat/develop_experience.html" class="nav-link">
  杂谈
</a></div><div class="nav-item"><a href="/entertainment/switch.html" class="nav-link">
  娱乐
</a></div><div class="nav-item"><a href="/about/now.html" class="nav-link">
  关于
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>技术</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/technology/java_basis.html" class="sidebar-link">Java基础</a></li><li><a href="/technology/jvm.html" class="sidebar-link">JVM</a></li><li><a href="/technology/test.html" class="sidebar-link">测试</a></li><li><a href="/technology/frame_components.html" class="sidebar-link">框架组件</a></li><li><a href="/technology/database.html" class="sidebar-link">数据库</a></li><li><a href="/technology/computer.html" aria-current="page" class="active sidebar-link">计算机基础</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/technology/computer.html#内存映射与零拷贝" class="sidebar-link">内存映射与零拷贝</a></li><li class="sidebar-sub-header"><a href="/technology/computer.html#cpu密集型与io密集型" class="sidebar-link">CPU密集型与IO密集型</a></li><li class="sidebar-sub-header"><a href="/technology/computer.html#术语" class="sidebar-link">术语</a></li><li class="sidebar-sub-header"><a href="/technology/computer.html#io模型" class="sidebar-link">IO模型</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/technology/computer.html#详解" class="sidebar-link">详解</a></li><li class="sidebar-sub-header"><a href="/technology/computer.html#linux内核实现的多路复用的方法：" class="sidebar-link">Linux内核实现的多路复用的方法：</a></li><li class="sidebar-sub-header"><a href="/technology/computer.html#bio、nio、aio的区别" class="sidebar-link">BIO、NIO、AIO的区别</a></li><li class="sidebar-sub-header"><a href="/technology/computer.html#内存io调用方式以及区别" class="sidebar-link">内存IO调用方式以及区别</a></li><li class="sidebar-sub-header"><a href="/technology/computer.html#netty的代码样例" class="sidebar-link">Netty的代码样例</a></li><li class="sidebar-sub-header"><a href="/technology/computer.html#netty解决tcp粘包的问题" class="sidebar-link">Netty解决TCP粘包的问题</a></li></ul></li><li class="sidebar-sub-header"><a href="/technology/computer.html#cpu（重点关注）" class="sidebar-link">CPU（重点关注）</a></li><li class="sidebar-sub-header"><a href="/technology/computer.html#tcp-ip协议相关" class="sidebar-link">TCP/IP协议相关</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/technology/computer.html#从输入url到网页呈现，发生了什么事情" class="sidebar-link">从输入URL到网页呈现，发生了什么事情</a></li></ul></li></ul></li><li><a href="/technology/data_structure.html" class="sidebar-link">数据结构</a></li><li><a href="/technology/algorithm.html" class="sidebar-link">算法</a></li><li><a href="/technology/ddd.html" class="sidebar-link">领域驱动模型</a></li><li><a href="/technology/design_pattern.html" class="sidebar-link">设计模式</a></li><li><a href="/technology/vim.html" class="sidebar-link">vim</a></li><li><a href="/technology/business.html" class="sidebar-link">业务</a></li><li><a href="/technology/tools.html" class="sidebar-link">工具</a></li><li><a href="/technology/other.html" class="sidebar-link">其他</a></li><li><a href="/technology/python.html" class="sidebar-link">Python</a></li><li><a href="/technology/go.html" class="sidebar-link">Go</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="内存映射与零拷贝"><a href="#内存映射与零拷贝" class="header-anchor">#</a> 内存映射与零拷贝</h2> <p><img src="/assets/img/内存映射.98bcab0d.jpg" alt="内存映射"></p> <ul><li>对于缓冲IO：有3次数据拷贝，应用程序&lt;-&gt;用户缓冲区，用户缓冲区&lt;-&gt;内核缓冲区，内核缓冲区&lt;-&gt;磁盘</li> <li>对于直接直接IO：有2次数据拷贝，应用程序&lt;-&gt;内核缓冲区，内核缓冲区&lt;-&gt;磁盘</li> <li>对于内存映射：有1次数据拷贝，内核缓冲区&lt;-&gt;磁盘，本质上应用程序和内核缓冲区共用一段内存地址，用同一份数据</li></ul> <p><img src="/assets/img/零拷贝.8bffa425.jpg" alt="零拷贝"></p> <ul><li>直接IO方式（传统方式）：数据从磁盘发送到网络，有4次拷贝，磁盘-&gt;内核缓冲区-&gt;应用程序-&gt;socket缓冲区-&gt;网络</li> <li>零拷贝：有2次拷贝，磁盘-&gt;内核缓冲区，socket缓冲区-&gt;网络，其中零拷贝是针对内存而言的，数据没有在内存里面发生过拷贝的动作</li></ul> <p>下面是一个零拷贝的demo例子：数据从test.log里面零拷贝到socket里面，打开程序，打开cmd并输入telnet 127.0.0.1 8888，会立即回显test.log里面的内容</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ZerocopyTest</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token class-name">File</span> file <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token string">&quot;test.log&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">RandomAccessFile</span> raf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RandomAccessFile</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> <span class="token string">&quot;r&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">FileChannel</span> channel <span class="token operator">=</span> raf<span class="token punctuation">.</span><span class="token function">getChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ServerSocketChannel</span> serverSocketChannel <span class="token operator">=</span> <span class="token class-name">ServerSocketChannel</span><span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        serverSocketChannel<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InetSocketAddress</span><span class="token punctuation">(</span><span class="token number">8888</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">SocketChannel</span> accept <span class="token operator">=</span> serverSocketChannel<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            channel<span class="token punctuation">.</span><span class="token function">transferTo</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> channel<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> accept<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h2 id="cpu密集型与io密集型"><a href="#cpu密集型与io密集型" class="header-anchor">#</a> CPU密集型与IO密集型</h2> <table><thead><tr><th>类型</th> <th>定义</th></tr></thead> <tbody><tr><td>CPU密集型</td> <td>也叫计算密集型，系统大部分时间状况是CPU占用率很高（有很多的计算任务需要完成），I/O在很短时间就可以完成。需要提高代码的运行效率，对于密集型的任务，最好使用C语言编写，而不要使用python</td></tr> <tr><td>IO密集型</td> <td>大部分状况是CPU等待I/O的读写操作，常见的大部分任务都是I/O密集型任务，比如web应用。使用运行速度块的语言无法很好地提升运行效率，因此比较适合开发效率高（代码量少，库类多）的语言进行编写</td></tr></tbody></table> <h2 id="术语"><a href="#术语" class="header-anchor">#</a> 术语</h2> <ul><li>RTT：网络数据往返延时，为数据完全发送完（完成最后一个比特推送到数据链路上）到收到确认信号的时间</li> <li>并发：多个任务交替地执行，但多个任务之间有可能还是串行的</li> <li>并行：并行是多个任务同时执行</li></ul> <h2 id="io模型"><a href="#io模型" class="header-anchor">#</a> IO模型</h2> <h3 id="详解"><a href="#详解" class="header-anchor">#</a> 详解</h3> <blockquote><p>IO的阻塞仅针对于操作系统可预见Block才会发生Block。</p></blockquote> <p>因此，对于磁盘文件IO，磁盘硬件的抖动导致IO发生阻塞不属于Block范畴，而从socket中read数据的过程则是属于Block范畴。</p> <blockquote><p>针对于多核CPU机器，Block仅阻塞当前进程。</p></blockquote> <p>一般多核CPU都是基于抢占式进行任务调度的，发生Block仅阻塞当前进程，而不会影响其他进程。</p> <table><thead><tr><th>分类</th> <th>I/O模型</th> <th>具体实现</th> <th>详细描述</th></tr></thead> <tbody><tr><td>同步I/O</td> <td>同步阻塞I/O（BIO）</td> <td>阻塞式的read和write函数调用</td> <td>当用户线程发出IO请求之后，内核会去查看数据是否就绪，如果没有就绪就会等待数据就绪，而用户线程就会处于阻塞状态，用 户线程交出CPU。当数据就绪之后，内核会将数据拷贝到用户线程，并返回结果给用户线程，用户线程才解除block状态。</td></tr> <tr><td>同步I/O</td> <td>同步非阻塞I/O</td> <td>以O_NOBLOCK参数打开fd，然后执行read和write函数调用</td> <td>当用户线程发起一个read操作后，并不需要等待，而是马上就得到了一个结果。如果结果是一个error时，它就知道数据还没有准备好，于是它可以再次发送read操作。一旦内核中的数据准备好了，并且又再次收到了用户线程的请求，那么它马上就将数据拷贝到了用户线程，然后返回。</td></tr> <tr><td>同步I/O</td> <td>I/O多路复用（同步阻塞）（NIO）</td> <td>Linux系统下的三种I/O多路复用的实现方式：select、poll、epoll和Java中的NIO</td> <td>在多路复用IO模型中，会有一个线程不断去轮询多个socket的状态，只有当socket真正有读写事件时，才真正调用实际的IO读写操作。因为在多路复用IO模型中，只需要使用一个线程就可以管理多个socket，系统不需要建立新的进程或者线程，也不必维护这些线程和进程，并且只有在真正有socket读写事件进行时，才会使用IO资源，所以它大大减少了资源占用。</td></tr> <tr><td>异步I/O</td> <td>异步I/O（AIO）</td> <td>Windows上的IOCP，C++Boost asio库（框架模拟出来的异步I/O），Linux aio</td> <td>当用户线程发起read操作之后，立刻就 可以开始去做其它的事。而另一方面，从内核的角度，当它受到一个asynchronous read之后， 它会立刻返回，说明read请求已经成功发起了，因此不会对用户线程产生任何block。然后内核会等待数据准备完成，将数据拷贝到用户线程，当这一切都完成之后，内核会给用户线程发送一个信号，告诉它read操作完成了。也就说用户线程完全不需要实际的整个IO操作是如何进行的，只需要先发起一个请求，当接收内核返回的成功信号时表示IO操作已经完成，可以直接去使用数据了。</td></tr></tbody></table> <h3 id="linux内核实现的多路复用的方法："><a href="#linux内核实现的多路复用的方法：" class="header-anchor">#</a> Linux内核实现的多路复用的方法：</h3> <ul><li><p>select：每次select时需要遍历整个FD集合，不管FD是否是活跃状态。如果没有发现就绪状态，则挂起当前的线程，直到就绪或者主动超时；</p> <p>优点：</p> <ul><li>良好的跨平台支持。</li></ul> <p>缺点：</p> <ul><li>是单个进程所能监视的文件描述数量存在最大限制；</li> <li>对socket进行扫描是线性的，采用轮询方式，效率低；</li> <li>需要内核与用户空间中复制FD数组，开销大。</li></ul></li> <li><p>poll：与select没有本质区别，就是存放FD的集合数据结构不一样：基于链表进行数据存储的，因此没有FD的数量限制；</p></li> <li><p>epoll：需要在linux内核2.6以上，当数据准备完成时内核主动触发回调。</p> <p>两种工作模式：</p> <ul><li>水平触发（LT）（默认的工作方式）：
<ul><li>读缓冲区非空，有数据可读，一直发出可读信号；</li> <li>写缓冲区不满，有空间可写，一直发出可写信号；</li> <li>redis使用LT模式；</li></ul></li> <li>边缘触发（ET）：
<ul><li>读缓冲区由空转为非空，发出一次可读信号；</li> <li>写缓冲区由满转为不满，发出一次可写信号；</li> <li>nginx使用ET模式；</li></ul></li></ul> <p>优点：</p> <ul><li>没有最大并发连接的限制；</li> <li>不是轮询的方式进行查询，不会随着FD数量的增多导致效率下降：只要遍历那些被<strong>内核IO唤醒而加入ready队列</strong>的FD即可；</li> <li>使用mmap方式进行消息传递，减小开销；</li> <li>仅针对活跃的FD有效，非活跃的FD则不会进行回调。</li></ul></li></ul> <h3 id="bio、nio、aio的区别"><a href="#bio、nio、aio的区别" class="header-anchor">#</a> BIO、NIO、AIO的区别</h3> <ul><li><p>BIO</p> <ul><li>等待数据处理完成之后再执行后续的业务内容，数据等待过程中无法做其他事情</li> <li>占据单个线程（一定程度上占据单个CPU）</li> <li>一般来说一次通信建立一个线程，连接数和线程数是1:1关系</li></ul></li> <li><p>NIO</p> <ul><li>不断轮询数据的可用性</li> <li>轮询时间不好把控，过长则会程序延时过大，过短会导致CPU空转</li> <li>连接线程数与后台处理线程数是N:1的关系</li> <li>NIO的一个实现：多路复用
<ul><li>通知内核程序需要监视某些FD是否有IO事件发生，IO多路复用和NIO需要配合一起使用才有实际意义</li> <li>IO多路复用和NIO是相对独立的两种事情，NIO是指IO不会发生阻塞，马上返回，而IO多路复用则是操作系统提供的一种简便的消息通知机制</li></ul></li></ul></li> <li><p>AIO</p> <ul><li>将回调事件注册到内核中，等到数据准备完成（有效）时进行回调</li> <li>类似于发布-订阅的数据通知方式</li></ul></li></ul> <h3 id="内存io调用方式以及区别"><a href="#内存io调用方式以及区别" class="header-anchor">#</a> 内存IO调用方式以及区别</h3> <ul><li>缓冲IO：3次数据拷贝
<ul><li>读：磁盘-&gt;内核缓冲区-&gt;用户缓冲区-&gt;应用程序内存</li> <li>写：应用程序内存-&gt;用户缓冲区-&gt;内核缓冲区-&gt;磁盘</li></ul></li> <li>直接IO：2次数据拷贝
<ul><li>读：磁盘-&gt;内核缓冲区-&gt;应用程序内存</li> <li>写：应用程序内存-&gt;内核缓冲区-&gt;磁盘</li></ul></li> <li>内存映射：1次数据拷贝
<ul><li>读：磁盘-&gt;内核缓冲区--(映射)--&gt;应用程序内存</li> <li>写：应用程序内存--(映射)--&gt;内核缓冲区-&gt;磁盘</li></ul></li> <li>零拷贝：0次数据拷贝
<ul><li>读：磁盘--(映射)--&gt;内核缓冲区</li> <li>写：内核缓冲区--(映射)--&gt;磁盘</li></ul></li></ul> <h3 id="netty的代码样例"><a href="#netty的代码样例" class="header-anchor">#</a> Netty的代码样例</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NettyServer</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token class-name">EventLoopGroup</span> bossGroup <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NioEventLoopGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">EventLoopGroup</span> workerGroup <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NioEventLoopGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">ServerBootstrap</span> b <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServerBootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            b<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span>bossGroup<span class="token punctuation">,</span> workerGroup<span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token class-name">NioServerSocketChannel</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">childHandler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChannelInitializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SocketChannel</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token annotation punctuation">@Override</span>
                        <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">initChannel</span><span class="token punctuation">(</span><span class="token class-name">SocketChannel</span> socketChannel<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
                            <span class="token class-name">ChannelPipeline</span> pipeline <span class="token operator">=</span> socketChannel<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            pipeline<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StringDecoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            pipeline<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token string">&quot;encoder&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ObjectEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            pipeline<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token string">&quot; decoder&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ObjectDecoder</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">.</span>MAX_VALUE<span class="token punctuation">,</span> <span class="token class-name">ClassResolvers</span><span class="token punctuation">.</span><span class="token function">cacheDisabled</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            pipeline<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">NettyServerHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span><span class="token class-name">ChannelOption</span><span class="token punctuation">.</span>SO_BACKLOG<span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">childOption</span><span class="token punctuation">(</span><span class="token class-name">ChannelOption</span><span class="token punctuation">.</span>SO_KEEPALIVE<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">ChannelFuture</span> f <span class="token operator">=</span> b<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token number">8000</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;服务端启动成功，端口号为:&quot;</span> <span class="token operator">+</span> <span class="token number">8000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            f<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">closeFuture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            workerGroup<span class="token punctuation">.</span><span class="token function">shutdownGracefully</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            bossGroup<span class="token punctuation">.</span><span class="token function">shutdownGracefully</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NettyServerHandler</span> <span class="token keyword">extends</span> <span class="token class-name">ChannelInboundHandlerAdapter</span> <span class="token punctuation">{</span>
    <span class="token class-name">RequestHandler</span> requestHandler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RequestHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handlerAdded</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">Channel</span> channel <span class="token operator">=</span> ctx<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;客户端信息： %s&quot;</span><span class="token punctuation">,</span> channel<span class="token punctuation">.</span><span class="token function">remoteAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">channelRead</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Object</span> msg<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">Channel</span> channel <span class="token operator">=</span> ctx<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> request <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> msg<span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;客户端发送的消息 %s : %s&quot;</span><span class="token punctuation">,</span> channel<span class="token punctuation">.</span><span class="token function">remoteAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> response <span class="token operator">=</span> requestHandler<span class="token punctuation">.</span><span class="token function">handle</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
        ctx<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
        ctx<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br></div></div><h3 id="netty解决tcp粘包的问题"><a href="#netty解决tcp粘包的问题" class="header-anchor">#</a> Netty解决TCP粘包的问题</h3> <p>粘包：是由于程序</p> <h2 id="cpu（重点关注）"><a href="#cpu（重点关注）" class="header-anchor">#</a> CPU（重点关注）</h2> <p><img src="/assets/img/cpu各项指标.63e910c9.jpg" alt=""></p> <table><thead><tr><th></th> <th>CPU使用率</th> <th>CPU Load</th></tr></thead> <tbody><tr><td>定义</td> <td>程序对CPU的时间片的占用情况</td> <td>计算机系统执行计算任务数量的度量</td></tr> <tr><td>含义</td> <td>代表CPU在某个时间CPU的被占用情况</td> <td>代表在单位时间内需要CPU去处理的任务数量</td></tr> <tr><td>查看方法</td> <td>top命令，可以按1查看每个CPU的工作情况</td> <td>top命令，显示的load average后面的3个参数</td></tr> <tr><td>各项性能指标参数的具体含义</td> <td>us，user：用户进程占用的CPU时间<br>sy，system：内核进程占用的CPU时间<br>ni，niced：运行已调整优先级用户进程占用CPU时间<br>id，idle time：空闲所占用CPU的时间<br>wa，IO wait：等待输入输出占用CPU的时间<br>hi，hardware interrupts：硬件中断占用CPU的时间<br>si，software interrupts：软件中断占用CPU的时间<br>st，steal time，被虚拟机占用的CPU的时间</td> <td>CPU在过去1分钟，5分钟，15分钟的平均Load</td></tr> <tr><td>备注</td> <td>默认显示的是所有cpu加起来的一个值，所以可能超过100%</td> <td>load average是基于内核数量决定的，简单理解为每个内核load之和，按照每个内核为1的负载来算，4个内核则对应的值为4，单个内核的性能指标最好不超过0.7</td></tr></tbody></table> <p>正常情况下，cpu率高，load也会比较高，但也有例外的情况，如：</p> <ul><li>load低，利用率高：如果CPU执行的任务数量少，则load会低，但是任务都是CPU密集型的，利用率就会高</li> <li>load高，利用率低：如果CPU执行的任务数量多，则load会高，但是任务执行过程中CPU经常空闲（比如等待IO），利用率就会低</li></ul> <h2 id="tcp-ip协议相关"><a href="#tcp-ip协议相关" class="header-anchor">#</a> TCP/IP协议相关</h2> <h3 id="从输入url到网页呈现，发生了什么事情"><a href="#从输入url到网页呈现，发生了什么事情" class="header-anchor">#</a> 从输入URL到网页呈现，发生了什么事情</h3> <ol><li>浏览器检查对应的缓存，如果有缓存且缓存仍可生效，跳转到9</li> <li>浏览器访问系统对应域名的地址</li> <li>系统首先检查本机内是否有缓存到对应的域名和IP地址的映射关系，若无，则发起一次DNS查询</li> <li>浏览器与服务器建立TCP连接（3次握手的流程）</li> <li>浏览器在TCP连接中发送对应的HTTP请求内容</li> <li>浏览器收到HTTP响应，若是短连接则直接关闭TCP，若是长连接则无需关闭，等待其他请求进行通道复用</li> <li>浏览器检查响应，判断是需要重定向（3xx），错误（4xx或者5xx）</li> <li>如果响应是可缓存的，则直接把响应缓存到本地缓存中</li> <li>浏览器对响应进行解码处理</li> <li>浏览器对响应结果进行渲染操作</li></ol></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/technology/database.html" class="prev">
        数据库
      </a></span> <span class="next"><a href="/technology/data_structure.html">
        数据结构
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.4bf8400b.js" defer></script><script src="/assets/js/2.7cac40fb.js" defer></script><script src="/assets/js/10.d232617a.js" defer></script>
  </body>
</html>
