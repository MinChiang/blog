<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>线程池 | MinChiang的博客</title>
    <meta name="generator" content="VuePress 1.5.2">
    <link rel="icon" href="/icon/favicon16.ico">
    <meta name="description" content="专业讨论技术网站">
    <link rel="preload" href="/assets/css/0.styles.a215708e.css" as="style"><link rel="preload" href="/assets/js/app.4bf8400b.js" as="script"><link rel="preload" href="/assets/js/2.7cac40fb.js" as="script"><link rel="preload" href="/assets/js/6.aef31d3b.js" as="script"><link rel="prefetch" href="/assets/js/10.d232617a.js"><link rel="prefetch" href="/assets/js/11.9b1f2054.js"><link rel="prefetch" href="/assets/js/12.f02da3d1.js"><link rel="prefetch" href="/assets/js/13.8dd2754d.js"><link rel="prefetch" href="/assets/js/14.264de891.js"><link rel="prefetch" href="/assets/js/15.d96e93b9.js"><link rel="prefetch" href="/assets/js/16.571a785a.js"><link rel="prefetch" href="/assets/js/17.a710ab29.js"><link rel="prefetch" href="/assets/js/18.7f2b67c6.js"><link rel="prefetch" href="/assets/js/19.fd14e980.js"><link rel="prefetch" href="/assets/js/20.e9b20029.js"><link rel="prefetch" href="/assets/js/21.6be25a42.js"><link rel="prefetch" href="/assets/js/22.cbdcd3af.js"><link rel="prefetch" href="/assets/js/23.51636cde.js"><link rel="prefetch" href="/assets/js/24.296a53db.js"><link rel="prefetch" href="/assets/js/25.85779d09.js"><link rel="prefetch" href="/assets/js/26.7ed22291.js"><link rel="prefetch" href="/assets/js/27.ca8ff020.js"><link rel="prefetch" href="/assets/js/28.fa34a8cf.js"><link rel="prefetch" href="/assets/js/29.03ce4139.js"><link rel="prefetch" href="/assets/js/3.cf6c9a20.js"><link rel="prefetch" href="/assets/js/30.9482ff4d.js"><link rel="prefetch" href="/assets/js/31.213917d0.js"><link rel="prefetch" href="/assets/js/32.feb8ee82.js"><link rel="prefetch" href="/assets/js/4.e459caa9.js"><link rel="prefetch" href="/assets/js/5.a2a3c506.js"><link rel="prefetch" href="/assets/js/7.12b76415.js"><link rel="prefetch" href="/assets/js/8.3434ed34.js"><link rel="prefetch" href="/assets/js/9.87c654bf.js">
    <link rel="stylesheet" href="/assets/css/0.styles.a215708e.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/images/logo.png" alt="MinChiang的博客" class="logo"> <span class="site-name can-hide">MinChiang的博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/technology/java_basis.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  技术
</a></div><div class="nav-item"><a href="/travel/shantou.html" class="nav-link">
  旅游
</a></div><div class="nav-item"><a href="/chat/develop_experience.html" class="nav-link">
  杂谈
</a></div><div class="nav-item"><a href="/entertainment/switch.html" class="nav-link">
  娱乐
</a></div><div class="nav-item"><a href="/about/now.html" class="nav-link">
  关于
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/technology/java_basis.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  技术
</a></div><div class="nav-item"><a href="/travel/shantou.html" class="nav-link">
  旅游
</a></div><div class="nav-item"><a href="/chat/develop_experience.html" class="nav-link">
  杂谈
</a></div><div class="nav-item"><a href="/entertainment/switch.html" class="nav-link">
  娱乐
</a></div><div class="nav-item"><a href="/about/now.html" class="nav-link">
  关于
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>技术</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/technology/java_basis.html" aria-current="page" class="active sidebar-link">Java基础</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/technology/java_basis.html#线程池" class="sidebar-link">线程池</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/technology/java_basis.html#常用的线程池" class="sidebar-link">常用的线程池</a></li><li class="sidebar-sub-header"><a href="/technology/java_basis.html#线程的6种状态" class="sidebar-link">线程的6种状态</a></li><li class="sidebar-sub-header"><a href="/technology/java_basis.html#线程池的高级用法" class="sidebar-link">线程池的高级用法</a></li></ul></li><li class="sidebar-sub-header"><a href="/technology/java_basis.html#线程" class="sidebar-link">线程</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/technology/java_basis.html#countdownlatch和cyclebarrier" class="sidebar-link">CountDownLatch和CycleBarrier</a></li></ul></li><li class="sidebar-sub-header"><a href="/technology/java_basis.html#线程的中断" class="sidebar-link">线程的中断</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/technology/java_basis.html#locksupport工具" class="sidebar-link">LockSupport工具</a></li></ul></li><li class="sidebar-sub-header"><a href="/technology/java_basis.html#序列化与反序列化" class="sidebar-link">序列化与反序列化</a></li><li class="sidebar-sub-header"><a href="/technology/java_basis.html#io与nio的区别与代码样例分析" class="sidebar-link">IO与NIO的区别与代码样例分析</a></li><li class="sidebar-sub-header"><a href="/technology/java_basis.html#基础" class="sidebar-link">基础</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/technology/java_basis.html#equals-、-、hashcode-和system-identityhashcode区别" class="sidebar-link">equals()、==、hashCode()和System.identityHashCode区别</a></li><li class="sidebar-sub-header"><a href="/technology/java_basis.html#string" class="sidebar-link">String</a></li></ul></li><li class="sidebar-sub-header"><a href="/technology/java_basis.html#锁" class="sidebar-link">锁</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/technology/java_basis.html#wait、notify和notifyall的使用" class="sidebar-link">wait、notify和notifyAll的使用</a></li><li class="sidebar-sub-header"><a href="/technology/java_basis.html#volatile关键字的作用" class="sidebar-link">volatile关键字的作用</a></li><li class="sidebar-sub-header"><a href="/technology/java_basis.html#lock、trylock和lockinterruptibly有什么区别" class="sidebar-link">Lock、tryLock和lockInterruptibly有什么区别</a></li><li class="sidebar-sub-header"><a href="/technology/java_basis.html#aqs的实现原理" class="sidebar-link">AQS的实现原理</a></li><li class="sidebar-sub-header"><a href="/technology/java_basis.html#数据结构部分" class="sidebar-link">数据结构部分</a></li><li class="sidebar-sub-header"><a href="/technology/java_basis.html#代码方法块详解" class="sidebar-link">代码方法块详解</a></li><li class="sidebar-sub-header"><a href="/technology/java_basis.html#释放执行权代码块" class="sidebar-link">释放执行权代码块</a></li><li class="sidebar-sub-header"><a href="/technology/java_basis.html#lock和synchronized区别" class="sidebar-link">Lock和Synchronized区别</a></li><li class="sidebar-sub-header"><a href="/technology/java_basis.html#互斥锁和自旋锁" class="sidebar-link">互斥锁和自旋锁</a></li><li class="sidebar-sub-header"><a href="/technology/java_basis.html#cas和对应的问题" class="sidebar-link">CAS和对应的问题</a></li><li class="sidebar-sub-header"><a href="/technology/java_basis.html#锁优化" class="sidebar-link">锁优化</a></li><li class="sidebar-sub-header"><a href="/technology/java_basis.html#死锁" class="sidebar-link">死锁</a></li><li class="sidebar-sub-header"><a href="/technology/java_basis.html#threadlocal" class="sidebar-link">ThreadLocal</a></li></ul></li><li class="sidebar-sub-header"><a href="/technology/java_basis.html#拷贝-克隆" class="sidebar-link">拷贝/克隆</a></li><li class="sidebar-sub-header"><a href="/technology/java_basis.html#代理" class="sidebar-link">代理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/technology/java_basis.html#静态代理" class="sidebar-link">静态代理</a></li><li class="sidebar-sub-header"><a href="/technology/java_basis.html#动态代理" class="sidebar-link">动态代理</a></li></ul></li><li class="sidebar-sub-header"><a href="/technology/java_basis.html#细节" class="sidebar-link">细节</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/technology/java_basis.html#map之间多个实现类以及衍生类的异同" class="sidebar-link">Map之间多个实现类以及衍生类的异同</a></li><li class="sidebar-sub-header"><a href="/technology/java_basis.html#list之间多个实现类以及衍生类的异同" class="sidebar-link">List之间多个实现类以及衍生类的异同</a></li><li class="sidebar-sub-header"><a href="/technology/java_basis.html#arraylist删除元素" class="sidebar-link">ArrayList删除元素</a></li></ul></li><li class="sidebar-sub-header"><a href="/technology/java_basis.html#fail-fast机制和fail-safe机制" class="sidebar-link">fail-fast机制和fail-safe机制</a></li><li class="sidebar-sub-header"><a href="/technology/java_basis.html#几个队列常用的api" class="sidebar-link">几个队列常用的API</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/technology/java_basis.html#stack" class="sidebar-link">Stack</a></li><li class="sidebar-sub-header"><a href="/technology/java_basis.html#queue" class="sidebar-link">Queue</a></li><li class="sidebar-sub-header"><a href="/technology/java_basis.html#deque" class="sidebar-link">Deque</a></li></ul></li><li class="sidebar-sub-header"><a href="/technology/java_basis.html#spi" class="sidebar-link">SPI</a></li><li class="sidebar-sub-header"><a href="/technology/java_basis.html#分布式事务" class="sidebar-link">分布式事务</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/technology/java_basis.html#基础理论" class="sidebar-link">基础理论</a></li><li class="sidebar-sub-header"><a href="/technology/java_basis.html#实现方式" class="sidebar-link">实现方式</a></li></ul></li><li class="sidebar-sub-header"><a href="/technology/java_basis.html#统一登录流程" class="sidebar-link">统一登录流程</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/technology/java_basis.html#cas登录流程" class="sidebar-link">CAS登录流程</a></li><li class="sidebar-sub-header"><a href="/technology/java_basis.html#oauth登录流程" class="sidebar-link">Oauth登录流程</a></li><li class="sidebar-sub-header"><a href="/technology/java_basis.html#授权码模式" class="sidebar-link">授权码模式</a></li><li class="sidebar-sub-header"><a href="/technology/java_basis.html#简化模式" class="sidebar-link">简化模式</a></li><li class="sidebar-sub-header"><a href="/technology/java_basis.html#密码模式" class="sidebar-link">密码模式</a></li><li class="sidebar-sub-header"><a href="/technology/java_basis.html#客户端模式" class="sidebar-link">客户端模式</a></li><li class="sidebar-sub-header"><a href="/technology/java_basis.html#_4种模式的区别" class="sidebar-link">4种模式的区别</a></li></ul></li><li class="sidebar-sub-header"><a href="/technology/java_basis.html#高可用和稳定性" class="sidebar-link">高可用和稳定性</a></li><li class="sidebar-sub-header"><a href="/technology/java_basis.html#缓存穿透、缓存击穿、缓存雪崩" class="sidebar-link">缓存穿透、缓存击穿、缓存雪崩</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/technology/java_basis.html#缓存穿透" class="sidebar-link">缓存穿透</a></li><li class="sidebar-sub-header"><a href="/technology/java_basis.html#缓存击穿" class="sidebar-link">缓存击穿</a></li><li class="sidebar-sub-header"><a href="/technology/java_basis.html#缓存雪崩" class="sidebar-link">缓存雪崩</a></li></ul></li></ul></li><li><a href="/technology/jvm.html" class="sidebar-link">JVM</a></li><li><a href="/technology/test.html" class="sidebar-link">测试</a></li><li><a href="/technology/frame_components.html" class="sidebar-link">框架组件</a></li><li><a href="/technology/database.html" class="sidebar-link">数据库</a></li><li><a href="/technology/computer.html" class="sidebar-link">计算机基础</a></li><li><a href="/technology/data_structure.html" class="sidebar-link">数据结构</a></li><li><a href="/technology/algorithm.html" class="sidebar-link">算法</a></li><li><a href="/technology/ddd.html" class="sidebar-link">领域驱动模型</a></li><li><a href="/technology/design_pattern.html" class="sidebar-link">设计模式</a></li><li><a href="/technology/vim.html" class="sidebar-link">vim</a></li><li><a href="/technology/business.html" class="sidebar-link">业务</a></li><li><a href="/technology/tools.html" class="sidebar-link">工具</a></li><li><a href="/technology/other.html" class="sidebar-link">其他</a></li><li><a href="/technology/python.html" class="sidebar-link">Python</a></li><li><a href="/technology/go.html" class="sidebar-link">Go</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="线程池"><a href="#线程池" class="header-anchor">#</a> 线程池</h2> <h3 id="常用的线程池"><a href="#常用的线程池" class="header-anchor">#</a> 常用的线程池</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">ExecutorService</span> <span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span><span class="token keyword">int</span> nThreads<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span>nThreads<span class="token punctuation">,</span> nThreads<span class="token punctuation">,</span>
                                  <span class="token number">0L</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">,</span>
                                  <span class="token keyword">new</span> <span class="token class-name">LinkedBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">ExecutorService</span> <span class="token function">newSingleThreadExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">FinalizableDelegatedExecutorService</span>
        <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>
                                <span class="token number">0L</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">,</span>
                                <span class="token keyword">new</span> <span class="token class-name">LinkedBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">ExecutorService</span> <span class="token function">newCachedThreadPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span>MAX_VALUE<span class="token punctuation">,</span>
                                  <span class="token number">60L</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">,</span>
                                  <span class="token keyword">new</span> <span class="token class-name">SynchronousQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>内部ThreadPoolExecutor的全量入参构造：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token keyword">int</span> corePoolSize<span class="token punctuation">,</span>
                          <span class="token keyword">int</span> maximumPoolSize<span class="token punctuation">,</span>
                          <span class="token keyword">long</span> keepAliveTime<span class="token punctuation">,</span>
                          <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">,</span>
                          <span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">&gt;</span></span> workQueue<span class="token punctuation">,</span>
                          <span class="token class-name">ThreadFactory</span> threadFactory<span class="token punctuation">,</span>
                          <span class="token class-name">RejectedExecutionHandler</span> handler<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><ul><li>corePoolSize：核心线程数；</li> <li>maximumPoolSize：最大线程数；</li> <li>keepAliveTime：超过corePoolSize时，多余部分的存活时间；</li> <li>unit：存活时间单位；</li> <li>workQueue：任务队列，保存提交但未执行的任务；</li> <li>threadFactory：线程工厂；</li> <li>handler：拒绝策略。</li></ul> <p>三种常见的线程池：</p> <table><thead><tr><th>方法名称</th> <th>使用的队列</th> <th>队列类型</th> <th>功能</th></tr></thead> <tbody><tr><td>FixedThreadPool</td> <td>LinkedBlockingQueue</td> <td>无界队列</td> <td>创建固定大小的线程池，corePoolSize和maximumPoolSize相等，使用无界队列LinkedBlockingQueue，过多的任务将会<strong>导致队列Runnable元素过多而造成内存溢出</strong></td></tr> <tr><td>SingleThreadExecutor</td> <td>LinkedBlockingQueue</td> <td>无界队列</td> <td>创建只有一个线程的线程池，corePoolSize和maximumPoolSize都为1</td></tr> <tr><td>CachedThreadPool</td> <td>SynchronousQueue</td> <td>直接提交队列</td> <td>创建一个没有容量的线程池，任何<strong>提交的任务都会立即执行</strong>（复用线程或者创建线程），corePoolSize为0，maximumPoolSize为无穷，容易<strong>创建线程过多导致内存溢出</strong></td></tr></tbody></table> <p>队列类型：</p> <ul><li><strong>直接提交队列</strong>：SynchronousQueue，没有容量，无缓冲等待队列，不存储元素，会将任务交给消费者，容易达到线程最大值和执行拒绝策略，没有存放元素的能力，针对每一个take操作都会阻塞到put的执行；</li> <li><strong>有界队列</strong>：ArrayBlockingQueue和有capality的LinkedBlockingQueue，能够容纳队列容量的峰值线程；</li> <li><strong>无界队列</strong>：无capality（即Integer.MAX_VALUE）的LinkedBlockingQueue，没有容量，永远不会执行拒绝策略，任务很多时会造成内存溢出。</li></ul> <p>内部源码实现：</p> <p><img src="/assets/img/线程池源码流程图.cd2e6f24.jpg" alt="线程池源码流程图"></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">submit</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> task<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>task <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">RunnableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> ftask <span class="token operator">=</span> <span class="token function">newTaskFor</span><span class="token punctuation">(</span>task<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">execute</span><span class="token punctuation">(</span>ftask<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> ftask<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> command<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>command <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> c <span class="token operator">=</span> ctl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//如果当前线程数量小于核心线程数</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">workerCountOf</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token operator">&lt;</span> corePoolSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//添加worker并执行对应的任务</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">addWorker</span><span class="token punctuation">(</span>command<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        c <span class="token operator">=</span> ctl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//把当前任务扔入队列中</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isRunning</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> workQueue<span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> recheck <span class="token operator">=</span> ctl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//如果当前threadpool不在运行中，删除对应的任务</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isRunning</span><span class="token punctuation">(</span>recheck<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">remove</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token comment">//执行拒绝策略</span>
            <span class="token function">reject</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">workerCountOf</span><span class="token punctuation">(</span>recheck<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token comment">//增加至少一个执行器</span>
            <span class="token function">addWorker</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//如果入队失败，则尝试新增执行器直接执行任务</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">addWorker</span><span class="token punctuation">(</span>command<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment">//添加执行器失败，执行拒绝策略</span>
        <span class="token function">reject</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">addWorker</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> firstTask<span class="token punctuation">,</span> <span class="token keyword">boolean</span> core<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    retry<span class="token operator">:</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> c <span class="token operator">=</span> ctl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> rs <span class="token operator">=</span> <span class="token function">runStateOf</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>rs <span class="token operator">&gt;=</span> SHUTDOWN <span class="token operator">&amp;&amp;</span>
            <span class="token operator">!</span> <span class="token punctuation">(</span>rs <span class="token operator">==</span> SHUTDOWN <span class="token operator">&amp;&amp;</span>
               firstTask <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span>
               <span class="token operator">!</span> workQueue<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> wc <span class="token operator">=</span> <span class="token function">workerCountOf</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>wc <span class="token operator">&gt;=</span> CAPACITY <span class="token operator">||</span>
                wc <span class="token operator">&gt;=</span> <span class="token punctuation">(</span>core <span class="token operator">?</span> corePoolSize <span class="token operator">:</span> maximumPoolSize<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">compareAndIncrementWorkerCount</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">break</span> retry<span class="token punctuation">;</span>
            c <span class="token operator">=</span> ctl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">runStateOf</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token operator">!=</span> rs<span class="token punctuation">)</span>
                <span class="token keyword">continue</span> retry<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">boolean</span> workerStarted <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">boolean</span> workerAdded <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token class-name">Worker</span> w <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">//新建执行器</span>
        w <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Worker</span><span class="token punctuation">(</span>firstTask<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token class-name">Thread</span> t <span class="token operator">=</span> w<span class="token punctuation">.</span>thread<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>t <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> <span class="token class-name">ReentrantLock</span> mainLock <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mainLock<span class="token punctuation">;</span>
            mainLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token keyword">int</span> rs <span class="token operator">=</span> <span class="token function">runStateOf</span><span class="token punctuation">(</span>ctl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>rs <span class="token operator">&lt;</span> SHUTDOWN <span class="token operator">||</span>
                    <span class="token punctuation">(</span>rs <span class="token operator">==</span> SHUTDOWN <span class="token operator">&amp;&amp;</span> firstTask <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">isAlive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalThreadStateException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    workers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">int</span> s <span class="token operator">=</span> workers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">&gt;</span> largestPoolSize<span class="token punctuation">)</span>
                        largestPoolSize <span class="token operator">=</span> s<span class="token punctuation">;</span>
                    workerAdded <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                mainLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>workerAdded<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//执行器运行</span>
                t<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                workerStarted <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span> workerStarted<span class="token punctuation">)</span>
            <span class="token function">addWorkerFailed</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> workerStarted<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">Worker</span>
    <span class="token keyword">extends</span> <span class="token class-name">AbstractQueuedSynchronizer</span>
    <span class="token keyword">implements</span> <span class="token class-name">Runnable</span>
<span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token number">6138294804551838833L</span><span class="token punctuation">;</span>

    <span class="token keyword">final</span> <span class="token class-name">Thread</span> thread<span class="token punctuation">;</span>
    <span class="token class-name">Runnable</span> firstTask<span class="token punctuation">;</span>
    <span class="token keyword">volatile</span> <span class="token keyword">long</span> completedTasks<span class="token punctuation">;</span>

    <span class="token class-name">Worker</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> firstTask<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">setState</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>firstTask <span class="token operator">=</span> firstTask<span class="token punctuation">;</span>
        <span class="token comment">//在threadpool中的threadfactory中创建执行的线程</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>thread <span class="token operator">=</span> <span class="token function">getThreadFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newThread</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//本质上调用runWorker方法执行</span>
        <span class="token function">runWorker</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> <span class="token keyword">boolean</span> <span class="token function">isHeldExclusively</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> <span class="token keyword">boolean</span> <span class="token function">tryAcquire</span><span class="token punctuation">(</span><span class="token keyword">int</span> unused<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">compareAndSetState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">setExclusiveOwnerThread</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> <span class="token keyword">boolean</span> <span class="token function">tryRelease</span><span class="token punctuation">(</span><span class="token keyword">int</span> unused<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">setExclusiveOwnerThread</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span> <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token function">tryAcquire</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>      <span class="token punctuation">{</span> <span class="token function">release</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token function">isHeldExclusively</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token keyword">void</span> <span class="token function">interruptIfStarted</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Thread</span> t<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>t <span class="token operator">=</span> thread<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>t<span class="token punctuation">.</span><span class="token function">isInterrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                t<span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SecurityException</span> ignore<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">runWorker</span><span class="token punctuation">(</span><span class="token class-name">Worker</span> w<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Thread</span> wt <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Runnable</span> task <span class="token operator">=</span> w<span class="token punctuation">.</span>firstTask<span class="token punctuation">;</span>
    w<span class="token punctuation">.</span>firstTask <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    w<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">boolean</span> completedAbruptly <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">//注意此处循环调用getTask方法，按照getTask的结果判断下次是否需要继续执行</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>task <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token punctuation">(</span>task <span class="token operator">=</span> <span class="token function">getTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            w<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">runStateAtLeast</span><span class="token punctuation">(</span>ctl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> STOP<span class="token punctuation">)</span> <span class="token operator">||</span>
                 <span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">interrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
                  <span class="token function">runStateAtLeast</span><span class="token punctuation">(</span>ctl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> STOP<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
                <span class="token operator">!</span>wt<span class="token punctuation">.</span><span class="token function">isInterrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                wt<span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token function">beforeExecute</span><span class="token punctuation">(</span>wt<span class="token punctuation">,</span> task<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">Throwable</span> thrown <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    task<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RuntimeException</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    thrown <span class="token operator">=</span> x<span class="token punctuation">;</span> <span class="token keyword">throw</span> x<span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Error</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    thrown <span class="token operator">=</span> x<span class="token punctuation">;</span> <span class="token keyword">throw</span> x<span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    thrown <span class="token operator">=</span> x<span class="token punctuation">;</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                    <span class="token function">afterExecute</span><span class="token punctuation">(</span>task<span class="token punctuation">,</span> thrown<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                task <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                w<span class="token punctuation">.</span>completedTasks<span class="token operator">++</span><span class="token punctuation">;</span>
                w<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        completedAbruptly <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token function">processWorkerExit</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> completedAbruptly<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token class-name">Runnable</span> <span class="token function">getTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">boolean</span> timedOut <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    <span class="token comment">//进行CAS操作</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> c <span class="token operator">=</span> ctl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> rs <span class="token operator">=</span> <span class="token function">runStateOf</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>rs <span class="token operator">&gt;=</span> SHUTDOWN <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>rs <span class="token operator">&gt;=</span> STOP <span class="token operator">||</span> workQueue<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">decrementWorkerCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">int</span> wc <span class="token operator">=</span> <span class="token function">workerCountOf</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//判断是否需要跳出</span>
        <span class="token keyword">boolean</span> timed <span class="token operator">=</span> allowCoreThreadTimeOut <span class="token operator">||</span> wc <span class="token operator">&gt;</span> corePoolSize<span class="token punctuation">;</span>

        <span class="token comment">//如果当前线程数比核心线程数还大</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>wc <span class="token operator">&gt;</span> maximumPoolSize <span class="token operator">||</span> <span class="token punctuation">(</span>timed <span class="token operator">&amp;&amp;</span> timedOut<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>wc <span class="token operator">&gt;</span> <span class="token number">1</span> <span class="token operator">||</span> workQueue<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">compareAndDecrementWorkerCount</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">//此处控制worker是否需要继续存活，按照队列的超时获取功能或者阻塞功能实现</span>
            <span class="token class-name">Runnable</span> r <span class="token operator">=</span> timed <span class="token operator">?</span>
                workQueue<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span>keepAliveTime<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>NANOSECONDS<span class="token punctuation">)</span> <span class="token operator">:</span>
            workQueue<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> r<span class="token punctuation">;</span>
            timedOut <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> retry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            timedOut <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br></div></div><p>常用的提交方法：</p> <ul><li>execute：会抛出异常，抛出异常后线程线程直接死亡，不会存放到线程池中；</li> <li>submit：内部捕获异常，异常保存在成员变量中，在FutureTask.get阻塞获取时候把异常抛回来，抛出异常后线程仍然进入线程池。</li></ul> <p>拒绝策略：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">CallerRunsPolicy</span> <span class="token keyword">implements</span> <span class="token class-name">RejectedExecutionHandler</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">rejectedExecution</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> r<span class="token punctuation">,</span> <span class="token class-name">ThreadPoolExecutor</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>e<span class="token punctuation">.</span><span class="token function">isShutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            r<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">AbortPolicy</span> <span class="token keyword">implements</span> <span class="token class-name">RejectedExecutionHandler</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">rejectedExecution</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> r<span class="token punctuation">,</span> <span class="token class-name">ThreadPoolExecutor</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RejectedExecutionException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">DiscardPolicy</span> <span class="token keyword">implements</span> <span class="token class-name">RejectedExecutionHandler</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">rejectedExecution</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> r<span class="token punctuation">,</span> <span class="token class-name">ThreadPoolExecutor</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">DiscardOldestPolicy</span> <span class="token keyword">implements</span> <span class="token class-name">RejectedExecutionHandler</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">rejectedExecution</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> r<span class="token punctuation">,</span> <span class="token class-name">ThreadPoolExecutor</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>e<span class="token punctuation">.</span><span class="token function">isShutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">getQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            e<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><ul><li>CallerRunsPolicy：直接在提交任务的线程中执行任务；</li> <li>AbortPolicy：直接报错处理；</li> <li>DiscardPolicy：静默处理；</li> <li>DiscardOldestPolicy：抛弃最旧（准备执行）的任务并且再次提交任务。</li></ul> <p>常用的计划任务线程池：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">ScheduledExecutorService</span> <span class="token function">newSingleThreadScheduledExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DelegatedScheduledExecutorService</span>
        <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ScheduledThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">ScheduledExecutorService</span> <span class="token function">newScheduledThreadPool</span><span class="token punctuation">(</span><span class="token keyword">int</span> corePoolSize<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ScheduledThreadPoolExecutor</span><span class="token punctuation">(</span>corePoolSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>常用的执行计划任务接口：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">ScheduledFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">scheduleAtFixedRate</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> command<span class="token punctuation">,</span>
                                              <span class="token keyword">long</span> initialDelay<span class="token punctuation">,</span>
                                              <span class="token keyword">long</span> period<span class="token punctuation">,</span>
                                              <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token class-name">ScheduledFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">scheduleWithFixedDelay</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> command<span class="token punctuation">,</span>
                                                 <span class="token keyword">long</span> initialDelay<span class="token punctuation">,</span>
                                                 <span class="token keyword">long</span> delay<span class="token punctuation">,</span>
                                                 <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><ul><li>scheduleAtFixedRate：以一定的速率执行，不管上一个任务有没有执行完毕；</li> <li>scheduleWithFixedDelay：以固定的延时执行，上一个任务执行完后x秒再执行。</li></ul> <h3 id="线程的6种状态"><a href="#线程的6种状态" class="header-anchor">#</a> 线程的6种状态</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Thread</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">enum</span> <span class="token class-name">State</span> <span class="token punctuation">{</span>
        <span class="token comment">//新建</span>
        NEW<span class="token punctuation">,</span>
        <span class="token comment">//就绪，可执行</span>
        RUNNABLE<span class="token punctuation">,</span>
        <span class="token comment">//阻塞</span>
        BLOCKED<span class="token punctuation">,</span>
        <span class="token comment">//等待（无时限）</span>
        WAITING<span class="token punctuation">,</span>
        <span class="token comment">//等待（有时限）</span>
        TIMED_WAITING<span class="token punctuation">,</span>
        <span class="token comment">//结束</span>
        TERMINATED<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p><img src="/assets/img/线程状态.de45e61b.png" alt="线程状态"></p> <p>RUNNABLE是指<strong>等待运行和运行中</strong>的集合状态：在Thread.start()执行后，线程就可以被CPU接纳执行；</p> <p>WAITING指无时限的等待，TIMED_WAITING指无时限的等待；</p> <p>yield()操作指CPU<strong>放弃对当前线程</strong>的执行权，重新让线程进行资源争夺；</p> <p>join()指当前线程等待某个线程执行完成才能继续执行；</p> <p>sleep()让指定时间内暂停执行，但<strong>不会释放锁</strong>；</p> <p>wait()在使用时需要对监视对象进行synchronized。</p> <h3 id="线程池的高级用法"><a href="#线程池的高级用法" class="header-anchor">#</a> 线程池的高级用法</h3> <h4 id="全局任务"><a href="#全局任务" class="header-anchor">#</a> 全局任务</h4> <p>如果有重要的任务，执行多次的效果是幂等的（执行1000次和执行1次的效果一样），那么建议用全局任务的方式创建线程</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span>
                <span class="token number">1</span><span class="token punctuation">,</span>
                <span class="token number">1</span><span class="token punctuation">,</span>
                <span class="token number">0L</span><span class="token punctuation">,</span>
                <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">LinkedBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                runnable <span class="token operator">-&gt;</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>runnable<span class="token punctuation">,</span> <span class="token string">&quot;whole-job-thread&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token punctuation">(</span>r<span class="token punctuation">,</span> executor<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;drop trigger event!, normally you can ignore this message~&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h4 id="组件线程的控制"><a href="#组件线程的控制" class="header-anchor">#</a> 组件线程的控制</h4> <p>往往很多组件都内置了自己的线程，此时业务无需多此一举再关心线程的控制，因为控制不好反而会发生OOM，例子：在kafka监听消息的入口，无需再开启新的线程控制，原因是kafka已经内置线程管理；若自己添加线程介入，可能kafka处理任务比业务线程快导致任务的积压。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ExecutorService</span> EXECUTOR_SERVICE <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span>
    <span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">availableProcessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">availableProcessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token number">0L</span><span class="token punctuation">,</span>
    <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">,</span>
    <span class="token comment">// 注意这里用无界队列吧</span>
    <span class="token keyword">new</span> <span class="token class-name">LinkedBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token class-name">ThreadFactory</span><span class="token punctuation">)</span> <span class="token class-name">Thread</span><span class="token operator">::</span><span class="token keyword">new</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 监听点击事件入口
 * 这里入口为纯写新的数据内容，可以不做更改
 *
 * @param records 记录
 */</span>
<span class="token annotation punctuation">@KafkaListener</span><span class="token punctuation">(</span>topics <span class="token operator">=</span> <span class="token string">&quot;${kafka.topic.click}&quot;</span><span class="token punctuation">,</span> containerFactory <span class="token operator">=</span> HIIDO_KAFKA_LISTENER_CONTAINER_FACTORY<span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">listenClick</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ConsumerRecord</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> records<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 这里开启线程</span>
    EXECUTOR_SERVICE<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ConsumerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">record</span> <span class="token operator">:</span> records<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token class-name">HiidoClickReq</span> hiidoClickReq <span class="token operator">=</span> OBJECT_MAPPER<span class="token punctuation">.</span><span class="token function">readValue</span><span class="token punctuation">(</span><span class="token keyword">record</span><span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">HiidoClickReq</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">HiidoClickDetailReq</span><span class="token punctuation">&gt;</span></span> hiidoClickDetailReqs <span class="token operator">=</span> <span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">ofNullable</span><span class="token punctuation">(</span>hiidoClickReq<span class="token punctuation">.</span><span class="token function">getDatas</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">orElse</span><span class="token punctuation">(</span><span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">emptyList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">HiidoClickDetailReq</span> hiidoClickDetailReq <span class="token operator">:</span> hiidoClickDetailReqs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>hiidoClickDetailReq<span class="token punctuation">.</span><span class="token function">getArgs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">continue</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> content <span class="token operator">=</span> <span class="token function">decodeArgs</span><span class="token punctuation">(</span>hiidoClickDetailReq<span class="token punctuation">.</span><span class="token function">getArgs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">Optional</span>
                            <span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>abstractClickParamConverter<span class="token operator">::</span><span class="token function">convert</span><span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>checker<span class="token operator">::</span><span class="token function">checkClick</span><span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">ifPresent</span><span class="token punctuation">(</span>clickService<span class="token operator">::</span><span class="token function">save</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;listen click event error: &quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br></div></div><p>正确应该是：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * 监听点击事件入口
 * 这里入口为纯写新的数据内容，可以不做更改
 *
 * @param records 记录
 */</span>
<span class="token annotation punctuation">@KafkaListener</span><span class="token punctuation">(</span>topics <span class="token operator">=</span> <span class="token string">&quot;${kafka.topic.click}&quot;</span><span class="token punctuation">,</span> containerFactory <span class="token operator">=</span> HIIDO_KAFKA_LISTENER_CONTAINER_FACTORY<span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">listenClick</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ConsumerRecord</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> records<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ConsumerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">record</span> <span class="token operator">:</span> records<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">HiidoClickReq</span> hiidoClickReq <span class="token operator">=</span> OBJECT_MAPPER<span class="token punctuation">.</span><span class="token function">readValue</span><span class="token punctuation">(</span><span class="token keyword">record</span><span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">HiidoClickReq</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">HiidoClickDetailReq</span><span class="token punctuation">&gt;</span></span> hiidoClickDetailReqs <span class="token operator">=</span> <span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">ofNullable</span><span class="token punctuation">(</span>hiidoClickReq<span class="token punctuation">.</span><span class="token function">getDatas</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">orElse</span><span class="token punctuation">(</span><span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">emptyList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">HiidoClickDetailReq</span> hiidoClickDetailReq <span class="token operator">:</span> hiidoClickDetailReqs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>hiidoClickDetailReq<span class="token punctuation">.</span><span class="token function">getArgs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> content <span class="token operator">=</span> <span class="token function">decodeArgs</span><span class="token punctuation">(</span>hiidoClickDetailReq<span class="token punctuation">.</span><span class="token function">getArgs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">Optional</span>
                        <span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>abstractClickParamConverter<span class="token operator">::</span><span class="token function">convert</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>checker<span class="token operator">::</span><span class="token function">checkClick</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">ifPresent</span><span class="token punctuation">(</span>clickService<span class="token operator">::</span><span class="token function">save</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;listen click event error: &quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><h2 id="线程"><a href="#线程" class="header-anchor">#</a> 线程</h2> <h3 id="countdownlatch和cyclebarrier"><a href="#countdownlatch和cyclebarrier" class="header-anchor">#</a> CountDownLatch和CycleBarrier</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token class-name">ExecutorService</span> executorService <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ThreadFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">private</span> <span class="token class-name">AtomicInteger</span> ai <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">Thread</span> <span class="token function">newThread</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> r<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> <span class="token string">&quot;线程&quot;</span> <span class="token operator">+</span> ai<span class="token punctuation">.</span><span class="token function">getAndIncrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">CountDownLatch</span> countDownLatch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CountDownLatch</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        executorService<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;正在执行中&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">3000L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                countDownLatch<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    countDownLatch<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;主线程执行完毕&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><div class="language- line-numbers-mode"><pre class="language-text"><code>线程0正在执行中
线程1正在执行中
线程2正在执行中
主线程执行完毕
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token class-name">ExecutorService</span> executorService <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newCachedThreadPool</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ThreadFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">private</span> <span class="token class-name">AtomicInteger</span> ai <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">Thread</span> <span class="token function">newThread</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> r<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> <span class="token string">&quot;线程&quot;</span> <span class="token operator">+</span> ai<span class="token punctuation">.</span><span class="token function">getAndIncrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">CyclicBarrier</span> cyclicBarrier <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CyclicBarrier</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">private</span> <span class="token class-name">AtomicInteger</span> ai <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;=====我现在是在&quot;</span> <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;执行=====&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;第&quot;</span> <span class="token operator">+</span> ai<span class="token punctuation">.</span><span class="token function">getAndIncrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;次开始&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        executorService<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;正在执行中&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                cyclicBarrier<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">3000L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;执行完毕&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> <span class="token operator">|</span> <span class="token class-name">BrokenBarrierException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><div class="language- line-numbers-mode"><pre class="language-text"><code>线程0正在执行中
线程1正在执行中
=====我现在是在线程1执行=====
第0次开始
线程2正在执行中
线程3正在执行中
=====我现在是在线程3执行=====
第1次开始
线程4正在执行中
线程2执行完毕
线程0执行完毕
线程1执行完毕
线程3执行完毕
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>CountDownLatch</p> <ul><li>主线程调用await方法睡眠，子线程调用countDown方法减少计数值，当计数值到达0，则自动唤醒主线程继续执行；</li> <li>不可以重复使用，仅使用一次</li> <li>本质上是使主线程继续执行</li></ul> <p>CycleBarrier</p> <ul><li>子线程调用await减少计数值，当计数值到达0，则触发对应的Runnable的动作</li> <li>可以重复使用</li> <li>本质上是在使计数变为0的线程中执行Runnable动作</li></ul> <h2 id="线程的中断"><a href="#线程的中断" class="header-anchor">#</a> 线程的中断</h2> <ul><li><p>interrupt()：通过运行的线程实例，<strong>给线程发送中段信号，仅仅设置线程的中断标志位，并没有额外的其余操作</strong>，至于<strong>如何处理中段响应</strong>需要看<strong>被中断的线程</strong>的实际处理逻辑</p> <ul><li>如果线程是正常运行中，且没有判断中段状态，那么线程就会一直执行</li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * 线程执行3秒后并没有停止运行
 */</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">runNoStop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token class-name">Thread</span> thread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;我还在运行中&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    thread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">3000L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    thread<span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><div class="language- line-numbers-mode"><pre class="language-text"><code>我还在运行中
我还在运行中
我还在运行中
我还在运行中
我还在运行中
我还在运行中
我还在运行中
我还在运行中
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><ul><li>如果线程被阻塞，那么线程会被抛出InterruptedException中段异常</li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * 响应InterruptedException中段异常
 */</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">runWithBlockAndStop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token class-name">Thread</span> thread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;我还在运行中&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2000L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;我被中断了&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    thread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">3000L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    thread<span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><div class="language- line-numbers-mode"><pre class="language-text"><code>我还在运行中
我还在运行中
我被中断了
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ul><li>如果线程是正常运行中，可以通过isInterrupted()判断自身的中段标记位</li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * 响应中段标记位，不清除中断标记位
 */</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">runWithCheckInterruptWithoutClear</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token class-name">Thread</span> thread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isInterrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;我被中段了&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;我还在运行中&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;当前线程中断标志位：&quot;</span> <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isInterrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    thread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">3000L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    thread<span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><div class="language- line-numbers-mode"><pre class="language-text"><code>我还在运行中：777445
我还在运行中：777446
我被中段了
我被中段了
我被中段了
我被中段了
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div></li> <li><p>isInterrupted()：查询线程的中断标记位，具体用法见安上文样例</p></li> <li><p>interrupted()：与isInterrupted()不同的是，这个方法是静态方法，调用后会<strong>查询并且清除中断标记位</strong></p></li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * 响应中段标记位，并且清除中断标记位
 */</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">runWithCheckInterruptAndClear</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token class-name">Thread</span> thread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">interrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;我被中段了&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;我还在运行中&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;当前线程中断标志位：&quot;</span> <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isInterrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    thread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    thread<span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><div class="language- line-numbers-mode"><pre class="language-text"><code>我还在运行中
我还在运行中
我还在运行中
我还在运行中
我还在运行中
我被中段了
当前线程中断标志位：false
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h3 id="locksupport工具"><a href="#locksupport工具" class="header-anchor">#</a> LockSupport工具</h3> <p>正常使用方法：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token class-name">Thread</span> thread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;---------- 被阻塞进程执行 ----------&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">LockSupport</span><span class="token punctuation">.</span><span class="token function">park</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;---------- 被阻塞进程结束 ----------&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    thread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2000L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">LockSupport</span><span class="token punctuation">.</span><span class="token function">unpark</span><span class="token punctuation">(</span>thread<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;释放了阻塞线程&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><div class="language- line-numbers-mode"><pre class="language-text"><code>---------- 被阻塞进程执行 ----------
释放了阻塞线程
---------- 被阻塞进程结束 ----------
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>对应的LockSupport内置一个<strong>许可</strong></p> <ul><li>许可在默认情况下<strong>没有许可</strong>，因此调用LockSupport.park()时默认会阻塞</li> <li>许可<strong>最多有一个</strong>，使用unpark()后给予线程一个许可，连续多次unpark()效果是一样的</li> <li>对于LockSupport.park()，它<strong>不会抛出InterruptedException</strong>，但是它也是<strong>响应中断</strong>的，若park时被中断，则会从LockSupport.park()下一行处继续执行，此时的中断标记位为true</li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token class-name">Thread</span> thread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">5000L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;---------- 被阻塞线程执行 ----------&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">LockSupport</span><span class="token punctuation">.</span><span class="token function">park</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;---------- 被阻塞线程结束 ----------&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    thread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">LockSupport</span><span class="token punctuation">.</span><span class="token function">unpark</span><span class="token punctuation">(</span>thread<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;释放了阻塞线程&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><div class="language- line-numbers-mode"><pre class="language-text"><code>释放了阻塞线程
---------- 被阻塞线程执行 ----------
---------- 被阻塞线程结束 ----------
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token class-name">Thread</span> thread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">5000L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;---------- 被阻塞线程执行 ----------&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">LockSupport</span><span class="token punctuation">.</span><span class="token function">park</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;第一次消费许可&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">LockSupport</span><span class="token punctuation">.</span><span class="token function">park</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;第二次消费许可&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;---------- 被阻塞线程结束 ----------&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    thread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">LockSupport</span><span class="token punctuation">.</span><span class="token function">unpark</span><span class="token punctuation">(</span>thread<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">LockSupport</span><span class="token punctuation">.</span><span class="token function">unpark</span><span class="token punctuation">(</span>thread<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;释放了阻塞线程&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><div class="language- line-numbers-mode"><pre class="language-text"><code>释放了阻塞线程
---------- 被阻塞线程执行 ----------
第一次消费许可
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token class-name">Thread</span> thread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;---------- 被阻塞进程执行 ----------&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">LockSupport</span><span class="token punctuation">.</span><span class="token function">park</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;被阻塞线程的中断标记位：&quot;</span> <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isInterrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;---------- 被阻塞进程结束 ----------&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    thread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2000L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    thread<span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;释放了阻塞线程&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><div class="language- line-numbers-mode"><pre class="language-text"><code>---------- 被阻塞进程执行 ----------
释放了阻塞线程
被阻塞线程的中断标记位：true
---------- 被阻塞进程结束 ----------
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h2 id="序列化与反序列化"><a href="#序列化与反序列化" class="header-anchor">#</a> 序列化与反序列化</h2> <ul><li>原生的JVM进行序列化和反序列化对象时需要实现Serializale接口，若被序列化的对象没有实现该接口，或者成员变量中含有引用类型但没实现该接口，则抛出NotSerializableException异常；</li> <li>Serializale本质上来说是个空接口，需要开发人员覆盖serialVersionUID字段，JVM在反序列化的时候校验这个字段是否一致；</li> <li>使用时机：想把一个对象保存在一个文件或者数据库中，或者想通过RMI传输对象的时候。</li></ul> <h2 id="io与nio的区别与代码样例分析"><a href="#io与nio的区别与代码样例分析" class="header-anchor">#</a> IO与NIO的区别与代码样例分析</h2> <table><thead><tr><th></th> <th>IO（传统的IO）</th> <th>NIO</th></tr></thead> <tbody><tr><td>面向对象</td> <td>面向流</td> <td>面向缓冲</td></tr> <tr><td>是否阻塞</td> <td>阻塞IO</td> <td>非阻塞IO</td></tr> <tr><td>实现方式</td> <td>数组</td> <td>Buffer</td></tr> <tr><td>客户端个数：IO线程数</td> <td>1:1</td> <td>M:1</td></tr></tbody></table> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestNIO</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">MultiplexerTimeServer</span> multiplexerTimeServer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MultiplexerTimeServer</span><span class="token punctuation">(</span><span class="token number">10222</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>multiplexerTimeServer<span class="token punctuation">,</span> <span class="token string">&quot;hahahahahah&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">MultiplexerTimeServer</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span>

        <span class="token keyword">private</span> <span class="token class-name">Selector</span> selector<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token class-name">ServerSocketChannel</span> serverSocketChannel<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">boolean</span> stop<span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token class-name">MultiplexerTimeServer</span><span class="token punctuation">(</span><span class="token keyword">int</span> port<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                selector <span class="token operator">=</span> <span class="token class-name">Selector</span><span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                serverSocketChannel <span class="token operator">=</span> <span class="token class-name">ServerSocketChannel</span><span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//设置为非阻塞式</span>
                serverSocketChannel<span class="token punctuation">.</span><span class="token function">configureBlocking</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                serverSocketChannel<span class="token punctuation">.</span><span class="token function">socket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InetSocketAddress</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//注册channel</span>
                serverSocketChannel<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>selector<span class="token punctuation">,</span> <span class="token class-name">SelectionKey</span><span class="token punctuation">.</span>OP_ACCEPT<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>stop <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>stop<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    selector<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SelectionKey</span><span class="token punctuation">&gt;</span></span> selectionKeys <span class="token operator">=</span> selector<span class="token punctuation">.</span><span class="token function">selectedKeys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SelectionKey</span><span class="token punctuation">&gt;</span></span> iterator <span class="token operator">=</span> selectionKeys<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">SelectionKey</span> key <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                    <span class="token keyword">while</span> <span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        key <span class="token operator">=</span> iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        iterator<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">try</span> <span class="token punctuation">{</span>
                            <span class="token function">handleInput</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                key<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token keyword">if</span> <span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                    key<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token punctuation">}</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>selector <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    selector<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">handleInput</span><span class="token punctuation">(</span><span class="token class-name">SelectionKey</span> key<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">isValid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">isAcceptable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">ServerSocketChannel</span> channel <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ServerSocketChannel</span><span class="token punctuation">)</span> key<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">SocketChannel</span> accept <span class="token operator">=</span> channel<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    accept<span class="token punctuation">.</span><span class="token function">configureBlocking</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    accept<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>selector<span class="token punctuation">,</span> <span class="token class-name">SelectionKey</span><span class="token punctuation">.</span>OP_READ<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">isReadable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">SocketChannel</span> channel <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">SocketChannel</span><span class="token punctuation">)</span> key<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">ByteBuffer</span> byteBuffer <span class="token operator">=</span> <span class="token class-name">ByteBuffer</span><span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">int</span> bytes <span class="token operator">=</span> channel<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>byteBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>bytes <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        byteBuffer<span class="token punctuation">.</span><span class="token function">flip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span>byteBuffer<span class="token punctuation">.</span><span class="token function">remaining</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                        byteBuffer<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>bs<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;收到报文为：&quot;</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>bs<span class="token punctuation">,</span> <span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span>UTF_8<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token function">doWrite</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> <span class="token string">&quot;我是相应报文&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>bytes <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        key<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        channel<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">doWrite</span><span class="token punctuation">(</span><span class="token class-name">SocketChannel</span> channel<span class="token punctuation">,</span> <span class="token class-name">String</span> response<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>response <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> response<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bytes <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">ByteBuffer</span> byteBuffer <span class="token operator">=</span> <span class="token class-name">ByteBuffer</span><span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span>bytes<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
                byteBuffer<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
                byteBuffer<span class="token punctuation">.</span><span class="token function">flip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                channel<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>byteBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br></div></div><h2 id="基础"><a href="#基础" class="header-anchor">#</a> 基础</h2> <h3 id="equals-、-、hashcode-和system-identityhashcode区别"><a href="#equals-、-、hashcode-和system-identityhashcode区别" class="header-anchor">#</a> equals()、==、hashCode()和System.identityHashCode区别</h3> <ul><li>equals比较的是程序员自定义的两个对象比较的方法，相不相等自己实现，约定重写equals必须重写hashcode；</li> <li>==比较的是两个对象的内存地址是否相等；</li> <li>hashCode可以通过重写自定义对象的哈希值计算方式，而System.identityHashCode则是判断两个对象原生的hashcode（和内存地址相关的计算方式），无论这个对象hashCode是否被重写，因此System.identityHashCode可以直接判断两个对象是否内存相等（例如判断String是否内存相等）。</li></ul> <h3 id="string"><a href="#string" class="header-anchor">#</a> String</h3> <h4 id="string、stringbuilder、stringbuffer的联系与区别"><a href="#string、stringbuilder、stringbuffer的联系与区别" class="header-anchor">#</a> String、StringBuilder、StringBuffer的联系与区别</h4> <ul><li>String天生是不可变的，因此是线程安全的；</li> <li>StringBuilder是可以变的，但线程不安全；</li> <li>StringBuffer是可以变的，线程安全。</li></ul> <h4 id="intern-方法以及各种string方式引用易错点"><a href="#intern-方法以及各种string方式引用易错点" class="header-anchor">#</a> intern()方法以及各种String方式引用易错点</h4> <p>Jdk1.6以前</p> <ul><li>如果常量池存在该字面量的字符串，返回这个常量池对象的引用；</li> <li>在常量池不存在，则<strong>创建与字面量一样的字符串，返回常量池（新建）对象的引用</strong>；</li></ul> <p>Jdk1.7及以后</p> <ul><li>如果常量池存在该字面量的字符串，返回这个常量池对象的引用（同1.6）；</li> <li>在常量池不存在，在常量池中<strong>记录首次出现的实例引用，并返回这个引用</strong>；</li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> s1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span><span class="token string">&quot;bc&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> s2 <span class="token operator">=</span> <span class="token string">&quot;abc&quot;</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> s3 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span><span class="token string">&quot;ab&quot;</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span><span class="token string">&quot;c&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;s1:&quot;</span> <span class="token operator">+</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">identityHashCode</span><span class="token punctuation">(</span>s1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;s1.intern():&quot;</span> <span class="token operator">+</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">identityHashCode</span><span class="token punctuation">(</span>s1<span class="token punctuation">.</span><span class="token function">intern</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;s2:&quot;</span> <span class="token operator">+</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">identityHashCode</span><span class="token punctuation">(</span>s2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;s3:&quot;</span> <span class="token operator">+</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">identityHashCode</span><span class="token punctuation">(</span>s3<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;s3.intern():&quot;</span> <span class="token operator">+</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">identityHashCode</span><span class="token punctuation">(</span>s3<span class="token punctuation">.</span><span class="token function">intern</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><div class="language- line-numbers-mode"><pre class="language-text"><code>s1:1956725890
s1.intern():356573597
s2:356573597
s3:1735600054
s3.intern():356573597
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ul><li>String s = &quot;test&quot;，直接使用字符串常量创建字符串，则在常量池中创建；</li> <li>String s = new String(&quot;test&quot;)，先在常量池中创建test字符串常量，并返回在堆上的new String(&quot;test&quot;)的实例引用；</li> <li>String s = &quot;te&quot; + &quot;st&quot;，在常量池中创建&quot;te&quot;、&quot;st&quot;和&quot;test&quot;，并返回&quot;test&quot;在常量池中的引用；</li> <li>String s = new String(&quot;te&quot;) + new String(&quot;st&quot;)，在常量池中创建&quot;te&quot;，&quot;st&quot;，并在堆上创建字面量为&quot;test&quot;的对象并返回堆上引用。</li></ul> <h4 id="为什么使用字符数组保存密码比使用string保存密码更好"><a href="#为什么使用字符数组保存密码比使用string保存密码更好" class="header-anchor">#</a> 为什么使用字符数组保存密码比使用String保存密码更好</h4> <ul><li>String在java中是不可变的，字符串放在常量池中，直到执行GC才会被清除，任何能够访问内存的人都能直接看到密码，非常不安全；</li> <li>使用字符串在进行文本输出时，会存在风险，能够直接打印出来，但是字符数组打印的是对应的内存数组。</li></ul> <h4 id="string如何实现对象不可变"><a href="#string如何实现对象不可变" class="header-anchor">#</a> String如何实现对象不可变</h4> <ul><li>String类使用final修饰，子类无法对该类进行方法的重写；</li> <li>内部的字符数组使用final修饰，本质上无法变更其指向；</li> <li>内部所有的方法均返回一个新的String对象实例。</li></ul> <h2 id="锁"><a href="#锁" class="header-anchor">#</a> 锁</h2> <h3 id="wait、notify和notifyall的使用"><a href="#wait、notify和notifyall的使用" class="header-anchor">#</a> wait、notify和notifyAll的使用</h3> <ul><li>使用前必须获取锁对象的监视器，即需要进行synchronized上锁；</li> <li>notify和notifyAll的区别是，notify去随机唤醒监视器队列中的一个等待线程，而notifyAll是唤醒全部线程，但是仍然需要进行等待处理（等待获取锁）。</li></ul> <h3 id="volatile关键字的作用"><a href="#volatile关键字的作用" class="header-anchor">#</a> volatile关键字的作用</h3> <ul><li>保证可见性：保证对所有的线程可见，标记volatile的字段，在<strong>写</strong>操作时，会强制<strong>刷新cpu缓存</strong>，标记volatile的字段，每次读取都是<strong>直接读内存</strong>；</li> <li>保证有序性：在volatile写操作前插入StoreStore屏障，在写操作后插入StoreLoad屏障；在volatile读操作前插入LoadLoad屏障，在读操作后插入LoadStore屏障，<strong>禁止了指令的重排</strong>。</li></ul> <h3 id="lock、trylock和lockinterruptibly有什么区别"><a href="#lock、trylock和lockinterruptibly有什么区别" class="header-anchor">#</a> Lock、tryLock和lockInterruptibly有什么区别</h3> <ul><li>lock：线程一直在等待锁，不然一直都会在block的状态，不响应interrupt中断；</li> <li>tryLock：马上返回，拿到锁就返回true，否则返回false；</li> <li>lockInterruptibly：<strong>响应interrupt中断</strong>，并要求处理InterruptExcetpion。</li></ul> <h3 id="aqs的实现原理"><a href="#aqs的实现原理" class="header-anchor">#</a> AQS的实现原理</h3> <h3 id="数据结构部分"><a href="#数据结构部分" class="header-anchor">#</a> 数据结构部分</h3> <p>AbstractQueuedSynchronizer的实现是<strong>CLH的变体</strong>，CLH本质上是一个不进行阻塞，后节点不断轮询前节点状态的虚拟队列；CLH适合用于低竞争，并发量少的场景，如果线程多，可能会导致CPU不断地空转，因此要解决这个问题就需要对线程状态进行控制，即不要让线程空轮询等待，而是让其进行挂起。
<img src="/assets/img/AQS-AQS数据结构.87052a20.jpg" alt="线程状态"></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractQueuedSynchronizer</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractOwnableSynchronizer</span> <span class="token keyword">implements</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span><span class="token class-name">Serializable</span> <span class="token punctuation">{</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">Node</span> <span class="token punctuation">{</span>
        <span class="token comment">/**
         * 共享模式初始值
         */</span>
        <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Node</span> SHARED <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">/**
         * 独占模式初始值
         */</span>
        <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Node</span> EXCLUSIVE <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

        <span class="token comment">/**
         * 当前等待的线程被取消
         */</span>
        <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> CANCELLED <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token comment">/**
         * 后继节点等待被唤醒
         */</span>
        <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> SIGNAL <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token comment">/**
         * 当前节点线程在等待condition中
         */</span>
        <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> CONDITION <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">;</span>
        <span class="token comment">/**
         * 需要被广播唤醒
         */</span>
        <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> PROPAGATE <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">;</span>

        <span class="token comment">/**
         * 节点的状态，表示上面的几个状态
         */</span>
        <span class="token keyword">volatile</span> <span class="token keyword">int</span> waitStatus<span class="token punctuation">;</span>
        <span class="token comment">/**
         * 当前节点的前驱节点
         */</span>
        <span class="token keyword">volatile</span> <span class="token class-name">Node</span> prev<span class="token punctuation">;</span>
        <span class="token comment">/**
         * 当前节点的后继节点
         */</span>
        <span class="token keyword">volatile</span> <span class="token class-name">Node</span> next<span class="token punctuation">;</span>
        <span class="token comment">/**
         * 保存的线程实例
         */</span>
        <span class="token keyword">volatile</span> <span class="token class-name">Thread</span> thread<span class="token punctuation">;</span>
        <span class="token comment">/**
         * 等待condition的节点，因为只有在独占的模式下才能使用condition
         * 因此这个值仅针对独占才有意义的，用一个特殊值来表示共享模式
         * 在独占模式下：初始为空
         * 在共享模式下：初始为SHARED
         */</span>
        <span class="token class-name">Node</span> nextWaiter<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * CLH的头节点
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">transient</span> <span class="token keyword">volatile</span> <span class="token class-name">Node</span> head<span class="token punctuation">;</span>
    <span class="token comment">/**
     * CLH的尾节点
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">transient</span> <span class="token keyword">volatile</span> <span class="token class-name">Node</span> tail<span class="token punctuation">;</span>
    <span class="token comment">/**
     * 当前的状态值
     * 针对于不同的实现有不同的意义逻辑
     * 简单而言通过这个state值的简单CAS控制着整个AQS的可用状态
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">int</span> state<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br></div></div><p>Node数据结构：</p> <ul><li>waitStatus：表示节点的状态
<ul><li>CANCELLED：当前节点等待的线程被取消</li> <li>SIGNAL：后继节点等待被唤醒</li> <li>CONDITION：当前节点线程在等待队列中</li> <li>PROPAGATE：当前节点线程等待被广播</li></ul></li> <li>prev：当前节点的前驱节点</li> <li>next：当前节点的后继节点</li> <li>thread：挂起的线程实例对象</li> <li>nextWaiter：等待condition的节点，仅在独占模式下才有用
<ul><li>SHARED：默认new了一个节点</li> <li>EXCLUSIVE：为空</li></ul></li></ul> <p>AbstractQueuedSynchronizer数据结构：</p> <ul><li>head：虚拟队列头节点</li> <li>tail：虚拟队列尾节点，一般用CAS进行修改</li> <li>state：当前获取锁的状态值，这个值对于不同的实现类的意义是不一样的，这个值是微观指令在宏观的表现；正常来说，判断一个资源是否有竞争，可以直接通过CAS进行修改state的状态，判断一下是否修改成功，如果成功意思说无竞争，程序可以继续执行；如果有竞争，则需要进入等待队列了</li></ul> <h3 id="代码方法块详解"><a href="#代码方法块详解" class="header-anchor">#</a> 代码方法块详解</h3> <h4 id="需要重写的代码部分"><a href="#需要重写的代码部分" class="header-anchor">#</a> 需要重写的代码部分</h4> <p>比较核心的方法是：</p> <ul><li>tryAcquire(int): boolean</li> <li>tryRelease(int): boolean</li> <li>tryAcquireShared(int): int</li> <li>tryReleaseShared(int): boolean</li> <li>isHeldExclusively(): boolean</li></ul> <p>上面的几个核心方式都是需要被子类覆盖使用的，不然都会抛出UnsupportedOperationException异常</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token comment">/**
     * 以独占模式尝试获取执行权
     *
     * @param arg 获取执行权参数
     * @return 是否获得执行权
     */</span>
    <span class="token keyword">protected</span> <span class="token keyword">boolean</span> <span class="token function">tryAcquire</span><span class="token punctuation">(</span><span class="token keyword">int</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnsupportedOperationException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 以独占模式尝试释放执行权
     *
     * @param arg 释放执行权参数
     * @return 是否完全被释放
     */</span>
    <span class="token keyword">protected</span> <span class="token keyword">boolean</span> <span class="token function">tryRelease</span><span class="token punctuation">(</span><span class="token keyword">int</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnsupportedOperationException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 以共享模式尝试获取执行权
     *
     * @param arg 获取执行权参数
     * @return 是否获得执行权
     */</span>
    <span class="token keyword">protected</span> <span class="token keyword">int</span> <span class="token function">tryAcquireShared</span><span class="token punctuation">(</span><span class="token keyword">int</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnsupportedOperationException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 以共享模式尝试释放执行权
     *
     * @param arg 释放执行权参数
     * @return 是否完全被释放
     */</span>
    <span class="token keyword">protected</span> <span class="token keyword">boolean</span> <span class="token function">tryReleaseShared</span><span class="token punctuation">(</span><span class="token keyword">int</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnsupportedOperationException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 是否被当前线程独占获取
     *
     * @return 是否被当前线程独占获取
     */</span>
    <span class="token keyword">protected</span> <span class="token keyword">boolean</span> <span class="token function">isHeldExclusively</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnsupportedOperationException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br></div></div><h4 id="获取执行权部分代码块"><a href="#获取执行权部分代码块" class="header-anchor">#</a> 获取执行权部分代码块</h4> <p>我认为，在AQS中，不应该引入“锁”这个观念，因为在锁这个概念一般是指ReentrantLock重入锁，而ReentrantLock又是以AQS进行实现的，总不能以具体的实现来理解高层次的抽象；因此我认为网文上指<strong>获取到锁</strong>是泛指的概念，应该理解为：<strong>获取到执行权</strong>更加精确</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token comment">/**
     * 获取执行权
     * 1. 进行快速尝试获取执行权
     * 2. 若快速尝试失败，则进入等待队列（相对于快速尝试，此方法属于兜底的方式）
     * 若获取不到则进行无限时等待（等待前面的有执行权的线程唤醒），不响应中断异常
     *
     * @param arg 执行权获取参数
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token keyword">int</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 开始快速尝试获取执行权</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">tryAcquire</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
                <span class="token function">acquireQueued</span><span class="token punctuation">(</span><span class="token function">addWaiter</span><span class="token punctuation">(</span><span class="token class-name">Node</span><span class="token punctuation">.</span>EXCLUSIVE<span class="token punctuation">)</span><span class="token punctuation">,</span> arg<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token comment">// 如果进入了等待队列，并且取消挂起后，若本线程被中断了，那么立刻调用一下中断的方法以响应中断</span>
            <span class="token function">selfInterrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 中断自身线程
     * 这里是在线程本身被中断过的时候触发
     */</span>
    <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">selfInterrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><ul><li>tryAcquire这个方法是需要用户进行重写的，可以理解为对执行权获取进行<strong>快速尝试</strong>，简单实现来说仅仅是对state状态进行CAS的一次操作</li> <li>如果上述的tryAcquire执行不成功，那么就要执行acquireQueued(addWaiter(Node.EXCLUSIVE), arg))；先执行addWaiter，其逻辑意义为：在等待队列中添加当前的线程节点，并且返回创建的节点；acquireQueued对新创建的节点进行同步等待获取执行权处理，其返回值代表在等待期间线程是否又被中断</li> <li>如果acquireQueued执行返回true，那么就需要对中断进行逻辑响应处理</li> <li>对应selfInterrupt这个方法只是简单地对当前执行线程的进行中断</li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token comment">/**
     * 创建新的节点并且将其设置为尾节点
     * 1. 创建新的节点
     * 2. 把对应的节点添加到CLH队列的末尾
     *
     * @param mode 创建节点的模式，独占/共享
     * @return 新创建的节点
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Node</span> <span class="token function">addWaiter</span><span class="token punctuation">(</span><span class="token class-name">Node</span> mode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 创建新的节点，并保存当前的线程实例对象</span>
        <span class="token class-name">Node</span> node <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mode<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// -------------start-------------</span>
        <span class="token comment">// 这段代码是可有可无的，这里选择快速尝试而已</span>
        <span class="token class-name">Node</span> pred <span class="token operator">=</span> tail<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pred <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 这里有个疑问是，如果compareAndSetTail执行失败不就导致设置错了么？</span>
            <span class="token comment">// 其实不会，因为如果compareAndSetTail执行失败，则会执行enq</span>
            <span class="token comment">// 在enq方法里面进行了对prev节点的重新设置</span>
            node<span class="token punctuation">.</span>prev <span class="token operator">=</span> pred<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">compareAndSetTail</span><span class="token punctuation">(</span>pred<span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                pred<span class="token punctuation">.</span>next <span class="token operator">=</span> node<span class="token punctuation">;</span>
                <span class="token keyword">return</span> node<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// -------------end-------------</span>
        <span class="token function">enq</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> node<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 入队操作
     * 1. 若CLH队列为空，则初始化
     * 2. 在虚拟队列中尾部添加新的节点
     *
     * @param node 需要入队的节点
     * @return 入队节点的前驱节点
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Node</span> <span class="token function">enq</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Node</span> node<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 自旋操作</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> <span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Node</span> t <span class="token operator">=</span> tail<span class="token punctuation">;</span>
            <span class="token comment">// 因为所有成员变量都是懒加载的，因此这里需要初始化</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>t <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 这里如果失败了，说明头已经不是空了，那么下一次的for循环操作就会进入else的代码块中</span>
                <span class="token comment">// 如果这里成功了，那么下次for循环也会引导进入下面的else代码块中</span>
                <span class="token comment">// 这里只是建立的一个虚拟的头节点（哨兵节点）</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">compareAndSetHead</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    tail <span class="token operator">=</span> head<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">// 这里很重要，在把当前节点设置为末尾节点之前，保证了当前节点的前置节点一定是尾节点</span>
                <span class="token comment">// 也就是说，当下面的compareAndSetTail执行成功前后，一定能够保证当前节点的prev指针指向前面的节点</span>
                <span class="token comment">// 这就是为什么在unparkSuccessor(Node)方法中要保证遍历是从后往前的，因为从后往前遍历是保证了准确性</span>
                node<span class="token punctuation">.</span>prev <span class="token operator">=</span> t<span class="token punctuation">;</span>
                <span class="token comment">// 入队操作，把当前的节点添加到队列的末尾中</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">compareAndSetTail</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// 由于这里和compareAndSetTail不是原子的，因此有可能compareAndSetTail成功了，但是前置节点指针还未指向尾节点（即为空）的尴尬情况</span>
                    <span class="token comment">// 也就是意味着，存在一种瞬时的状态，next节点指向空，但是此节点为非尾节点</span>
                    <span class="token comment">// 因此next节点是不可靠的，因此unparkSuccessor(Node)需要从后往前遍历，因为prev节点是可靠的</span>
                    t<span class="token punctuation">.</span>next <span class="token operator">=</span> node<span class="token punctuation">;</span>
                    <span class="token keyword">return</span> t<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br></div></div><ul><li><p>addWaiter先执行了快速入队处理，其实就是简单判断一下是否存在队尾节点，如果存在则进行快速入队</p></li> <li><p>enq中，这个方法是做了完整的入队流程，其实按照本质上来说流程和上述的快速入队差不多</p> <ul><li><p>首先for循环保证了里面的入队逻辑是必须执行成功的</p></li> <li><p>如果等待队列是空的，那么就要创建一个虚拟节点作为队头，注意不是把当前节点作为队头，而是新建的虚拟节点是队头；新建对头后，由于还在for循环中，那么会再次执行完整的逻辑入队处理</p></li> <li><p>如果存在了等待队列，则执行以下三个动作，注意这三个动作<strong>不是原子性</strong>的</p> <ul><li>先把当前节点的前驱节点指向之前的队尾</li> <li>进行CAS操作，把当前节点设置为队尾</li> <li>把之前队尾的next节点指向当前节点</li></ul> <p>由于这3条执行指令的顺序性，那么能够说明下面两个重要点：</p> <ul><li>在执行compareAndSetTail成功后，<strong>一定能够保证当前节点的前驱指针已经指向原来的队尾节点</strong></li> <li>在compareAndSetTail成功后，t.next = node执行前，可能存在一种中间状态：tail指针已经指向当前的节点，但是原来的队尾节点的next指针还未指向当前的节点</li></ul> <p>因此，如果需要<strong>遍历</strong>这个虚拟队列，最好从后往前遍历，因为队列中的prev指针是可靠的，而next指针是不可靠的</p></li></ul></li></ul> <p><img src="/assets/img/AQS-入队流程.9cf0a0e3.jpg" alt="AQS-入队流程"></p> <p><img src="/assets/img/AQS-竞争情况.bf9c5f5a.jpg" alt="AQS-竞争情况"></p> <p><img src="/assets/img/AQS-中间状态.47e3ec9d.jpg" alt=""></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token comment">/**
     * 进行同步等待处理
     * 1. 如果获取到执行权，那么线程继续执行
     * 2. 否则进入等待队列中，并且等待其先驱线程的唤醒
     *
     * @param node 新的节点
     * @param arg  获取的参数
     * @return 线程在等待时，是否有被中断
     */</span>
    <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">acquireQueued</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Node</span> node<span class="token punctuation">,</span> <span class="token keyword">int</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 执行是否失败</span>
        <span class="token keyword">boolean</span> failed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// 线程是否被中断过</span>
            <span class="token keyword">boolean</span> interrupted <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> <span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 获取当前节点的前驱节点</span>
                <span class="token keyword">final</span> <span class="token class-name">Node</span> p <span class="token operator">=</span> node<span class="token punctuation">.</span><span class="token function">predecessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 如果前驱节点是头节点，并且尝试获取到执行权</span>
                <span class="token comment">// 这里为什么还要判断一次tryAcquire呢？</span>
                <span class="token comment">// 是因为，第一个获得执行权的线程是可以不用进入等待队列的</span>
                <span class="token comment">// 因此这种情况还需要尝试获取一下执行权的</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">==</span> head <span class="token operator">&amp;&amp;</span> <span class="token function">tryAcquire</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// 把当前的节点设置成队列的头，此时线程已经获得了执行权</span>
                    <span class="token comment">// 是一定能够保证线程安全的</span>
                    <span class="token function">setHead</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// 因为前驱节点已经失去了作用，最好把前驱节点设置为游离状态</span>
                    <span class="token comment">// 这里帮助更快地进行GC操作</span>
                    p<span class="token punctuation">.</span>next <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                    failed <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> interrupted<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">// 如果前驱节点不是头或者没有获取到执行权，那么线程就需要被挂起了</span>
                <span class="token comment">// 这里是线程的 RUNNABLE -&gt; BLOCKED 状态的入口，也是 BLOCKED -&gt; RUNNABLE的出口</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">shouldParkAfterFailedAcquire</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> node<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
                        <span class="token function">parkAndCheckInterrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    interrupted <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>failed<span class="token punctuation">)</span>
                <span class="token comment">// 在这里的清理动作其实意义不大</span>
                <span class="token comment">// 其实我认为执行到这里，最有可能的情况是tryAcquire报错了</span>
                <span class="token comment">// 因为tryAcquire是由用户进行实现的，因此可能报出一些运行时异常也是可能的</span>
                <span class="token function">cancelAcquire</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 判断是否满足线程被挂起的条件
     * 这里的代码是会修改CLH队列的
     * &lt;p&gt;
     * 1. 查询前驱节点的状态，若为SIGNAL返回true
     * 2. 否则：
     * 2.1 若当前节点的前驱节点为CANCELLED，则找出第一个不为CANCELLED的节点作为当前节点的前驱节点
     * 2.2 若当前节点的前驱节点不为CANCELLED，则设置前驱节点的状态为SIGNAL
     * 并且返回false
     *
     * @param pred 前驱节点
     * @param node 需要判断的节点
     * @return 当前线程是否需要被阻塞挂起
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">shouldParkAfterFailedAcquire</span><span class="token punctuation">(</span><span class="token class-name">Node</span> pred<span class="token punctuation">,</span> <span class="token class-name">Node</span> node<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 获取并且判断前驱节点的状态</span>
        <span class="token keyword">int</span> ws <span class="token operator">=</span> pred<span class="token punctuation">.</span>waitStatus<span class="token punctuation">;</span>
        <span class="token comment">// 前驱节点为SIGNAL</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ws <span class="token operator">==</span> <span class="token class-name">Node</span><span class="token punctuation">.</span>SIGNAL<span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token comment">// 如果前驱节点为CANCELLED</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ws <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 目标是找到一个不为CANCELLED的前驱节点，并作为当前节点的前驱节点</span>
            <span class="token keyword">do</span> <span class="token punctuation">{</span>
                <span class="token comment">// 此时跳过前驱节点</span>
                node<span class="token punctuation">.</span>prev <span class="token operator">=</span> pred <span class="token operator">=</span> pred<span class="token punctuation">.</span>prev<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>pred<span class="token punctuation">.</span>waitStatus <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            pred<span class="token punctuation">.</span>next <span class="token operator">=</span> node<span class="token punctuation">;</span>
            <span class="token comment">// 执行到这里就要退出返回此方法了</span>
            <span class="token comment">// 为什么这里不返回true呢</span>
            <span class="token comment">// 是因为本方法是cas执行的，意思是外层有for循环，再次执行会执行else中的代码片段</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// 如果前驱节点不为CANCELLED</span>
            <span class="token comment">// 那么把前驱节点的状态设置为SIGNAL</span>
            <span class="token comment">// 这里尽管会出现竞争，但是总有一个线程会进行修改成功的</span>
            <span class="token function">compareAndSetWaitStatus</span><span class="token punctuation">(</span>pred<span class="token punctuation">,</span> ws<span class="token punctuation">,</span> <span class="token class-name">Node</span><span class="token punctuation">.</span>SIGNAL<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 外层有for循环，再次执行会执行ws == Node.SIGNAL并且返回true</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 挂起现在的线程，特点为：
     * 1. park是不会抛出中断异常的
     * 2. park是会相应对应的中断标记位的
     * 3. Thread.interrupted()这个方法是查找中断标记位并清除对应的中断状态
     * 4. 如果线程被挂起了，那么获得执行权时候会在park的下一句继续执行
     *
     * @return 线程是否有被中断
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">parkAndCheckInterrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">LockSupport</span><span class="token punctuation">.</span><span class="token function">park</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">interrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br></div></div><ul><li>acquireQueued：进入同步等待队列，其中主要逻辑主体为一个大自旋操作，自选逻辑为：
<ul><li>判断当前节点的前驱节点是否为头节点，如果是，则尝试获取执行权，如果成功，则把队列头节点改为本节点，否则执行shouldParkAfterFailedAcquire
<ul><li>为什么还需要执行tryAcquire方法获取执行权呢？</li> <li>是因为第一个进入的线程，是不用进入等待队列的，此时有可能出现一种情况，即第一个线程已经释放了资源，但是判断队尾没有等待队列，因此不做唤醒处理；后面又进来一个需要执行的线程，如果此时没有再进行tryAcquire，那么这个新线程是没办法执行的</li></ul></li> <li>shouldParkAfterFailedAcquire做了一些判断修改的动作，保证在挂起前前驱节点处于SIGNAL状态</li> <li>parkAndCheckInterrupt，把当前的线程直接挂起，LockSupport.park(this)是线程运行状态-&gt;等待状态的转换点；当线程被unpark时，出口执行的第一个代码行为Thread.interrupted()
<ul><li>在执行park的时候，是不会抛出中断异常的，但是会响应中断标志位</li> <li>在被unpark后，做的第一个事情是Thread.interrupted()，查询并清除对应的中断标记位</li></ul></li></ul></li></ul> <h3 id="释放执行权代码块"><a href="#释放执行权代码块" class="header-anchor">#</a> 释放执行权代码块</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token comment">/**
     * 释放资源
     * 这里做的事情：
     * 1. 释放占用资源（典型的就是操作state的值）
     * 2. 把CLH队列头的下一个节点中保存的线程拿出来unpark
     *
     * @param arg 释放资源参数
     * @return 资源是否完全被释放，注意不是本次释放成功！
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">release</span><span class="token punctuation">(</span><span class="token keyword">int</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 尝试进行释放资源</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">tryRelease</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 获取头节点</span>
            <span class="token class-name">Node</span> h <span class="token operator">=</span> head<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>h <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> h<span class="token punctuation">.</span>waitStatus <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token comment">// 取消阻塞当前头节点的后继节点中的线程</span>
                <span class="token function">unparkSuccessor</span><span class="token punctuation">(</span>h<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 解锁后继线程，这里做了
     * 1. 把当前节点的状态设置为0
     * 2. 找出本节点的最近的非CANCELLED节点，并且释放它
     *
     * @param node 当前节点
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">unparkSuccessor</span><span class="token punctuation">(</span><span class="token class-name">Node</span> node<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> ws <span class="token operator">=</span> node<span class="token punctuation">.</span>waitStatus<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ws <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token comment">// 把当前节点的状态设置为0，这里必定会有一个线程操作成功的，因此可以忽略返回值</span>
            <span class="token function">compareAndSetWaitStatus</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> ws<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Node</span> s <span class="token operator">=</span> node<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
        <span class="token comment">// 如果后继节点为空或者后继节点为取消状态</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> s<span class="token punctuation">.</span>waitStatus <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            s <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token comment">// 从后面往前面遍历节点，要求是：</span>
            <span class="token comment">// 1. 和当前的node节点不是同一节点</span>
            <span class="token comment">// 2. 当前的状态不是CANCELLED状态</span>
            <span class="token comment">// 这里出来的结果就是遍历出离node最近的一个可用节点</span>
            <span class="token comment">// 为什么要从后往前遍历呢？详情的原因看enq()的方法</span>
            <span class="token comment">// 如果从前往后遍历，会遇到一种情况是next指针为空而当前节点不是尾节点的情况</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Node</span> t <span class="token operator">=</span> tail<span class="token punctuation">;</span> t <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> t <span class="token operator">!=</span> node<span class="token punctuation">;</span> t <span class="token operator">=</span> t<span class="token punctuation">.</span>prev<span class="token punctuation">)</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>t<span class="token punctuation">.</span>waitStatus <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
                    s <span class="token operator">=</span> t<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token comment">// unpark对应的线程</span>
            <span class="token class-name">LockSupport</span><span class="token punctuation">.</span><span class="token function">unpark</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>thread<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br></div></div><ul><li>tryRelease，尝试释放执行权，简单而言就是对state状态的变更，由子类去覆盖</li> <li>unparkSuccessor具体唤醒在等待队列中的线程，在遍历时为什么要从后往前遍历呢？上文说过了prev指针是可靠的，在把一个节点设置成队尾前一定保证了prev节点指向原有的队尾，而next节点是不可靠的</li></ul> <h3 id="lock和synchronized区别"><a href="#lock和synchronized区别" class="header-anchor">#</a> Lock和Synchronized区别</h3> <p>共同点：</p> <ul><li>协调资源临界区；</li> <li>都是重入锁，同一个线程可以多次获取同一个锁；</li> <li>保证了可见性和互斥性；</li></ul> <p>不同点：</p> <ul><li>lock可以在申请锁时候<strong>限时等待</strong>，但synchronized不行；</li> <li>lock可以实现<strong>公平锁</strong>，但synchronized是<strong>非公平</strong>的；</li> <li>lock可以<strong>响应线程中断</strong>，但synchronized不行；</li> <li>lock是一个接口，synchronized是关键字，synchronized的实现原理是通过底层虚拟机以及内核实现的；</li> <li>synchronized会自动释放锁，lock手动释放；</li> <li>synchronized能锁住类、方法和代码块，但是lock只能锁范围<strong>代码块</strong>的；</li> <li>synchronized本质上调用底层mutex执行操作，需要使用monitorenter和monitorexit对代码块进行加锁，而lock是使用AQS实现的（AbstractQueuedSynchronizer）。</li></ul> <h3 id="互斥锁和自旋锁"><a href="#互斥锁和自旋锁" class="header-anchor">#</a> 互斥锁和自旋锁</h3> <p>自旋锁：自旋锁在执行单元在获取锁之前，如果发现有其他执行单元正在占用锁，则会不停的<strong>循环判断锁状态</strong>，直到锁被释放，期间并<strong>不会阻塞</strong>自己。所以自旋锁使用时，是非常<strong>消耗CPU</strong>资源的。</p> <p>互斥锁：会把自己<strong>阻塞并放入到队列</strong>中。当锁被释放时，会唤醒队列上执行单元把其放入就绪队列中，并由调度算法进行调度并执行。所以互斥锁使用时会有<strong>线程的上下文切换</strong>，这可能是非常耗时的一个操作，但是等待锁期间不会浪费CPU资源。</p> <ul><li>如果是<strong>多核</strong>CPU，上下文切换的时间开销比预计获取锁的等待时间要短，使用<strong>互斥锁</strong>更好；</li> <li>如果是<strong>多核</strong>CPU，上下文切换的时间开销比预计获取锁的等待时间要长，使用<strong>自旋锁</strong>更好；</li> <li>如果是<strong>单核</strong>CPU，使用<strong>互斥锁</strong>。</li></ul> <h3 id="cas和对应的问题"><a href="#cas和对应的问题" class="header-anchor">#</a> CAS和对应的问题</h3> <p>CAS操作需要3个变量：</p> <ul><li>需要读写的内存位置V</li> <li>预期值A</li> <li>新值B</li></ul> <p>CAS操作时，需要判断V位置的值与预期值A是否相等，如果不相等，则不更改V位置的值，后续进行重新读取，重新进行计算操作；如果相等，则把该位置的值改变为B。</p> <p>有以下缺点：</p> <ul><li>ABA问题：有一个栈，其结构为A-&gt;B，线程1从堆顶读取A，希望将堆顶替换为B，此时线程2介入，线程2也从表头读取到A，将A和B出栈，将D、C、A分别入栈，成为A-&gt;C-&gt;D这种结构，而B则是游离状态；而此时线程1执行CAS操作，发现堆顶仍然是A，则把B改为堆顶，此时会导致把C和D元素丢弃了；解决方案：使用AtomicStampedReference（带时间戳）或者AtomicMarkableReference（单纯带状态）进行处理；</li> <li>循环时间开销大：如果自旋CAS长时间不成功，会给CPU带来非常大的开销；</li> <li>只能保证一个共享的原子变量：当只有一个共享变量时，可以使用CAS进行原子操作，但对于多个变量操作时，循环CAS无法保证操作的原子性。</li></ul> <h3 id="锁优化"><a href="#锁优化" class="header-anchor">#</a> 锁优化</h3> <ul><li><p>自旋锁与自适应自旋：</p> <p>自旋锁：在JDK1.4时候引入，默认为关闭状态，JDK1.6时候默认开启。在获取锁的时候自旋，<strong>避免了线程切换之间的开销</strong>。缺点是如果锁被占用的时间很长，锁的自旋会白白<strong>浪费处理器资源</strong>。因此自旋锁有<strong>自旋次数的限制</strong>，默认为10次。</p> <p>自适应自旋：自旋的<strong>次数和时间不再固定</strong>，由前一次在同一个锁上的自旋时间以及锁的拥有者状态决定。如果在同一个对象，自旋等待刚刚成功获得过锁，虚拟机认为本次自旋很有可能再次成功，允许自旋等待更长时间。如果自旋很少成功获得，以后则可能减少自旋时间或者略过自旋。</p></li> <li><p>锁消除：</p> <p>对一些代码上要求同步，但被检测到<strong>不可能存在共享数据竞争</strong>的锁进行消除。</p></li> <li><p>锁粗化：</p> <p>对同一个对象反复加锁，甚至加锁操作在循环体中出现，会<strong>频繁互斥同步导致性能损耗</strong>。因此可以使锁的范围粗化，减少反复加锁的次数。</p></li> <li><p>重量级锁和轻量级锁：</p> <p>重量级锁：指的是传统意义上执行synchronized<strong>同步代码块</strong>时，加入字节码monitorenter和monitorexit指令来实现monitor的获取和释放，就是需要JVM通过字节码显式地去获取和释放monitor实现同步；使用synchronized<strong>同步方法</strong>时候，检查方法的ACC_SYNCHRONIZED标志是否被设置，如果设置了线程需要先去获取monitor。</p> <p><img src="/assets/img/重量级锁synchronized加锁流程.6886ac55.png" alt="重量级锁synchronized加锁流程"></p> <p>轻量级锁：为了在没有多线程竞争的前提下，<strong>减少传统重量级锁使用操作系统互斥量产生的性能消耗</strong>。在进入同步块时，虚拟机首先在当前线程栈帧中建立一个Lock Record空间，用于存储锁对象目前的Mark Word拷贝（官方把这份拷贝加了一个Displaced前缀，即Displaced Mark Word），并尝试使用CAS操作将锁对象的Mark Word更新为指向Lock Record的指针。如果更新成功，则当前线程拥有了对象的锁，并且将对象Mark Word的锁标志位改为00（轻量级锁）状态。如果更新失败了，检查锁对象Mark Word是否指向当前线程的栈帧，若是则说明已经拥有锁，同步代码块继续执行，若否则说明被抢占了。如果有两条以上的线程争用同一个锁，轻量级锁久不再有效，<strong>膨胀为重量级锁</strong>。</p></li> <li><p>偏向锁：</p> <p><img src="/assets/img/对象头MarkWord简述.bcca795c.png" alt="对象头MarkWord简述"></p></li></ul> <p>总结：</p> <table><thead><tr><th>锁类型</th> <th>面向的场景</th> <th>优点</th></tr></thead> <tbody><tr><td>偏向锁</td> <td><strong>只有一个</strong>线程进入临界区</td> <td>加锁解锁速度非常快，和执行非同步方法仅存在纳秒级的差距</td></tr> <tr><td>轻量级锁</td> <td>多个线程<strong>交替</strong>地进入临界区</td> <td>竞争的线程不会阻塞，提高了程序的响应速度</td></tr> <tr><td>重量级锁</td> <td><strong>多个线程</strong>同时进入临界区</td> <td>线程进行挂起，不会消耗CPU</td></tr></tbody></table> <h3 id="死锁"><a href="#死锁" class="header-anchor">#</a> 死锁</h3> <h4 id="死锁出现的条件"><a href="#死锁出现的条件" class="header-anchor">#</a> 死锁出现的条件</h4> <ul><li>互斥：对要求所分配的资源有排他性，即一段时间内某资源仅为一个进程所占有；</li> <li>不可剥夺：进程所获得的资源未使用完之前，不能被其他进程强行夺走，只能由获得该资源进程自己释放；</li> <li>请求与保持：进程已经保持了至少一个资源，但同时又提出了新的资源请求，而该资源已被其他进程占有，此时请求进程被阻塞，但对自己已获得的资源保持不放；</li> <li>循环等待：多个进程之间形成一种头尾相接的循环等待资源关系。</li></ul> <h4 id="如何处理死锁"><a href="#如何处理死锁" class="header-anchor">#</a> 如何处理死锁</h4> <ul><li>预防死锁：破环上述四个条件的一个即可；</li> <li>避免死锁：保证<strong>加锁的顺序</strong>，<strong>添加加锁的时限</strong></li> <li>死锁检测：允许系统中发生死锁，但可设置对应的死锁检测机制</li> <li>解除死锁：当检测到死锁后，采取适当措施将进程从死锁状态解脱出来</li></ul> <h3 id="threadlocal"><a href="#threadlocal" class="header-anchor">#</a> ThreadLocal</h3> <ul><li>在高并发时可以使用ThreadLocal为每个线程单独分配一个对象，把共享对象拆分到具体一个线程一个，以空间换取时间的做法；</li> <li>ThreadLocal可能导致内存泄漏，Thread中有一个类型为ThreadLocal.ThreadLocalMap成员变量threadLocals，而ThreadLocal.ThreadLocalMap内部是使用Entry结构类型存储数据的，Entry本质上继承了WeakReference类，<strong>在发生GC时候，若ThreadLocal没有被外部强引用，则会被回收，若使用了ThreadLocal进行set的线程一直运行（典型情况下在线程池中运行），那么这个Entry对象的key值变为null，导致value值可能一直不能回收</strong>，从而发生内存泄漏；使用ThreadLocal类的set方法后，<strong>显式调用remove方法</strong>可以有效规避内存泄漏的问题；</li> <li>参考文章：<a href="https://segmentfault.com/a/1190000022663697" target="_blank" rel="noopener noreferrer">面试官：小伙子，听说你看过ThreadLocal源码？（万字图文深度解析ThreadLocal）<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Thread</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span>

    <span class="token comment">//成员变量</span>
    <span class="token class-name">ThreadLocal</span><span class="token punctuation">.</span><span class="token class-name">ThreadLocalMap</span> threadLocals <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span> 

    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">ThreadLocalMap</span> <span class="token punctuation">{</span>

        <span class="token comment">//与HashMap中的结构与想法类似</span>
        <span class="token keyword">private</span> <span class="token class-name">Entry</span><span class="token punctuation">[</span><span class="token punctuation">]</span> table<span class="token punctuation">;</span>

        <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Entry</span> <span class="token keyword">extends</span> <span class="token class-name">WeakReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ThreadLocal</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
            <span class="token class-name">Object</span> value<span class="token punctuation">;</span>
            <span class="token class-name">Entry</span><span class="token punctuation">(</span><span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> k<span class="token punctuation">,</span> <span class="token class-name">Object</span> v<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">super</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">;</span>
                value <span class="token operator">=</span> v<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> key<span class="token punctuation">,</span> <span class="token class-name">Object</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

        <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">remove</span><span class="token punctuation">(</span><span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">T</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Thread</span> t <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ThreadLocalMap</span> map <span class="token operator">=</span> <span class="token function">getMap</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>map <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">ThreadLocalMap</span><span class="token punctuation">.</span><span class="token class-name">Entry</span> e <span class="token operator">=</span> map<span class="token punctuation">.</span><span class="token function">getEntry</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">&quot;unchecked&quot;</span><span class="token punctuation">)</span>
                <span class="token class-name">T</span> result <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span>e<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
                <span class="token keyword">return</span> result<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token function">setInitialValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">T</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Thread</span> t <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ThreadLocalMap</span> map <span class="token operator">=</span> <span class="token function">getMap</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>map <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            map<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span>
            <span class="token function">createMap</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br></div></div><h2 id="拷贝-克隆"><a href="#拷贝-克隆" class="header-anchor">#</a> 拷贝/克隆</h2> <ol><li>克隆类需要<strong>重写Object的clone()方法</strong>（显式提升clone的可见性）；</li> <li>克隆类需要<strong>实现java.lang.Clonable接口</strong>，如果没有实现改接口则会报出java.lang.CloneNotSupportedException异常；</li> <li>如果克隆类中含有非基本数据类型，需要注意区分浅拷贝与深拷贝的问题。</li></ol> <p>浅拷贝&amp;深拷贝：</p> <blockquote><p>在拷贝的过程中如果类中的属性不是基本数据类型，则拷贝后该属性指向原来被拷贝对象的属性，因此该属性的变动会间接影响另一个对象。</p></blockquote> <p>浅拷贝例子：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token keyword">implements</span> <span class="token class-name">Cloneable</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">Integer</span> age<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Address</span> address<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token class-name">Person</span> <span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">CloneNotSupportedException</span> <span class="token punctuation">{</span>
        <span class="token class-name">Person</span> other <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Person</span><span class="token punctuation">)</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> other<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Address</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> type<span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>执行：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestClone</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">CloneNotSupportedException</span> <span class="token punctuation">{</span>
        <span class="token class-name">Address</span> address <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Address</span><span class="token punctuation">(</span><span class="token string">&quot;广州&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;home&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Person</span> p1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token number">26</span><span class="token punctuation">,</span> <span class="token string">&quot;jm&quot;</span><span class="token punctuation">,</span> address<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Person</span> p2 <span class="token operator">=</span> p1<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>p1<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>p2<span class="token punctuation">)</span><span class="token punctuation">;</span>
        p2<span class="token punctuation">.</span><span class="token function">getAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setType</span><span class="token punctuation">(</span><span class="token string">&quot;office&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>p1<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>p2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>输出为：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Person</span><span class="token punctuation">{</span>age<span class="token operator">=</span><span class="token number">26</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'jm'</span><span class="token punctuation">,</span> address<span class="token operator">=</span><span class="token class-name">Address</span><span class="token punctuation">{</span>name<span class="token operator">=</span><span class="token string">'广州'</span><span class="token punctuation">,</span> type<span class="token operator">=</span><span class="token string">'home'</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token class-name">Person</span><span class="token punctuation">{</span>age<span class="token operator">=</span><span class="token number">26</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'jm'</span><span class="token punctuation">,</span> address<span class="token operator">=</span><span class="token class-name">Address</span><span class="token punctuation">{</span>name<span class="token operator">=</span><span class="token string">'广州'</span><span class="token punctuation">,</span> type<span class="token operator">=</span><span class="token string">'home'</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token class-name">Person</span><span class="token punctuation">{</span>age<span class="token operator">=</span><span class="token number">26</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'jm'</span><span class="token punctuation">,</span> address<span class="token operator">=</span><span class="token class-name">Address</span><span class="token punctuation">{</span>name<span class="token operator">=</span><span class="token string">'广州'</span><span class="token punctuation">,</span> type<span class="token operator">=</span><span class="token string">'office'</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token class-name">Person</span><span class="token punctuation">{</span>age<span class="token operator">=</span><span class="token number">26</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'jm'</span><span class="token punctuation">,</span> address<span class="token operator">=</span><span class="token class-name">Address</span><span class="token punctuation">{</span>name<span class="token operator">=</span><span class="token string">'广州'</span><span class="token punctuation">,</span> type<span class="token operator">=</span><span class="token string">'office'</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>深拷贝，上面的代码改为：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token keyword">implements</span> <span class="token class-name">Cloneable</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">Integer</span> age<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Address</span> address<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token class-name">Person</span> <span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">CloneNotSupportedException</span> <span class="token punctuation">{</span>
        <span class="token class-name">Person</span> other <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Person</span><span class="token punctuation">)</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Address</span> otherAddress <span class="token operator">=</span> <span class="token function">getAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> <span class="token function">getAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        other<span class="token punctuation">.</span><span class="token function">setAddress</span><span class="token punctuation">(</span>otherAddress<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> other<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Address</span> <span class="token keyword">implements</span> <span class="token class-name">Cloneable</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> type<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token class-name">Address</span> <span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">CloneNotSupportedException</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">Address</span><span class="token punctuation">)</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>输出为：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Person</span><span class="token punctuation">{</span>age<span class="token operator">=</span><span class="token number">26</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'jm'</span><span class="token punctuation">,</span> address<span class="token operator">=</span><span class="token class-name">Address</span><span class="token punctuation">{</span>name<span class="token operator">=</span><span class="token string">'广州'</span><span class="token punctuation">,</span> type<span class="token operator">=</span><span class="token string">'home'</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token class-name">Person</span><span class="token punctuation">{</span>age<span class="token operator">=</span><span class="token number">26</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'jm'</span><span class="token punctuation">,</span> address<span class="token operator">=</span><span class="token class-name">Address</span><span class="token punctuation">{</span>name<span class="token operator">=</span><span class="token string">'广州'</span><span class="token punctuation">,</span> type<span class="token operator">=</span><span class="token string">'home'</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token class-name">Person</span><span class="token punctuation">{</span>age<span class="token operator">=</span><span class="token number">26</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'jm'</span><span class="token punctuation">,</span> address<span class="token operator">=</span><span class="token class-name">Address</span><span class="token punctuation">{</span>name<span class="token operator">=</span><span class="token string">'广州'</span><span class="token punctuation">,</span> type<span class="token operator">=</span><span class="token string">'home'</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token class-name">Person</span><span class="token punctuation">{</span>age<span class="token operator">=</span><span class="token number">26</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'jm'</span><span class="token punctuation">,</span> address<span class="token operator">=</span><span class="token class-name">Address</span><span class="token punctuation">{</span>name<span class="token operator">=</span><span class="token string">'广州'</span><span class="token punctuation">,</span> type<span class="token operator">=</span><span class="token string">'office'</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h2 id="代理"><a href="#代理" class="header-anchor">#</a> 代理</h2> <h3 id="静态代理"><a href="#静态代理" class="header-anchor">#</a> 静态代理</h3> <blockquote><p>对于特定的类或者接口的某些方法进行无入侵式的扩充，可以不修改代理对象的前提下扩展被代理对象的功能，但被代理的范围仅限于某一种类的对象。</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IPerson</span> <span class="token punctuation">{</span>

    <span class="token class-name">String</span> <span class="token function">say</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Student</span> <span class="token keyword">implements</span> <span class="token class-name">IPerson</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">say</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;我是：&quot;</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PersonProxy</span> <span class="token keyword">implements</span> <span class="token class-name">IPerson</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">IPerson</span> target<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">PersonProxy</span><span class="token punctuation">(</span><span class="token class-name">IPerson</span> target<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>target <span class="token operator">=</span> target<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">PersonProxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">say</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;我准备发言了&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> say <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>target<span class="token punctuation">.</span><span class="token function">say</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;我发言完毕了&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> say<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Student</span> student <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token string">&quot;jm&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">IPerson</span> personProxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PersonProxy</span><span class="token punctuation">(</span>student<span class="token punctuation">)</span><span class="token punctuation">;</span>
        personProxy<span class="token punctuation">.</span><span class="token function">say</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br></div></div><p>输出：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>我准备发言了
我是：jm
我发言完毕了
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="动态代理"><a href="#动态代理" class="header-anchor">#</a> 动态代理</h3> <ul><li>动态代理是运行时动态生成的，编译完之后不生成字节码文件，而是运行时动态生成字节码文件并且自动加载到Jvm中使用的；</li> <li>如果有多个被代理类的增强实现都是一样的，例如：打印RPC调用的入参参数，其中由于RPC可以有多种调用方式（TCP、HTTP等），使用静态代理就需要创建很多代理类，略显繁琐，因此使用动态代理，可以把具体的增强业务逻辑放在InvocationHandler中，把产生的代理对象的逻辑放在Proxy中。</li></ul> <h4 id="jdk代理"><a href="#jdk代理" class="header-anchor">#</a> JDK代理</h4> <p>JDK动态代理的对象无需实现被代理的接口，但是要求目标代理对象<strong>必须实现接口</strong>。</p> <p>使用的类有：</p> <ul><li>java.lang.reflect.<strong>Proxy</strong>类：生成具体代理对象的类。</li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Object</span> <span class="token function">newProxyInstance</span><span class="token punctuation">(</span><span class="token class-name">ClassLoader</span> loader<span class="token punctuation">,</span>
                      <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> interfaces<span class="token punctuation">,</span>
                      <span class="token class-name">InvocationHandler</span> h<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ul><li>java.lang.reflect.<strong>InvocationHandler</strong>：需要实现此接口，其中在invoke方法中需要对被代理对象执行发放的具体拦截分发。</li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">Object</span> proxy<span class="token punctuation">,</span> <span class="token class-name">Method</span> method<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>代码样例：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PersonProxy</span> <span class="token keyword">implements</span> <span class="token class-name">IPerson</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">IPerson</span> target<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">PersonProxy</span><span class="token punctuation">(</span><span class="token class-name">IPerson</span> target<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>target <span class="token operator">=</span> target<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">PersonProxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">say</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;我准备发言了&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> say <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>target<span class="token punctuation">.</span><span class="token function">say</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;我发言完毕了&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> say<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">eat</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;我正在吃饭&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Student</span> student <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token string">&quot;jm&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">IPerson</span> personProxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PersonProxy</span><span class="token punctuation">(</span>student<span class="token punctuation">)</span><span class="token punctuation">;</span>
        personProxy<span class="token punctuation">.</span><span class="token function">say</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><h4 id="cglib代理"><a href="#cglib代理" class="header-anchor">#</a> CGLIB代理</h4> <ul><li>使用<strong>CGLIB可以代理无接口的类</strong>；</li> <li>本质上使用ASM工具，在ASM加载类之前，动态改变类的行为；</li> <li>比原生的JDK代理更加灵活，被代理类<strong>无需实现接口</strong>。</li></ul> <h2 id="细节"><a href="#细节" class="header-anchor">#</a> 细节</h2> <h3 id="map之间多个实现类以及衍生类的异同"><a href="#map之间多个实现类以及衍生类的异同" class="header-anchor">#</a> Map之间多个实现类以及衍生类的异同</h3> <p>HashMap重点：</p> <ul><li>实现方式：1.8后使用数组+链表+红黑树的方式实现，1.8前使用数组+链表实现；初始化容量capacity=(1&lt;&lt;4)=16，负载因子factor=0.75f，红黑树化阈值=8，红黑树退化阈值=6，最小红黑树容量=64，在map初始化时，对应的数组仍未初始化。1.8以前使用<strong>头插法</strong>对元素进行插入，插入的元素在链表的表头位置，原因时作者认为最新插入的元素查询的价值最高，因此更容易访问到，但头插法容易在hashmap进行<strong>并发使用resize时出现循环链表</strong>的现象。1.8后使用了<strong>尾插法</strong>，因为尾插法本质上不改变原有头部指针的指向，因此不会出现循环链表的现象。</li> <li>get操作：先对key进行hash操作，然后取出HashMap中数组长度 - 1 &amp; 对应计算出来的哈希值，原因是：HashMap数组的长度必须为2的幂次，因此对应-1的二进制数值全为1，&amp;上哈希值后其实就是取对应哈希值的后几位，此时比求余运算速度快得多，取出对应链表头节点后，如果是红黑树，则对应使用红黑树的遍历方式获取值（时间复杂度为O(logn)），如果是链表则使用遍历方式获取（时间复杂度为O(n)）。</li> <li>put操作：如果当前数组为空或者数组长度为0，则先对map进行resize处理。获取对应key的表头位置，生成对应node节点，遍历链表，如果找到对应替换位置则进行元素替换，如果到达链表末尾，则需要判断是否需要对链表进行红黑树化，最后进行resize操作。</li> <li>resize操作：每次resize都会把数组大小变成原来的2倍。重新计算元素下标位置时，元素要么保持在原来的下标位置，要么移动到原位置+旧数组长度位置。如果<strong>元素hash值&amp;旧数组长度大小为0</strong>，则保持原来位置，如果不为0则移动到2次幂位置，这是因为数组变成原来的2倍，可以理解为<strong>元素计算的下标比原来多1位，要么保持位置不变，要么移动到新的位置上</strong>。1.8后对resize进行优化，优化后resize不会改变链表元素的顺序。</li></ul> <p>HashMap和Hashtable的区别：</p> <ul><li>HashMap非线程安全的，而Hashtable是线程安全的；</li> <li>HashMap的的key和value都可以为空，而Hashtable都不能为空；</li> <li>计算数组index的流程不一样，HashMap为hash &amp; (table.length-1)，Hashtable为(e.hash &amp; 0x7FFFFFFF) % newCapacity；</li> <li>扩容不一样，HashMap扩容为原来的2倍，Hashtable扩容为2倍+1。</li></ul> <p>HashMap、LinkedHashMap、TreeMap的关系：</p> <ul><li>LinkedHashMap是HashMap的子类；</li> <li>LinkedHashMap维护一个双向链表，可以保证迭代的顺寻按照put的顺序；</li> <li>TreeMap维护一个红黑树，迭代时按照自然排序或者自定义排序（常用入参为Comparator）;</li> <li>HashMap和LinkedHashMap需要元素重写equals和hashcode方法，而TreeMap本质上是一个SortedMap，需要元素<strong>实现Comparable接口</strong>。</li></ul> <h3 id="list之间多个实现类以及衍生类的异同"><a href="#list之间多个实现类以及衍生类的异同" class="header-anchor">#</a> List之间多个实现类以及衍生类的异同</h3> <p>ArrayList、LinkedList、Vector、CopyOnWriteArrayList区别以及关系：</p> <ul><li>ArrayList基于数组实现，需要动态扩容（每次扩容到原来的1.5倍），根据index查找速度为O(1)，基于非后最元素的add或者delete速度很慢，适合固定大小以及常用遍历的场景；继承RandomAccess快速随机访问接口，用for循环迭代比使用iterator快；</li> <li>LinkedList基于链表实现，无须动态扩容，根据index遍历比较慢，但是add或者delete速度较快，适合查少改多的场景；</li> <li>Vector线程安全，但已经弃用，Vector可以使用Enumeration和Iterator进行元素遍历，ArrayList只提供了Iterator的方式；</li> <li>CopyOnWriteArrayList线程安全，是牺牲内存空间的前提下，保证了数据的最终一致性。在CopyOnWriteArrayList进行增删改时，先进行加锁，然后把原数组拷贝到一个副本内，拷贝完成时把原数组指向副本数组，再解锁。在读取时，直接遍历内部的数组即可，保证了<strong>最终一致性</strong>。而Vector在进行for循环遍历时，使用vector.size()获取长度遍历，仍然存在其他线程修改vector.size()属性，导致vector遍历出现ArrayIndexOutOfBoundsException。</li></ul> <h3 id="arraylist删除元素"><a href="#arraylist删除元素" class="header-anchor">#</a> ArrayList删除元素</h3> <ul><li>使用迭代器删除（iterator）</li> <li>赋值给新的list</li> <li>从后面的元素开始反向删除</li> <li>正序删除后修正下标值</li> <li>使用removeIf方法</li> <li>使用stream的filter进行元素过滤</li></ul> <h2 id="fail-fast机制和fail-safe机制"><a href="#fail-fast机制和fail-safe机制" class="header-anchor">#</a> fail-fast机制和fail-safe机制</h2> <ul><li>fail-fast（快速失败）：利用迭代器遍历集合时候，如果遍历过程中对内容进行修改，则会抛出ConcurrentModificationException。在遍历集合中的元素时，记录modCount变量，<strong>如果集合发生变化，就会修改modCount的值</strong>。遍历过程中（过程后）判断当前的modCount和遍历前modCount是否相等，如果是就返回遍历结果，否则抛出异常终止遍历；在java.util包下所有集合都是快速失败的，不能再多线程下并发修改。</li> <li>fail-safe（安全失败）：在遍历时复制原有集合内容，在拷贝的集合上进行遍历。在遍历期间集合发生修改，迭代器是<strong>无法感知</strong>的。在java.util.concurrent包下容器都是安全失败的。</li></ul> <table><thead><tr><th></th> <th>Fail Fast</th> <th>Fail Safe</th></tr></thead> <tbody><tr><td>抛出ConcurrentModificationException</td> <td>是</td> <td>否</td></tr> <tr><td>拷贝元素</td> <td>否</td> <td>是</td></tr> <tr><td>是否会导致内存溢出</td> <td>否</td> <td>是</td></tr> <tr><td>遍历时修改元素是否能被感知</td> <td>是（抛出异常）</td> <td>否</td></tr> <tr><td>用例</td> <td>HashMap，Vector，ArrayList，HashSet</td> <td>CopyOnWriteArrayList，ConcurrentHashMap</td></tr></tbody></table> <h2 id="几个队列常用的api"><a href="#几个队列常用的api" class="header-anchor">#</a> 几个队列常用的API</h2> <h3 id="stack"><a href="#stack" class="header-anchor">#</a> Stack</h3> <table><thead><tr><th>操作</th> <th>描述</th></tr></thead> <tbody><tr><td>E peek()</td> <td>弹出栈顶元素，但是不移除</td></tr> <tr><td>E pop()</td> <td>弹出栈顶元素，移除元素</td></tr> <tr><td>E push(E e)</td> <td>压入元素到栈顶</td></tr></tbody></table> <h3 id="queue"><a href="#queue" class="header-anchor">#</a> Queue</h3> <table><thead><tr><th>操作</th> <th>异常</th> <th>操作描述</th></tr></thead> <tbody><tr><td>boolean add(E e);</td> <td>是</td> <td>添加一个元素到队尾，如果队列已满则抛出IllegalStateException</td></tr> <tr><td>boolean offer(E e);</td> <td>否</td> <td>添加一个元素到队尾，并返回添加是否成功</td></tr> <tr><td>E remove();</td> <td>是</td> <td>取出队列中的头元素，如果队列为空则抛出NoSuchElementException</td></tr> <tr><td>E poll();</td> <td>否</td> <td>取出队列中的头元素，如果队列为空则返回null</td></tr> <tr><td>E element();</td> <td>是</td> <td>获取队列中的头元素，如果队列为空则抛出NoSuchElementException</td></tr> <tr><td>E peek();</td> <td>否</td> <td>获取队列中的头元素，如果队列为空则返回null</td></tr></tbody></table> <p>上述的方法均<strong>不阻塞</strong>，下面两个方法是摘自BlockingQueue的，下面两个方法均<strong>阻塞</strong>，因为是同步等待的，因此是不会抛出对应的异常的</p> <table><thead><tr><th>操作</th> <th>异常</th> <th>操作描述</th></tr></thead> <tbody><tr><td>void put(E e);</td> <td>否</td> <td>添加一个元素，如果队列为满则一直阻塞</td></tr> <tr><td>E take();</td> <td>否</td> <td>取出队列中的头元素，如果队列为空则一直阻塞</td></tr></tbody></table> <h3 id="deque"><a href="#deque" class="header-anchor">#</a> Deque</h3> <table><thead><tr><th>操作</th> <th>异常</th> <th>操作描述</th></tr></thead> <tbody><tr><td>boolean addFirst(E e);</td> <td>是</td> <td>添加一个元素到队头，如果队列已满则抛出IllegalStateException</td></tr> <tr><td>boolean offerFirst(E e);</td> <td>否</td> <td>添加一个元素到队头，并返回添加是否成功</td></tr> <tr><td>boolean addLast(E e);</td> <td>是</td> <td>添加一个元素到队尾，如果队列已满则抛出IllegalStateException</td></tr> <tr><td>boolean offerFirst(E e);</td> <td>否</td> <td>添加一个元素到队尾，并返回添加是否成功</td></tr> <tr><td>E removeFisrt();</td> <td>是</td> <td>取出队列中的头元素，如果队列为空则抛出NoSuchElementException</td></tr> <tr><td>E pollFirst();</td> <td>否</td> <td>取出队列中的头元素，如果队列为空则返回null</td></tr> <tr><td>E removeLast();</td> <td>是</td> <td>取出队列中的尾元素，如果队列为空则抛出NoSuchElementException</td></tr> <tr><td>E pollLast();</td> <td>否</td> <td>取出队列中的尾元素，如果队列为空则返回null</td></tr> <tr><td>E elementFirst();</td> <td>是</td> <td>获取队列中的头元素，如果队列为空则抛出NoSuchElementException</td></tr> <tr><td>E peekFirst();</td> <td>否</td> <td>获取队列中的头元素，如果队列为空则返回null</td></tr> <tr><td>E elementLast();</td> <td>是</td> <td>获取队列中的头元素，如果队列为空则抛出NoSuchElementException</td></tr> <tr><td>E peekLast();</td> <td>否</td> <td>获取队列中的头元素，如果队列为空则返回null</td></tr></tbody></table> <h2 id="spi"><a href="#spi" class="header-anchor">#</a> SPI</h2> <p>SPI全称为Service Provider Interface，通过本地方式加载第三方扩展的方式启用框架或代码实现的组件；</p> <p>常用在以下场景：</p> <ul><li>JDBC4后数据库驱动加载接口的实现</li> <li>日志门面接口实现类加载</li> <li>Spring：对servlet3.0规范的实现，自动类型转换</li></ul> <p>在com.spi包下，新建几个类：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Animal</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> <span class="token function">shout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Cat</span> <span class="token keyword">implements</span> <span class="token class-name">Animal</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">shout</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;喵&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Dog</span> <span class="token keyword">implements</span> <span class="token class-name">Animal</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">shout</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;汪&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Test</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ServiceLoader</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Animal</span><span class="token punctuation">&gt;</span></span> animals <span class="token operator">=</span> <span class="token class-name">ServiceLoader</span><span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token class-name">Animal</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Animal</span> animal <span class="token operator">:</span> animals<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>animal<span class="token punctuation">.</span><span class="token function">shout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>在resources文件夹下，新建META-INF\services\com.api.Animal文件，文件内容为：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>com.api.Cat
com.api.Dog
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h2 id="分布式事务"><a href="#分布式事务" class="header-anchor">#</a> 分布式事务</h2> <h3 id="基础理论"><a href="#基础理论" class="header-anchor">#</a> 基础理论</h3> <blockquote><p>CAP定理：任何一个系统都只能满足CAP中的任意两个方面</p> <p>C：consistency，一致性，A：Avaliability，可用性，P：Partition Tolerance，分区容错性</p></blockquote> <blockquote><p>BASE理论：保证核心功能可用，允许系统中存在中间状态，最终一致</p> <p>BA：Basically avaliable，基本可用，S：Soft state，软状态，E：Eventually consistent，最终一致性</p></blockquote> <h3 id="实现方式"><a href="#实现方式" class="header-anchor">#</a> 实现方式</h3> <h4 id="_2pc"><a href="#_2pc" class="header-anchor">#</a> 2PC</h4> <p>两个角色：<strong>协调者</strong>和<strong>调用者</strong>；</p> <p>两个阶段：询问和提交回滚阶段；</p> <p>需要实现：XA协议，包括Prepare、Commit和Rollback接口；</p> <p>缺点：</p> <ul><li>在询问阶段锁定资源，如果有一个参与者超时，则会<strong>同步阻塞</strong>所有微服务；</li> <li>对协调者的依赖很严重，如果协调者单点故障，则无法正常工作；</li> <li>会出现脑裂的情况，有些参与者收到并执行了事务，有些没有收到事务就没有执行。</li></ul> <h4 id="tcc"><a href="#tcc" class="header-anchor">#</a> TCC</h4> <p>Try、Confirm和Cancel单词的缩写，也是简化版的3段提交协议（把询问阶段和准备阶段合并在一起），本质上是把一个事务<strong>拆分成两个事务</strong>进行操作，也需要业务进行改造支持处理</p> <p>第一阶段：负责检查和锁定资源，需要做预操作处理，增加业务的“中间状态”；</p> <p>第二阶段：无需进行资源检查，把业务的“中间状态”转为最终状态，若事务失败，则调用回滚操作，把第一阶段的锁定资源释放掉（做一次数据库的反操作），如果第二阶段失败了，则<strong>不断重试</strong>。</p> <p>缺点：</p> <ul><li>业务入侵性强，改造成本高；</li> <li>需要实现Confirm和Cancel接口的幂等性，因为第二阶段可能存在不断重试的情况；</li></ul> <h4 id="本地事务表-消息队列"><a href="#本地事务表-消息队列" class="header-anchor">#</a> 本地事务表+消息队列</h4> <p>发送方增加一张消息表和一个轮询查表的线程，发送方不直接发送到消息队列，而是把具体业务和写消息表放在同一个事务中。轮询查表线程不断轮询，不断地捞取消息并把消息传给消息队列，经过消息队列ACK机制说明发送成功，没有经过ACK，则说明失败需要重传。服务提供方需要增加判重表，记录成功处理消息ID和消息中间件对应的offset（保证消息幂等），提供方宕机后定位到offset位置继续进行消费。</p> <p>缺点：</p> <ul><li>需要在接收方保证消息的幂等，因为有可能重复消费；</li> <li>需要在发送方增加无用的消息表和后台线程；</li> <li>增加了业务的耦合度。</li></ul> <h4 id="rocketmq事务消息"><a href="#rocketmq事务消息" class="header-anchor">#</a> RocketMQ事务消息</h4> <ol><li>消费方调用RocketMQ的prepare接口，预发送消息。此时消息保存在消息中间件里，但消息中间件不会把消息发送给消费方；</li> <li>消费方执行自己的业务逻辑（更新数据库）；</li> <li>消费方调用confirm接口，确认发送消息，此时消息中间件才会把消息推送给消费方进行消费；</li></ol> <p><strong>当步骤2或3失败时，RocketMQ会回调给发送方，询问消息是要发送还是要取消。</strong></p> <h2 id="统一登录流程"><a href="#统一登录流程" class="header-anchor">#</a> 统一登录流程</h2> <h3 id="cas登录流程"><a href="#cas登录流程" class="header-anchor">#</a> CAS登录流程</h3> <p><img src="/assets/img/CAS登录流程.06c033b4.jpg" alt="CAS登录流程"></p> <h3 id="oauth登录流程"><a href="#oauth登录流程" class="header-anchor">#</a> Oauth登录流程</h3> <p><img src="/assets/img/oauth认证流程.681fd8f7.png" alt="oauth认证流程"></p> <h3 id="授权码模式"><a href="#授权码模式" class="header-anchor">#</a> 授权码模式</h3> <p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAmgAAAHbAQMAAABFl/RMAAAACXBIWXMAAA7EAAAOxAGVKw4bAAAABlBMVEX///8AAABVwtN+AAAKE0lEQVR42u3dzW8bxxUA8DfLsThyXWqoGqiKquaQ1sE9Ve6ltK2Kswyhsjcn6LEH2Yf2WKktYgURpNVqYzGt4qrHAkJdoP0Hil59IC2gyqFwesyhKKgwgC9BQNeXNSAI3ZldfutjdzW2KWlGBiST8s+zOzOPb56WKwDddNNNN93eRsPdf7HOs1Z4/Nnzl6/2D1bFF0193nTTq/78z17VWsZSqRE+xJpZcxcfPh9LKtHG7Byp2N+nFUuFNorHEban2RZXoiVf1LDNWKaq5Lw5cFNoFBRpowq14jipPGS0ouS8Td5rNBc+dMeSln4F1NHyjWh1lRqiKjWDKNW+8eDJ5G8sVdro1NPcVYWabU6AQm2VqtN+ZvMh1RCt2Fmqbi18vHttWe8+dLTUmta0pjVd+dFNz95W0/Ve3XR7fW1eqbalT6huuul2ThvTmta0pjWtne1GlO6wKHClg6ByGK43VWomUavR4dWaQ9w3rFZTOabZIda+5apcp+TiVGku9isgUanN5q8AIAB3BAAnoF4N4+BurXvWFYmvMUNoiFaP+a9ZCA06mvjiVJpFJpPf3a0Duz35q8xGcq+6+OxkTdZ7XTZY77UIJptZ7zvnctMOQsAr7/lPoKA43K4Se1+E6BumZaHZJhOaiedPdaQ486nUVn1tn59Oo0Rq3NcghHbkfLOP1OLM3pI3CuUs9UYhyxzTGwXnNFp+NpPcXqiDe+fa4s7Gbq35QVPnvf2r/pQHwo7RLKJQQyf1N5JmeB9wdHnaiKgZUtuCFYB7Yq1RL2xC8k5zOeh6WE2uU9zSvGWVbWtGupXjWdG0S6itMX830aPxONpfIJtM/HUjvzCz4gXhakdj4bQxP5x6WvKlC89gljjza+VKkXpBmBlpLzeW8ZlG6xtZEye7BFO0zNbWsE29IOxpLOhbRG1MalMwlfmUraF9q09jEftm+1qOEk+DlkajjoI/32hRaBNHaVYMDf4EWVKaXwOnmMakwtpjiiKu0/yX4tMvYHFj/R/Pq0szqUxycgE1NpfjrCy1MeQ08e01xl5Laew971pqIapGAE/4wZ6M9GudDWAEjajTrvpaexvQo2XdIKcNrd17/Pvabr5+MFNIJT6p92o5UnlvNZLGnCu5bJk5RWLgOdqnoSCnDavlmEOm0hYjhvcx1adla0FOG1ablRoweu0Qjd0EHqNvnpY7TBuNqJmBxoqHaDniRNSyTjmXBVacIzYu9WqJnVZOG1Zr/Hlne3G36h7cSY6tP8qfjVWv817FeS/EzXutVgLpf3tBaKi17zYtWXOA1hawlTmgf5+k+TkSFTkSOME38D6tldUY04driPdpawMadGlBxtVd6uzRTHfxycqAVkjdqib++R33iag5oL09N1/ozgYxNLa/lu/I6NOKtPKUdvLejMx7HTN9mXsBgT8VNQdjnPKSCZlO3ptA9G8l+Y6MXs3Ipb3kdqBvnG0CeJqsOWBKuc178t6npFqS78jo1RJfpPd7NFNq+UIF0BeeJmoOGJr8IN+T9153rRurdEAzsnvQo8nc0hlhxOu2p4kqAUaUWyM9ee84WDf4oIbTKNC6M1UHeRpua4anoe4Zgo/Umo6dHtBMWgF8f6Jki5qDMT5dKprds3ckSyyaHdRSt8kHu6nOOi3Iqba0MjYLib9/dWtX1Bxqe5/nZ1a6V9al6ss6vbY8uBYMojKGoKaq+KbzXq1pTWta03nvuc17w9cGfS351K+kEpGLVoMKLbgwEq82WAw02qUh0upyxAotkdnLDWiVZOWnjhaxekxlZnVjp/Dt9UeLtf0lv94LC7cno9QGW3kvlXnvDZNMlIpbJnH8ei9U5nIi7/0fxOlbySS0fB04xX4VFGHbjFZp7NaWhZbzzvlMW1uNVgUNNKPdN6GV2hqPX6G1A407vjba0iJWj2UtGux3yFapCNzZlPVeRCtz2Wiz11+nSZlv7v54I9/4w9qL/fdlvRfqC3euxVhZ57XeC8GPu4nW3qKGuzUFr/XDqxUe15Ii5JLQ72s7/jqHi3Le9MoaDu3cxd4RpdqoniFDpN2xVGppGF7t8oXR8BBrZyr2xmrGUeeN4yN2drE0y5CPUiUaksNAIg7DkRqSWkaNZkiNZhVphmUJDavU+FBqmKvUklWlfRNlDsoVzTdxES8QU6mWU6PB9q/Fo5N0GGOI2vg2BHmvofQ1S2ta05rWzoA2zHlvQqmGrbf+mqW1oD1QquWGWLt6YTQyxNo5WllvKPZqLY6G+1+mz63W/VOzuj5vei1c4Ngbc4ZAyPmGQtVqJ0JqRqiXVnKyhv0HsBpNDhRekQ8xoPPeQ16+zsRRoSZc6f5n9GRNHirJtjTWpRn08C4fd97EzoEweQHR3fa1PfJTHI13tHcfrvwgOdlYd5v7+dSPLAz13+YjatfFBQ/MHnvehLs2na58xOw0YSQ9wTGim6WuQG2F0FinbxWbsq05sJinsS2OxZVX8Y/UFVoJLL7U1g5ijYLT7pvQKm3NiqbJGYKlhnCgrQVHOh5Z82evnG8IP0yzigNroxM5kqbcyNLNYjRNfm2siFWTePRhanE3k2i4X03OpvJ1VK2/P/PaYkhY7VTx7UzF3mHT+KBWjauhF9V5EZu7NcRgH2BHxjcRLVMP6m44zaD8MM2b+u+0NZw75MLIozQ4XOPt2Btew8Dr+f8WejUOxVTyJ6mF+pIfe6NorHSvr2/bsJwmNeOP1PFj7/V6BM02ezWjAmW2ZSa8sOZHpByPoB30a2UoF7ZMI/EKYmjWoFZi1DQM1NJYWI0eok3H1QzGWdEkVs8o/BCKtFIzEHFk7A0/pqjWdGcaG70r61/QGEv+8jOruSRjb2J3wj3jMUTHXq1pTWtau+Cx9yQt2n5hWknNoX9/f9T+FEc6s/SE/SlexX1PrbZrKYONhdufdj310/DHPljByLXqV5dPpxl9WnK9VnP3gaRGdz6pR9ZwQtQcZg3/DW5wmZRyuVEMJD2K5+hhb6k4WIUTdrudvqVpeWociTP5O3EbmVMeaYaS5Itq3dMejX1JY44Cw+2+EQzTE94jHxMcXZMzBLdnCNvyNPEnpsZ7tUopNy5HgTgxzpuc2cZqa3Yt7q7XGi9cmEx9b+dZ/k3EkNca385cY8c8Z0TW+DFRI/rZtbrGlQ0+GUPLB3cVq8M+JCx54YcfhK2IMwSJeF9q36OsCJjLB/2wGUNjYLfvUVb0bzLS0nhU7Zufe9p/xD3K9uqelsps79VeLQVB+DjtsJ+1IbzFwb4v7lE27m1yl9P4kheEnSAIR+6b1Ex55y5PKzNnRPwe+SAIx9Csltb0tIKDxe+RD4JwZO3S3ZaW9vpWYhhjuNkKm5Hn20fvQqCNt7XR2JqdBSjdF/coG5/2xpQ62OgE4cha0dPyPxf3KLv1uQuNsUwGNV4+8oPwregxxDh6lhrxwlIddNNNN92Oa/8H3N0c/M++uE8AAAAASUVORK5CYII=" alt="oauth2授权码模式"></p> <h3 id="简化模式"><a href="#简化模式" class="header-anchor">#</a> 简化模式</h3> <p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAm4AAAJbAQMAAABn0YpOAAAACXBIWXMAAA7EAAAOxAGVKw4bAAAABlBMVEX///8AAABVwtN+AAALFklEQVR42uzdT2/byBUA8CE1MccL1xo5PhiIVhrKBpLtoRDQQ9VNapMK6+rU9gP04OYDbGV4sXUBI6YkLsRtDVtxLz2kyBboJceilxwKrFy7q9z2ukV7YFYHXwpUaQ5VADfozFCyZP2xSWmyK9szMBCBgn8YcmYeH59HCgCyySabbLLJJttlakbXa3TFucjrkzfbK0++OH7FXshrJ5ts120ai+aUptjeOZPNxZPlhQ/yjbwYrpkirpt6hFwxXMUkOLeoTkNB3HYc51KqciKGc40I54AoDlQEco5Oh+KBghwxq+LzxIqmfWY3NuWNUYbPr5OLi+VSYjlTMPfBf0u7eXHc0u+sbEUgV8ktApHcT74SyH27klMnlkvFsJUSuCpimfoXtnxMkeFTcpKTnOQuZTSWTd4YvwFO1o1lk+1raVNiuWl5RWWTTbZr0lTJSU5ykpPc1Wu20KcxBUCxIyF0LNQVoRzERbFcYZK5pDLRJ2uK5bJC591Ec8qKM8ERRebGE87ZIrlI3a4CgEHUXgPASM/OBJOMLq579kHicyogjIudcv13KRiMAx2OvhiPQ6BQXf/LQ6BG/vD5y2b+YVyLexdzft24GO2rGyNgG+5fae/gg0VkYAzRx4S/cVpk7rywg/TONmGRcmhpjnN4dbyTtc0Tzt3+D+eSR+NywO+d6vcOBuGGzTtEhnCjTWNo2IZTjLGhmEMWGwprrFVRetH4VW0WREt/Oo5ntraS2hOZGw8KAaHu8RfPu7NT5PxIF5bD5/c4LEdYSBpa6DZCc4Rx00DzwNQCz+tpHAUbn2lV/m5wzl+zRotT6QrrcHorB8ShuZ/iU85/6gBdHBqNe4dy+fczG+VI7QUNy6ccDMz5AbZBORpgZ7yI566iedfRAQ3LQKf5Mwvdaujeuax384ZKozFawDkd0BdAn/NPOjzXZNwc5U6KCCefK2c4GL53xOd0QDmMWlxMCTsUftMh42L2YA6Pxk1XVOysIowsHRtu8XRkSVju5i47NrWmLWzeXd7SStUXjfUaSGRq1ZEWmeCIMla8e4vRGImNxteBOw7J0eVRoi9m2pG1h8uG5woCOdUGhXZ5aMDJZpNlP+8Nyu189+Vm5jierJV5oO7liPvx7UYIzsEFx3oPYtfkgbqPa+W9ATlo4QIspiGNXDx29XLxVt4bkNOOGEegGjkYyEVaMTFU7ygHB/cOVEJxaMnnIBrMEdcKx6U/gRaBKHfAA3UPd2+llfcG5OIbX27sZprJZG2NB+rLEwIuWzQWdidDYnNj1JUbg5FzY9SOXD632GBc61EdQJbPGunTX2onFe8H5UzEONTqNkRnuXbKszqUm+/lcB/X+aV2QlYcziXLt2peL3e/UX8M7v38yW8OWKUikUiWSo2udNGOb/z+kH9mpI/T0Y7OcmPEc2OzwXJjZMXwH2l0cGZSrFKh65DGJaWTG6+laNrMPzPSy6V0lgD39s5SURWoxPErFaYC0VJ3brxgLiB3cdDJLuvJ590c9E+21LRBgnK8UmFEYbRud50s3MY3ol8N4lIJjM5w/sg+oKsjxXrHSgtGjI7JWtdQqAa+gdRBnInPcHqLm6Nc9pTTKYe7JkpxOJdEOR33clYM2WBVd3IpVqnQF6G1hLum8ZGOVZgaxNU/LT/OdybKzSabZlrZe+WBu4nDx+usUpF4t1Tik6m9yJ4lttQI/8xI35olttCIkry+0VhykpOc5K4mJ3NjQZxycW4cprrIcw6yxbloFcyk2e8r7NyPH0bt0NVF/obhcI5mKrDDZXUVhC70Ip/DbY6fHX/rlAtThuaOCVqc92H+eFbbO7Trmx0uTJGcJFluDGhu/KSqHeAd/F4MZUEh5oDssgo09jc7IwzX3bviNMRpUskC+gJkl9SgTz1DTrb0GmKyUlHPciTsUJj+vINZhXIEt7jUCEMBO8nsMA6Fnsauz9GHF0ywmyWFGOyMLAy7yHCeH5tNNz7aaka1wqFX3wX31vfs0IvsbUSUSx2NJXcxp9ilzpE3ID02V+gc2e/sghh53hX8IoYQ7tafSy83wXxUK5VeNgGO3yzfqo7BTRO74IB57FrWHH3Ops/IO/79MsCeiiEcBClSybHAic15nCNj9g6CZYKj9UKVcvHk83G4dz71e4cRWEtTbg6j8TmTceynw40276Bhf0I5OhRLfChiKDcWd9/b2AX1Pa1UqzdAJn63/Dh/6UOAjMaXgauyKNzKm8RwpkCONkscpxxuAmtjT/u3V988EdA70wFb8xXXehRzRJysCYG1AFxrfxqK4rDmWr99LYozMCo7+4o4DjtQJBcrHz2ahikBE+XVLvC2Zp9/58tXu3FhaxYRoSHA3/4ko7HkZP1ueBstN5bXTi6yq5wbyz0V53D+nophdWNeXZz6Fz24YbO9DjMXcf6eimF1Y15dVHP0+up86wS8kOP7AobVjdHI3MC6MfS5/DOga9qx5314DufvqYDn1Y1Vn3OPtnXk6greCdq7wXVjn3sKi2AF5xT2rcgBucF1Y/9kn56wTbk/UiKvA3D+yJ5T6FWfAsYZB6pyIXd+3ZhPFCXmc3oQrjXvBteN+TRWsHME2FDE0IVDcbPBjw2pGxs+t/kMbJSjVa/xkawby6TiXA6F43jdmB5KVs/+Uuvf5czMkB29w7gCP9R+Juvhsigc5+9Rppw9hANhOF43zhyuALS77v3vJP6L5FnWRnHN3xcXvG5smQhEi/sxtJ9KO6CHg/6+uBCF3iLlUAlQziT9XGtfXEiuCF6i/e0BXGtfXPBCL+dUBTf2jUG9QyNxKrb7uWI4jteNrfvIply6ua8TxzjDWXQo/H1xwThWN878oAzi0cLfb/wjsX54dqJklpOavy8u9JpVoNgQ0JTR+LpwkYZQTkGTzWVWZtP/fOF5YriGZcbwD1MxLIYjRYNUVuEcEsS9yZCKBSNNMRy2pxinAlGcIpJDWToUR2pMzLWL7Nx7OBvdVrwGkDvcBJ8sUYU+VxiK0EqFzbokbofbnme3twYtNjvcu3SKnf0CjEBbg+izpt3elGR2/SlmsY9DwTjDON1WhfHpu2brSnQaDsHhXs6Ifr/2rcPu+0ygTV+KVjVOd7ixT3/4NWGQxr82p4gNOlViI0TvSG/vZsiOf1nD1aCGnaxKUA8X7GQhn3fdO9z8431csB1uDrB7drj5I9vHoRCc2ss9wK4yRdyw0xj8mK9Zvsj8T3/47WfRZe1v1XzoRXZORIFio/HsZYrGkpsYTv4VT147uSq+UU54w5KbDK77+9TQFecir0+w2P/74/pcO7nIJol7K9HYlpzkJCc5yV2hBv2v+RD1DaKI19cMRdhIYNCqGwvheDGx5NntG65ywr/1ZcRGGKew7x9uc0vBP50xgLuDOGeAO+I4RMf3TiKqafUGIJnbs9+zx+d07LpLGBBrKbZgjMpZbc4ySSVHH+xJ8Q6pjMxtcS5vgC2DJGsRm3KZldE5i40soiNrGQSD6hrllggelcNFNkEcyhUZx34EcXQocnwoUnjkk52usVl2/wAoNTpR9moeyGd+Gc14kxFRJrzJG6PkJCc5yV3BlhbL5YBsk9S0vFBOJZPMKcY14kQHKFsuFtkubzN6799XmIt0746Q10422a7dNJac5CQnuYm9MV67oYBCuWR8ij+UCeJ0+P9R2TgGahrnwMLH3Pv4A/WMY2JxE6Ci65g4VKhqHP8T6rqOhXrGOVLXOCVgVKgIdFDLOBl5/uZzFgWjpfFoaTxq3Khxo8aNGjcUS+NRMFoxDoBxo+PGo2AUjIJRQDIAABk2sKZoDPHaAAAAAElFTkSuQmCC" alt="oauth2简化模式"></p> <h3 id="密码模式"><a href="#密码模式" class="header-anchor">#</a> 密码模式</h3> <p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAmQAAAFGAQMAAAD+UxFfAAAACXBIWXMAAA7EAAAOxAGVKw4bAAAABlBMVEX///8AAABVwtN+AAAGz0lEQVR42u3bwW/TVhgA8PdeHvXLVCXP2TRlwiWOkwscpnIL0tTYUcbCCYnzDoU/oEq1S6dV5cVkxAfUhtsOSL3CbX8A0tJuIpzKjjtNCZ3UHSrNgLQFqZr2nDhOUsIaOxbLyPuEkJuSn5793vvs9z0DgAgRIkTMUuhDx+R91iKvT/6+nd99dvTKORDXTYSY9XMwekPWYCfUtlVnWVNSteRa2S6HonU01bK0+8QKRasbKi1lUBSHo91WaElD8CQUzdIjXQ2EpIF6eFo1zXvhFiTVUObCkwt5SfqB2RviDiiy5bvQlFA1LVTNCFdb++vOdjk0LftdsVAPT6uXMiBE7frz8LRL9RKaUU2TaVELby7IucNnTKw+RLYUmtCEJjQgKj8ixOh1Q9R7RYgQIWLyWGqEqRE2u9o5MC8ammFtfgIJLbg2tOmmhNC2wTaZFqpmhKF5m25eBXgKbbDp5lWAp9AGm25eBXgazdt08yrAU2iDTTevZjuV1t90C0MbbLp5FeAp5sJg082rAIv7wjsMFuYKCwIcaie8pRtoIA0hILXcH5bBJm8t4w1ugEBJCXMNUa89TtbsaYHahs/BcRqYRrO38mtNpf0zhAdKrHa+2W7YNB9Uk4lpZK1vtWUIbmiydS8NDEKD3CAwqYBIizA9W7+KKQSrhlovpYFOqB5Ei1f4GNko57L1oqPpt9Xdp1zboLlAbTO5Zi0uXHI1Xa0Trll0Ich4owWAIEGwp2FX49cNBtaSpiGTKlrmGT0tW6U0NZKBegHmfgMSOD7ZkqUU/AWs2xdizQfltn28ufWf5xDx3Cs0oQlNaOK5V4QIHyHqve+fJvKbCBHDe+I06FBH/wdt5D2HybSU+1KE93ZEfrcxd9dNhJj1PsebisLUdBiW5hwzcMbzkjqppvK/dho9LeWhcPRRkU6q8VOFWO0xxPsFUkef9SbVSFfTT2l4tK/xpBoe1oy9zvrdo7gE8Md/bOSOBl+dVEP53T2pYTjplMVNjVjmRWoxnLhWLV70Ui6cWBtqWxQnIDaX1brONX7g/Svo60zdinFUerGHTVVNNRztb9X/mXZ7gbp9WgWXHY0CnHiEmeq/F5zOqw606FiN+Bm9nlZIEOuuSi0dpWVcUP2PXuf4erv3g3Lz0C5/04lLDO59uP1Zx//MCj+HzNIdcH6eHCbXYGCtv68QARLPvEn+u0UgDb7LgMHHuLPNwlYn0NJee5ysSboaHNb06bThM4V6VwPdm9IkWlw6/PN4/WAJUKXd+H398ZYShxG7r139pPNY+Wo7fvij3cr9erZGrWyiZN3IAHpOSyetfYppxb1BcK1A9H3tI5MUVaYWb56prQALo2t41QB0ASd4auKZtIL7Z4o0optGEgHGNdM4U1OlWsS8hnWuYell9IRrUiXCXC3y3NEogrA1mUZY49ajnoZRFHCNVMDqSNu4hiZsG2VqoqcVXY1WQP+64URPQ3hCTbayMs+7GZ7RkZysmjKWB72AE8miqVGEs6uWWjxbK8eeNdt03V5iUgq2jr9uxlKxZrPlarErx1eaymZ85/D7cid3yOZx9TFXuZeEqa3kFoGfNwfc7y6N1wokkJZ5mwaCaMZ4jRFFOu/MGn+aHrty0G7m3tQwuZf23bZl+YNiIV0ao9GSf21RvYeLMhujpZ7611DeQrUXYFzbiH8NqgRV4RuaGUwzxmtF3gulNPWr3aIWRPIbWm4lJT0o+x4hX8ZXIDxqzGvlZz5rDmiSmoOf9Smo2GzkmTnVOPUWka/1KaKjWkI/9W0/61Ou9T5B7C2an/UpxO4nqNKyy1t5gCJm+XAjSHVFz+/uYdCrOSBTJpbzbIYLhlwFg+qu6mO167UNF/njLtMBIpoZxQHrSJ4m/YTgSTnHtcyd1zhwHckdb7iIIFhccNpWgDhgHWlQJchyzflzWvNTRwJmv8alyaTa64X0yHVDfmaWsefWHNZb9sbJFpAitfKr7SAzS9QcpjhTetbS3pem/tvLvsyvpg/9V0867rr41hSAI93lFtjqlnshA3m2GERjXNNcjYJ0r9zLQJbhYBrlz7QYeBoY0lS/2t1jrq2lavCJbXNNih+UWyePAZZw+4ntWzNLKjAuY4gyUULBCjHRfRnvA8xzQIYE09Qq5MttrmVpIeKsxAGmn/NPAmh6X9vgWmofRTotR/tCehlAe+hpFgV89c4TWtLRilVEfPdp4SFzNee69TQcWDN4KtcuYwNp0STvU1JAMOpopFpI+NfSXFM+jdT2msrxJliv7eywF6+bICbF2keK73nafXtZDSuH9OohM5F7RcxCzE3lR7znIGa9CBEiRHjxDxquJgiwQyZuAAAAAElFTkSuQmCC" alt="oauth2密码模式"></p> <h3 id="客户端模式"><a href="#客户端模式" class="header-anchor">#</a> 客户端模式</h3> <p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAlwAAACVAQMAAAC3qramAAAACXBIWXMAAA7EAAAOxAGVKw4bAAAABlBMVEX///8AAABVwtN+AAADU0lEQVRo3u3az0obQRgA8MlmavZQzFg8eBCdrAvNUeihCxWdDYvkMeIbKB7agtTJJtCUttYHkHrpA/QBeoimkKM99lS25OCtxHqJEEK/2T+JrLu6G7TVOp8iHzO7P2Z2ZuO3SxCSIUOGDBk3HniUZhKeQmNbbi+2sn90fHrWH2xD4iSyMt7Bw7NEcr+umQx5o9+5TSsxiUlMYv/wX92NTlO5eszJMYzI9WAiV+EHgsVSSkJMEZgKWOakWREujLUm2ibgD68E46fQg2cgrfhdkZiYJxGYQliAVcMY4i6mXoUhDtg0djF3xgr3MNcIDmMUTXtY0BWNMR/DiDnGjxWkvHty8gKSyWyr1YUW70zA1vbfHrQNZ7AEXe+daGzhrA/YfBMwaq3ByOqkWodEwTrl0ILmj467BDBaf6gVyrRegq5VEo1BI9G8kVHbhCtjkSqGRFEpYLbpHgaYRuuqPsUpdCiqTuKnuexjA8ByXwEbCCzjDDGY5rKLIUrmLsHEAmiqh/FgZFxgymhkLBgZYFo8JraGagqMeBgc6GN4hMHWMH2MluIxJcAUymjJVLmqL77BkNhYrzSoZQZX1izUy1oB0dIqdFkk9nbCnV3IDrq9pc5rNLv5fXMHknyt9Xm9Z3S4fzt1Prb2NtrN3uBZLl/bMf7Op8Y9+aS9XRi/Pizb4U0kPvnTYZlvURjcKeNgymIMhsbAMInCVFRtbnx5lRpDnb1fs5s8jHHWOEw9smyGfLK06YuYie3UGDpUm5Y5gy5i/TGwhR4vbpMIDI2BPUK8yC5gdCwMR2KYcVa3p9JiEwWVk0IYy9Z+dl+2J9NiD5qnDpnbkjXtvahpRaNf014SJCEGVZDa9zESvGFEldCZCTFRBZVCmB6eFkuGuQVyyW8pxmE8eek+wubyuVyni6jxePIpD13ZJA8VWahptzAUrqc9VCyQRkPUXpY+NcNyw7eyv1M8oQxHZpl0tww5tYt0l433hEJMv2WL0fl2lgNmrJzHkk7TXQDTX02LUYLgqYfaOiUs/QKIraEGmC0w8RvGWIpNO8RgAcruAmjk/DQTb1poxANvt2basDU+tB20bjzPG84Yt5OsaeXrG4lJTGLyPa2MOxryuwcxIb97IEOGDBn/RfwBi6oPsPZ9lP4AAAAASUVORK5CYII=" alt="oauth2客户端模式"></p> <h3 id="_4种模式的区别"><a href="#_4种模式的区别" class="header-anchor">#</a> 4种模式的区别</h3> <table><thead><tr><th>模式</th> <th>场景</th> <th>备注</th></tr></thead> <tbody><tr><td>授权码模式</td> <td>不信任的第三方机构组织使用</td> <td>非常安全但对接li联调的复杂度和成本很高，重要的流程是以code获取access_token的步骤（第三方后台自主获取token，不通过前端浏览器），签发access_token的同时可以签发fresh_token</td></tr> <tr><td>简化模式</td> <td>公司系统内部子系统使用</td> <td>本质上对接的流程都在前端浏览器完成，不可以签发fresh_token，在浏览器的local storage中保存对应的access_token</td></tr> <tr><td>密码模式</td> <td>高度信任的机构或内部系统使用，前提是保存不保存用户信息</td> <td>不安全，需要高度信任第三方机构组织，所以一般很少使用</td></tr> <tr><td>客户端模式</td> <td>不是以用户个人名义获取资源，而是以客户端自己的名义获取资源，开放权限的颗粒度比较高</td> <td>需要授予第三方账号比较高的权限</td></tr></tbody></table> <h2 id="高可用和稳定性"><a href="#高可用和稳定性" class="header-anchor">#</a> 高可用和稳定性</h2> <ul><li>隔离：
<ul><li>数据隔离：把重要数据，冷热数据和不用业务的数据隔离；</li> <li>机器隔离：按照服务调用者的重要程度以及性能等级排序；</li> <li>线程池隔离：为RPC调用单独准备一个线程池，使调用接口不会饱和堆积；</li></ul></li> <li>限流：
<ul><li>使用Nginx的limit_conn、<strong>limit_req</strong>模块，或者Guava的<strong>RateLimiter</strong>模块；</li> <li>秒杀系统中，有特定的库存数量，在Redis中为每一个库存设置对应的一个key，抢购时在Redis中消耗对应的key，然后进入消息队列进行异步的下单；</li> <li>限流算法：包括<strong>漏桶</strong>和<strong>令牌桶</strong>算法。漏桶算法是指流出的速率是恒定的，若超过容量则溢出处理。而令牌桶则是以固定速率产生令牌，每一个请求需要取到令牌才能继续处理，若处理不到则丢弃请求。重要区别，<strong>令牌桶能够响应突发的情况，限制的是平均流入率而不是瞬时速率</strong>，因为可能一段时间没有请求进入，令牌桶塞满令牌，然后短时间内突发流量过来，一瞬间消耗多个令牌。而漏桶则是起到了<strong>流量削峰的作用</strong>；</li></ul></li> <li>熔断：根据请求的失败率和请求时间判断服务是否可用；</li> <li>降级：保证系统核心功能仍然可用，而一些非核心非重要的功能可以以有损的方式提供服务。</li></ul> <h2 id="缓存穿透、缓存击穿、缓存雪崩"><a href="#缓存穿透、缓存击穿、缓存雪崩" class="header-anchor">#</a> 缓存穿透、缓存击穿、缓存雪崩</h2> <h3 id="缓存穿透"><a href="#缓存穿透" class="header-anchor">#</a> 缓存穿透</h3> <p>指用户访问缓存和数据库都没有的数据，导致负载都落在数据库中，导致压力过大</p> <ul><li>在接口维度增加参数校验，对参数进行合法性判断</li> <li>若从数据库读取不到数据，也将null值设置到缓存中，并设置过期时间</li> <li>使用布隆过滤器</li></ul> <h3 id="缓存击穿"><a href="#缓存击穿" class="header-anchor">#</a> 缓存击穿</h3> <p>指缓存中没有但数据库有的数据，由于并发量特别多，同时把压力落到数据库中</p> <ul><li>使用冷加载方式，先读取数据到缓存中</li> <li>增加互斥锁，平滑流量</li></ul> <h3 id="缓存雪崩"><a href="#缓存雪崩" class="header-anchor">#</a> 缓存雪崩</h3> <p>指缓存中大批量的数据到过期时间，查询数据巨大导致数据库压力过大</p> <ul><li>缓存数据过期时间预设随机值，防止同一时间大量数据过期现象发生</li></ul></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><!----> <span class="next"><a href="/technology/jvm.html">
        JVM
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.4bf8400b.js" defer></script><script src="/assets/js/2.7cac40fb.js" defer></script><script src="/assets/js/6.aef31d3b.js" defer></script>
  </body>
</html>
