<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Spring | MinChiang的博客</title>
    <meta name="generator" content="VuePress 1.5.2">
    <link rel="icon" href="/icon/favicon16.ico">
    <meta name="description" content="专业讨论技术网站">
    <link rel="preload" href="/assets/css/0.styles.a215708e.css" as="style"><link rel="preload" href="/assets/js/app.4bf8400b.js" as="script"><link rel="preload" href="/assets/js/2.7cac40fb.js" as="script"><link rel="preload" href="/assets/js/5.a2a3c506.js" as="script"><link rel="prefetch" href="/assets/js/10.d232617a.js"><link rel="prefetch" href="/assets/js/11.9b1f2054.js"><link rel="prefetch" href="/assets/js/12.f02da3d1.js"><link rel="prefetch" href="/assets/js/13.8dd2754d.js"><link rel="prefetch" href="/assets/js/14.264de891.js"><link rel="prefetch" href="/assets/js/15.d96e93b9.js"><link rel="prefetch" href="/assets/js/16.571a785a.js"><link rel="prefetch" href="/assets/js/17.a710ab29.js"><link rel="prefetch" href="/assets/js/18.7f2b67c6.js"><link rel="prefetch" href="/assets/js/19.fd14e980.js"><link rel="prefetch" href="/assets/js/20.e9b20029.js"><link rel="prefetch" href="/assets/js/21.6be25a42.js"><link rel="prefetch" href="/assets/js/22.cbdcd3af.js"><link rel="prefetch" href="/assets/js/23.51636cde.js"><link rel="prefetch" href="/assets/js/24.296a53db.js"><link rel="prefetch" href="/assets/js/25.85779d09.js"><link rel="prefetch" href="/assets/js/26.7ed22291.js"><link rel="prefetch" href="/assets/js/27.ca8ff020.js"><link rel="prefetch" href="/assets/js/28.fa34a8cf.js"><link rel="prefetch" href="/assets/js/29.03ce4139.js"><link rel="prefetch" href="/assets/js/3.cf6c9a20.js"><link rel="prefetch" href="/assets/js/30.9482ff4d.js"><link rel="prefetch" href="/assets/js/31.213917d0.js"><link rel="prefetch" href="/assets/js/32.feb8ee82.js"><link rel="prefetch" href="/assets/js/4.e459caa9.js"><link rel="prefetch" href="/assets/js/6.aef31d3b.js"><link rel="prefetch" href="/assets/js/7.12b76415.js"><link rel="prefetch" href="/assets/js/8.3434ed34.js"><link rel="prefetch" href="/assets/js/9.87c654bf.js">
    <link rel="stylesheet" href="/assets/css/0.styles.a215708e.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/images/logo.png" alt="MinChiang的博客" class="logo"> <span class="site-name can-hide">MinChiang的博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/technology/java_basis.html" class="nav-link">
  技术
</a></div><div class="nav-item"><a href="/travel/shantou.html" class="nav-link">
  旅游
</a></div><div class="nav-item"><a href="/chat/develop_experience.html" class="nav-link">
  杂谈
</a></div><div class="nav-item"><a href="/entertainment/switch.html" class="nav-link">
  娱乐
</a></div><div class="nav-item"><a href="/about/now.html" class="nav-link">
  关于
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/technology/java_basis.html" class="nav-link">
  技术
</a></div><div class="nav-item"><a href="/travel/shantou.html" class="nav-link">
  旅游
</a></div><div class="nav-item"><a href="/chat/develop_experience.html" class="nav-link">
  杂谈
</a></div><div class="nav-item"><a href="/entertainment/switch.html" class="nav-link">
  娱乐
</a></div><div class="nav-item"><a href="/about/now.html" class="nav-link">
  关于
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>技术</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/technology/java_basis.html" class="sidebar-link">Java基础</a></li><li><a href="/technology/jvm.html" class="sidebar-link">JVM</a></li><li><a href="/technology/test.html" class="sidebar-link">测试</a></li><li><a href="/technology/frame_components.html" aria-current="page" class="active sidebar-link">框架组件</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/technology/frame_components.html#spring" class="sidebar-link">Spring</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/technology/frame_components.html#spring主要包" class="sidebar-link">Spring主要包</a></li><li class="sidebar-sub-header"><a href="/technology/frame_components.html#spring的优点" class="sidebar-link">Spring的优点</a></li><li class="sidebar-sub-header"><a href="/technology/frame_components.html#di和ioc机制的理解" class="sidebar-link">DI和IOC机制的理解</a></li><li class="sidebar-sub-header"><a href="/technology/frame_components.html#aop的理解" class="sidebar-link">AOP的理解</a></li><li class="sidebar-sub-header"><a href="/technology/frame_components.html#orm的理解" class="sidebar-link">ORM的理解</a></li><li class="sidebar-sub-header"><a href="/technology/frame_components.html#spring如何解决循环依赖的问题" class="sidebar-link">Spring如何解决循环依赖的问题</a></li><li class="sidebar-sub-header"><a href="/technology/frame_components.html#springmvc" class="sidebar-link">SpringMVC</a></li><li class="sidebar-sub-header"><a href="/technology/frame_components.html#spring-cloud组件" class="sidebar-link">Spring Cloud组件</a></li><li class="sidebar-sub-header"><a href="/technology/frame_components.html#spring、spring-boot、spring-cloud区别" class="sidebar-link">Spring、Spring Boot、Spring Cloud区别</a></li><li class="sidebar-sub-header"><a href="/technology/frame_components.html#spring事务" class="sidebar-link">Spring事务</a></li></ul></li><li class="sidebar-sub-header"><a href="/technology/frame_components.html#mybatis" class="sidebar-link">MyBatis</a></li><li class="sidebar-sub-header"><a href="/technology/frame_components.html#dubbo" class="sidebar-link">Dubbo</a></li><li class="sidebar-sub-header"><a href="/technology/frame_components.html#redis" class="sidebar-link">Redis</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/technology/frame_components.html#数据类型-数据结构" class="sidebar-link">数据类型&amp;数据结构</a></li><li class="sidebar-sub-header"><a href="/technology/frame_components.html#持久化" class="sidebar-link">持久化</a></li><li class="sidebar-sub-header"><a href="/technology/frame_components.html#键过期策略" class="sidebar-link">键过期策略</a></li><li class="sidebar-sub-header"><a href="/technology/frame_components.html#内存淘汰策略" class="sidebar-link">内存淘汰策略</a></li><li class="sidebar-sub-header"><a href="/technology/frame_components.html#内存-线程模型" class="sidebar-link">内存&amp;线程模型</a></li><li class="sidebar-sub-header"><a href="/technology/frame_components.html#集群方案" class="sidebar-link">集群方案</a></li><li class="sidebar-sub-header"><a href="/technology/frame_components.html#redis-cluster使用案例" class="sidebar-link">Redis-cluster使用案例</a></li><li class="sidebar-sub-header"><a href="/technology/frame_components.html#redis命令" class="sidebar-link">redis命令</a></li></ul></li><li class="sidebar-sub-header"><a href="/technology/frame_components.html#kafka" class="sidebar-link">Kafka</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/technology/frame_components.html#架构模型" class="sidebar-link">架构模型</a></li><li class="sidebar-sub-header"><a href="/technology/frame_components.html#详细用例" class="sidebar-link">详细用例</a></li><li class="sidebar-sub-header"><a href="/technology/frame_components.html#kafka如何保证消息有序性" class="sidebar-link">Kafka如何保证消息有序性</a></li><li class="sidebar-sub-header"><a href="/technology/frame_components.html#一些有用的资料：" class="sidebar-link">一些有用的资料：</a></li></ul></li><li class="sidebar-sub-header"><a href="/technology/frame_components.html#zookeeper" class="sidebar-link">Zookeeper</a></li><li class="sidebar-sub-header"><a href="/technology/frame_components.html#flink" class="sidebar-link">Flink</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/technology/frame_components.html#flink原理介绍" class="sidebar-link">flink原理介绍</a></li><li class="sidebar-sub-header"><a href="/technology/frame_components.html#flink中的注意点" class="sidebar-link">flink中的注意点</a></li></ul></li><li class="sidebar-sub-header"><a href="/technology/frame_components.html#nginx" class="sidebar-link">Nginx</a></li><li class="sidebar-sub-header"><a href="/technology/frame_components.html#activiti" class="sidebar-link">Activiti</a></li><li class="sidebar-sub-header"><a href="/technology/frame_components.html#elasticsearch" class="sidebar-link">ElasticSearch</a></li></ul></li><li><a href="/technology/database.html" class="sidebar-link">数据库</a></li><li><a href="/technology/computer.html" class="sidebar-link">计算机基础</a></li><li><a href="/technology/data_structure.html" class="sidebar-link">数据结构</a></li><li><a href="/technology/algorithm.html" class="sidebar-link">算法</a></li><li><a href="/technology/ddd.html" class="sidebar-link">领域驱动模型</a></li><li><a href="/technology/design_pattern.html" class="sidebar-link">设计模式</a></li><li><a href="/technology/vim.html" class="sidebar-link">vim</a></li><li><a href="/technology/business.html" class="sidebar-link">业务</a></li><li><a href="/technology/tools.html" class="sidebar-link">工具</a></li><li><a href="/technology/other.html" class="sidebar-link">其他</a></li><li><a href="/technology/python.html" class="sidebar-link">Python</a></li><li><a href="/technology/go.html" class="sidebar-link">Go</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="spring"><a href="#spring" class="header-anchor">#</a> Spring</h2> <h3 id="spring主要包"><a href="#spring主要包" class="header-anchor">#</a> Spring主要包</h3> <ul><li>core：核心工具包，ioc的主要实现；</li> <li>beans：关于类的配置以及初始化等；</li> <li>aop：面向切面编程的包；</li> <li>web：web开发时所用到的包；</li> <li>mvc：mvc开发时所用到的包；</li> <li>test：进行单元测试所用的包；</li> <li>orm：整合orm的实现。</li></ul> <h3 id="spring的优点"><a href="#spring的优点" class="header-anchor">#</a> Spring的优点</h3> <ul><li>通过DI和IOC降低类之间的耦合度；</li> <li>将业务调用流程划分为更细的层级（MVC）；</li> <li>可以将对象的生命周期给容器进行托管（Singleton和Prototype）；</li> <li>与其他常见业务框架进行无缝整合；</li> <li>提供了常见的工具类。</li></ul> <h3 id="di和ioc机制的理解"><a href="#di和ioc机制的理解" class="header-anchor">#</a> DI和IOC机制的理解</h3> <p>依赖注入（Dependecy Injection）和控制反转（Inversion of Control）是同一个概念。</p> <p>当一个类需要另外一个类进行协助时：</p> <ul><li><p>在传统的编程中：调用类直接创建被调用类的实例；</p></li> <li><p>在IOC中：实例的创建时不再由调用者进行创建，而是交给spring进行创建，然后注入调用者。</p></li></ul> <p>优点：</p> <ul><li>去除了调用类与被调用类的耦合关系；</li> <li>当被调用类派生出很多子类时，可以进行快速替换处理。</li></ul> <h3 id="aop的理解"><a href="#aop的理解" class="header-anchor">#</a> AOP的理解</h3> <ul><li><p>通过<strong>反射</strong>和<strong>代理</strong>的手段可以做到进行业务代码的分层与代码无入侵式的织入；</p></li> <li><p>OOP（面向对象编程）是静态的抽象，而AOP是动态的抽象；</p></li> <li><p>是面向对象编程OOP的增强与补充，把代码拆分成几个层次，在层次中进行<strong>额外代码的补充与增强</strong>。</p></li></ul> <h3 id="orm的理解"><a href="#orm的理解" class="header-anchor">#</a> ORM的理解</h3> <ul><li>通过描述对象和数据库之间的映射关系，将对象自动持久化到关系数据库中；</li> <li>可以去除写SQL的繁杂过程。</li></ul> <h3 id="spring如何解决循环依赖的问题"><a href="#spring如何解决循环依赖的问题" class="header-anchor">#</a> Spring如何解决循环依赖的问题</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">A</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">B</span> b<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setB</span><span class="token punctuation">(</span><span class="token class-name">B</span> b<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>b <span class="token operator">=</span> b<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">B</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">A</span> a<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setA</span><span class="token punctuation">(</span><span class="token class-name">A</span> a<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>a <span class="token operator">=</span> a<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><blockquote><p><strong>重点：类的创建的初始步骤是先实例化，再初始化成员变量属性。</strong></p></blockquote> <ol><li>通过ApplicationContext.getBean()获取A类的实例对象时，由于容器找不到对应类型的对象，因此去创建A类型对象；</li> <li>实例化A类的目标对象后，把该实例对象放入ApplicationContext中（此时该实例对象被标记为<strong>半成品</strong>），然后发现A类中需要注入B类的实例对象，因此spring在ApplicationContext中查找B类；</li> <li>在ApplicationContext中没有发现B类，因此容器会去实例化B类的实体，实例化B类实体后，发现需要注入A类的实例对象，因此在ApplicationContext中寻找；</li> <li>此时B类可以在ApplicationContext发现A类的实例对象（那个<strong>半成品</strong>对象），B类成功进行实例化和初始化；</li> <li>后续进行反递归调用，寻找A类中的B类实例对象，进行注入处理。</li></ol> <h3 id="springmvc"><a href="#springmvc" class="header-anchor">#</a> SpringMVC</h3> <p><img src="/assets/img/springmvc原理.a7431ed6.png" alt="springmvc原理"></p> <p>DispatcherServlet部分源码：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">doDispatch</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token class-name">HttpServletRequest</span> processedRequest <span class="token operator">=</span> request<span class="token punctuation">;</span>
    <span class="token class-name">HandlerExecutionChain</span> mappedHandler <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">boolean</span> multipartRequestParsed <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    <span class="token class-name">WebAsyncManager</span> asyncManager <span class="token operator">=</span> <span class="token class-name">WebAsyncUtils</span><span class="token punctuation">.</span><span class="token function">getAsyncManager</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token class-name">ModelAndView</span> mv <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token class-name">Exception</span> dispatchException <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            processedRequest <span class="token operator">=</span> <span class="token function">checkMultipart</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
            multipartRequestParsed <span class="token operator">=</span> <span class="token punctuation">(</span>processedRequest <span class="token operator">!=</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>

            mappedHandler <span class="token operator">=</span> <span class="token function">getHandler</span><span class="token punctuation">(</span>processedRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mappedHandler <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> mappedHandler<span class="token punctuation">.</span><span class="token function">getHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">noHandlerFound</span><span class="token punctuation">(</span>processedRequest<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">//获取handler</span>
            <span class="token class-name">HandlerAdapter</span> ha <span class="token operator">=</span> <span class="token function">getHandlerAdapter</span><span class="token punctuation">(</span>mappedHandler<span class="token punctuation">.</span><span class="token function">getHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">String</span> method <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">boolean</span> isGet <span class="token operator">=</span> <span class="token string">&quot;GET&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>isGet <span class="token operator">||</span> <span class="token string">&quot;HEAD&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">long</span> lastModified <span class="token operator">=</span> ha<span class="token punctuation">.</span><span class="token function">getLastModified</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> mappedHandler<span class="token punctuation">.</span><span class="token function">getHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Last-Modified value for [&quot;</span> <span class="token operator">+</span> <span class="token function">getRequestUri</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;] is: &quot;</span> <span class="token operator">+</span> lastModified<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ServletWebRequest</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">checkNotModified</span><span class="token punctuation">(</span>lastModified<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> isGet<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token comment">//前置处理</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mappedHandler<span class="token punctuation">.</span><span class="token function">applyPreHandle</span><span class="token punctuation">(</span>processedRequest<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">//根据handle处理请求对象，此方法包括了查找Controller或者Servlet的步骤</span>
            mv <span class="token operator">=</span> ha<span class="token punctuation">.</span><span class="token function">handle</span><span class="token punctuation">(</span>processedRequest<span class="token punctuation">,</span> response<span class="token punctuation">,</span> mappedHandler<span class="token punctuation">.</span><span class="token function">getHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>asyncManager<span class="token punctuation">.</span><span class="token function">isConcurrentHandlingStarted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token function">applyDefaultViewName</span><span class="token punctuation">(</span>processedRequest<span class="token punctuation">,</span> mv<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//后置处理</span>
            mappedHandler<span class="token punctuation">.</span><span class="token function">applyPostHandle</span><span class="token punctuation">(</span>processedRequest<span class="token punctuation">,</span> response<span class="token punctuation">,</span> mv<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            dispatchException <span class="token operator">=</span> ex<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            dispatchException <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NestedServletException</span><span class="token punctuation">(</span><span class="token string">&quot;Handler dispatch failed&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//处理后续的对象与视图</span>
        <span class="token function">processDispatchResult</span><span class="token punctuation">(</span>processedRequest<span class="token punctuation">,</span> response<span class="token punctuation">,</span> mappedHandler<span class="token punctuation">,</span> mv<span class="token punctuation">,</span> dispatchException<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">triggerAfterCompletion</span><span class="token punctuation">(</span>processedRequest<span class="token punctuation">,</span> response<span class="token punctuation">,</span> mappedHandler<span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">triggerAfterCompletion</span><span class="token punctuation">(</span>processedRequest<span class="token punctuation">,</span> response<span class="token punctuation">,</span> mappedHandler<span class="token punctuation">,</span>
                               <span class="token keyword">new</span> <span class="token class-name">NestedServletException</span><span class="token punctuation">(</span><span class="token string">&quot;Handler processing failed&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>asyncManager<span class="token punctuation">.</span><span class="token function">isConcurrentHandlingStarted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mappedHandler <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mappedHandler<span class="token punctuation">.</span><span class="token function">applyAfterConcurrentHandlingStarted</span><span class="token punctuation">(</span>processedRequest<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>multipartRequestParsed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">cleanupMultipart</span><span class="token punctuation">(</span>processedRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">processDispatchResult</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span>
                                   <span class="token class-name">HandlerExecutionChain</span> mappedHandler<span class="token punctuation">,</span> <span class="token class-name">ModelAndView</span> mv<span class="token punctuation">,</span> <span class="token class-name">Exception</span> exception<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>

    <span class="token keyword">boolean</span> errorView <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>exception <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>exception <span class="token keyword">instanceof</span> <span class="token class-name">ModelAndViewDefiningException</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;ModelAndViewDefiningException encountered&quot;</span><span class="token punctuation">,</span> exception<span class="token punctuation">)</span><span class="token punctuation">;</span>
            mv <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ModelAndViewDefiningException</span><span class="token punctuation">)</span> exception<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getModelAndView</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token class-name">Object</span> handler <span class="token operator">=</span> <span class="token punctuation">(</span>mappedHandler <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> mappedHandler<span class="token punctuation">.</span><span class="token function">getHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mv <span class="token operator">=</span> <span class="token function">processHandlerException</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> handler<span class="token punctuation">,</span> exception<span class="token punctuation">)</span><span class="token punctuation">;</span>
            errorView <span class="token operator">=</span> <span class="token punctuation">(</span>mv <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>mv <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>mv<span class="token punctuation">.</span><span class="token function">wasCleared</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//根据ModelAndView渲染页面</span>
        <span class="token function">render</span><span class="token punctuation">(</span>mv<span class="token punctuation">,</span> request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>errorView<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">WebUtils</span><span class="token punctuation">.</span><span class="token function">clearErrorRequestAttributes</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Null ModelAndView returned to DispatcherServlet with name '&quot;</span> <span class="token operator">+</span> <span class="token function">getServletName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span>
                         <span class="token string">&quot;': assuming HandlerAdapter completed request handling&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">WebAsyncUtils</span><span class="token punctuation">.</span><span class="token function">getAsyncManager</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isConcurrentHandlingStarted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>mappedHandler <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mappedHandler<span class="token punctuation">.</span><span class="token function">triggerAfterCompletion</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br></div></div><p>SimpleControllerHandlerAdapter部分源码：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">ModelAndView</span> <span class="token function">handle</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Object</span> handler<span class="token punctuation">)</span>
    <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>

    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Controller</span><span class="token punctuation">)</span> handler<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">handleRequest</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="spring-cloud组件"><a href="#spring-cloud组件" class="header-anchor">#</a> Spring Cloud组件</h3> <ul><li><p>eureka和consul：注册中心；</p> <p>功能对比与组件选型：</p> <ul><li>eureka：已经闭源，基于AP，没有对应的配置中心，没有主从节点，一个节点挂了自动切换到其他节点使用，去中心化；</li> <li>consul：保证一致性，基于CP，需要进行集群搭建，某个节点失效首先需要选择新的leader，半数以上的节点不可用，则服务继续提供正常服务。</li></ul></li> <li><p>ribbon：负载均衡；</p></li> <li><p>zuul/gateway：网关；</p></li> <li><p>feign：关于interfact的http远程调用；</p></li></ul> <p><img src="/assets/img/feign原理.172cdbc7.png" alt="feign原理"></p> <ul><li>hystrix：熔断器。</li></ul> <p><img src="/assets/img/hystrix原理.0fc037c5.png" alt="hystrix原理"></p> <h3 id="spring、spring-boot、spring-cloud区别"><a href="#spring、spring-boot、spring-cloud区别" class="header-anchor">#</a> Spring、Spring Boot、Spring Cloud区别</h3> <ul><li>Spring是最基础的实现，基础依赖包都囊括在spring，颗粒度最细；</li> <li>Spring Boot就是集成好默认的Spring配置，约定大于配置；</li> <li>Spring Cloud旨在解决微服务架构问题，提供服务注册发现、服务消费、熔断保护、网关和分布式调用链和分布式配置等。</li></ul> <h3 id="spring事务"><a href="#spring事务" class="header-anchor">#</a> Spring事务</h3> <h4 id="事务的传播属性"><a href="#事务的传播属性" class="header-anchor">#</a> 事务的传播属性</h4> <table><thead><tr><th>级别</th> <th>详解</th></tr></thead> <tbody><tr><td>PROPAGATION_REQUIRED</td> <td>支持当前运行的事务，如果不存在事务则创建一个新的事务，为Spring的默认传播级别</td></tr> <tr><td>PROPAGATION_SUPPORTS</td> <td>支持当前运行的事务，如果不存在事务则以非事务模式运行</td></tr> <tr><td>PROPAGATION_MANDATORY</td> <td>支持当前运行的事务，如果不存在事务则抛出异常</td></tr> <tr><td>PROPAGATION_REQUIRES_NEW</td> <td>创建新事务运行，如果存在事务则挂起当前事务</td></tr> <tr><td>PROPAGATION_NOT_SUPPORTED</td> <td>不持支当前事务，总是以非事务方式执行</td></tr> <tr><td>PROPAGATION_NEVER</td> <td>不支持当前事务，如果当前存在事务则抛出异常</td></tr> <tr><td>PROPAGATION_NESTED</td> <td>以嵌套方式执行事务；外层事务失败会回滚内层事务，内层事务不会回滚外层事务。在A中执行B，A报错B会回滚，但B报错仅B回滚，A不会回滚</td></tr></tbody></table> <h4 id="spring事务不生效的场景"><a href="#spring事务不生效的场景" class="header-anchor">#</a> Spring事务不生效的场景</h4> <ul><li>数据库引擎本身不支持事务</li> <li>对应的Service没有被Spring管理</li> <li>@Transactional注解所在方法不是public修饰</li> <li>自身调用的情况</li> <li>数据源没有配置事务管理器</li> <li>@Transactional中传播方式为不支持事务</li> <li>出现异常但是被方法内部捕获了，又没有向框架抛出异常</li> <li>@Transactional抛出非RuntimeException或者Error异常，需要使用rollbackFor支持其他异常的回滚</li></ul> <h2 id="mybatis"><a href="#mybatis" class="header-anchor">#</a> MyBatis</h2> <p><img src="/assets/img/mybatis缓存机制.b1ff8155.png" alt="mybatis缓存机制"></p> <ul><li>一级缓存：在开启一个数据库会话时，会新建一个SqlSession对象（含Executor），Executor在执行对应的SQL语句时，会去PerpetualCache对象中寻找对应的缓存，该缓存对象随着SqlSession对象死亡而释放；如果SqlSession调用了clearCache()、update()、delete()、insert()任意一个方法，都会<strong>清空PerpetualCache的数据</strong>；一级缓存默认为<strong>开启</strong>状态；</li> <li>二级缓存：默认是不开启二级缓存，默认原生二级缓存需要返回的POJO必须是可序列化的，一般通过LRU的算法来回收。</li></ul> <h2 id="dubbo"><a href="#dubbo" class="header-anchor">#</a> Dubbo</h2> <p><img src="/assets/img/dubbo架构1.939e9228.jpg" alt="dubbo架构1"></p> <ul><li>图中左边淡蓝背景的为服务消费方使用的接口，右边淡绿色背景的为服务提供方使用的接口，位于中轴线上的为双方都用到的接口。</li> <li>图中从下至上分为十层，各层均为单向依赖，右边的黑色箭头代表层之间的依赖关系，每一层都可以剥离上层被复用，其中，Service 和 Config 层为 API，其它各层均为 SPI。</li> <li>图中绿色小块的为扩展接口，蓝色小块为实现类，图中只显示用于关联各层的实现类。</li> <li>图中蓝色虚线为初始化过程，即启动时组装链，红色实线为方法调用过程，即运行时调时链，紫色三角箭头为继承，可以把子类看作父类的同一个节点，线上的文字为调用的方法。</li></ul> <p><img src="/assets/img/dubbo架构2.65e2c819.jpg" alt="dubbo架构2"></p> <p><img src="/assets/img/dubbo架构3.aa873d72.jpg" alt="dubbo架构3"></p> <p><img src="/assets/img/dubbo架构4.4304905e.jpg" alt="dubbo架构4"></p> <p><img src="/assets/img/dubbo架构5.712bddbe.jpg" alt="dubbo架构5"></p> <h2 id="redis"><a href="#redis" class="header-anchor">#</a> Redis</h2> <h3 id="数据类型-数据结构"><a href="#数据类型-数据结构" class="header-anchor">#</a> 数据类型&amp;数据结构</h3> <p>数据类型：仅支持<strong>byte数组</strong>类型。</p> <p>数据结构：</p> <ul><li>String：一个key对应一个value的简单映射；</li> <li>List：一个key对应多个value，value值可以重复；</li> <li>Hash：一个key对应多个key-value键值对；</li> <li>Set：一个key对应多个value，value不可以重复，value之间没有顺序关系；</li> <li>Sorted Set：一个key对应多个value，value不可以重复，有顺序关系，先按照score排序，再按照value排序。</li></ul> <h3 id="持久化"><a href="#持久化" class="header-anchor">#</a> 持久化</h3> <ul><li><p>RDB：生成数据库的快照，相当于直接dump出数据文件。分为手动触发和自动触发（设定x秒内存在y次数据变更时自动触发）</p> <ul><li>优点：加载恢复时很快；</li> <li>缺点：不能做到命令级别或者秒级的。</li></ul></li> <li><p>AOF：通过记录执行的命令进行记录，所有写命令直接追加到文件中，随着命令不断增加，AOF的文件逐渐变大，可以通过重写机制进行AOF文件的压缩。</p></li></ul> <h3 id="键过期策略"><a href="#键过期策略" class="header-anchor">#</a> 键过期策略</h3> <ul><li>惰性过期：访问一个key时才会判断是否已经过期，过期清除；
<ul><li>优点：使用才进行计算，节省CPU资源；</li> <li>缺点：占用内存。</li></ul></li> <li>定期过期：每隔一段时间扫描expires字典中的key；
<ul><li>优点：平衡CPU和内存资源。</li></ul></li></ul> <h3 id="内存淘汰策略"><a href="#内存淘汰策略" class="header-anchor">#</a> 内存淘汰策略</h3> <ul><li><p>volatile-lru：从已设置过期时间的数据集中挑选最近最少使用的数据淘汰；</p></li> <li><p>volatile-ttl：从已设置过期时间的数据集中挑选将要过期的数据淘汰；</p></li> <li><p>volatile-random：从已设置过期时间的数据集中任意选择数据淘汰；</p></li> <li><p>volatile-lfu：从已设置过期时间的数据集挑选使用频率最低的数据淘汰；</p></li> <li><p>allkeys-lru：从数据集中挑选最近最少使用的数据淘汰；</p></li> <li><p>allkeys-lfu：从数据集中挑选使用频率最低的数据淘汰；</p></li> <li><p>allkeys-random：从数据集中任意选择数据淘汰；</p></li> <li><p>no-enviction：禁止驱逐数据，这也是<strong>默认策略</strong>。意思是当内存不足以容纳新入数据时，新写入操作就会报错，请求可以继续进行，线上任务也不能持续进行，采用no-enviction策略可以保证数据不被丢失。</p></li></ul> <h3 id="内存-线程模型"><a href="#内存-线程模型" class="header-anchor">#</a> 内存&amp;线程模型</h3> <blockquote><p>Redis基于Reactor模式开发了网络事件处理器，该处理器被称为文件时间处理器，由套接字、IO多路复用程序、文件事件分派器和事件处理器组成。文件事件分派器队列是单线程的，所以才成为单线程模型，但是其他模块仍用了多个线程处理。</p></blockquote> <ul><li>绝大部分请求是存粹的内存操作；</li> <li>采用了单线程，避免了上下文切换和竞争条件；注意是处理网络请求的时候只有一个线程来处理；</li> <li>采用了非阻塞IO：IO多路复用。</li></ul> <p><img src="/assets/img/redis线程模型.38b87d68.png" alt="redis线程模型"></p> <h3 id="集群方案"><a href="#集群方案" class="header-anchor">#</a> 集群方案</h3> <h4 id="哨兵模式"><a href="#哨兵模式" class="header-anchor">#</a> 哨兵模式</h4> <p><img src="/assets/img/redis哨兵模式.f3da9ab0.png" alt="哨兵模式"></p> <ul><li>集群监控：负责监控 redis master 和 slave 进程是否正常工作；</li> <li>消息通知：如果某个 redis 实例有故障，那么哨兵负责发送消息作为报警通知给管理员；</li> <li>故障转移：如果 master node 挂掉了，会自动转移到 slave node 上；</li> <li>配置中心：如果故障转移发生了，通知 client 客户端新的 master 地址。</li></ul> <h4 id="基于客户端分配模式"><a href="#基于客户端分配模式" class="header-anchor">#</a> 基于客户端分配模式</h4> <p><img src="/assets/img/基于客户端分配.10d8fca3.jpg" alt="基于客户端分配模式"></p> <ul><li>配置简单，结构简单，容易搭建，不需要第三方的组件；</li> <li>本质上通过key映射到某Redis中的某个节点，<strong>不适合动态扩容（最重要缺点）</strong>；</li> <li>客户端决定数据存储到哪个Redis节点或者决定从哪个Redis节点读取数据，通过hash算法实现；</li> <li>代表为Redis Sharding，是在Redis Cluster出来前普遍使用的集群方法。</li></ul> <h4 id="redis-cluster"><a href="#redis-cluster" class="header-anchor">#</a> Redis Cluster</h4> <p><img src="/assets/img/RedisCluster模式.b787ea77.png" alt="Redis Cluster模式"></p> <ul><li>没有使用一致性hash（会有hash倾斜等问题）的方式，而是采用slot槽的概念；</li> <li>可以动态扩容，仅仅需要迁移<strong>一部分</strong>数据到新的节点；</li> <li>key寻址时，先进行hash，然后按照一定的方向落到对应的槽点中进行数据处理。</li></ul> <h3 id="redis-cluster使用案例"><a href="#redis-cluster使用案例" class="header-anchor">#</a> Redis-cluster使用案例</h3> <p>在目录中创建6个文件夹，对应为7000-7005，分别对应redis的占用端口，并将redis.conf复制到对应的文件夹中，并且修改为以下内容</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>bind 0.0.0.0
port [7000-7005]
pidfile /var/run/redis_[7000-7005].pid
cluster-enabled yes
cluster-config-file nodes-[7000-7005].conf
appendonly yes
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>分别进入对应的目录，运行redis</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>cd [7000-7005]
../redis-server ./redis.conf
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>使用redis-cli创建对应的集群，<code>--cluster-replicas 1</code>意味为每个创建的主机都提供一个从机</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>redis-cli --cluster create 127.0.0.1:7000 127.0.0.1:7001 127.0.0.1:7002 127.0.0.1:7003 127.0.0.1:7004 127.0.0.1:7005 --cluster-replicas 1
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>使用命令查看集群信息</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>./redis-cli --cluster check 127.0.0.1:7000
M: b16acaeab7e93f8a3f78fb78554d45036dca9ead 127.0.0.1:7001
   slots:[5461-10922] (5462 slots) master
   1 additional replica(s)
S: a24b06a6dd5d7257ac9a53b498fa054c02cbb304 127.0.0.1:7003
   slots: (0 slots) slave
   replicates ae4b63663e1a7659281457b7348dbd8a7b25286d
M: ae4b63663e1a7659281457b7348dbd8a7b25286d 127.0.0.1:7000
   slots:[0-5460] (5461 slots) master
   1 additional replica(s)
S: 46bc4e483d547db2b2b3545400a7b76029af3422 127.0.0.1:7004
   slots: (0 slots) slave
   replicates b16acaeab7e93f8a3f78fb78554d45036dca9ead
S: 4e2e94ac889c18c408af5c047b73063e1e671386 127.0.0.1:7002
   slots: (0 slots) slave
   replicates b843d2a4d24f0c0d758863433f9c918c7527dc0f
M: b843d2a4d24f0c0d758863433f9c918c7527dc0f 127.0.0.1:7005
   slots:[10923-16383] (5461 slots) master
   1 additional replica(s)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>先要创建配置运行的文件</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>cd [7006-7007]
../redis-server ./redis.conf
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>使用<code>add-node</code>命令为集群添加节点（主节点），注意添加完成后，主节点并不会自动地进行rehash处理，需要手动进行rehash</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>redis-cli --cluster add-node 127.0.0.1:7006 127.0.0.1:7000
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>添加从节点<code>--cluster-slave</code>，注意从节点在加入时，会自动寻找集群中备份最少的节点并作为其从节点</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>redis-cli --cluster add-node 127.0.0.1:7007 127.0.0.1:7000 --cluster-slave
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>要删除一个从节点，只需使用<code>del-node</code>redis-cli命令</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>redis-cli --cluster del-node 127.0.0.1:7000 `&lt;node-id&gt;`
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>重新分簇（Rehash）</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>redis-cli --cluster reshard 127.0.0.1:7000
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="redis命令"><a href="#redis命令" class="header-anchor">#</a> redis命令</h3> <p>scan：</p> <ul><li><p>可以控制返回的数量，使用count指定返回数据量，使用match来进行数据匹配SCAN cursor [MATCH pattern] [COUNT count]</p></li> <li><p>SCAN命令用于迭代当前数据库中的数据库键；</p></li> <li><p>SSCAN 命令用于迭代集合键中的元素；</p></li> <li><p>HSCAN命令用于迭代哈希键中的键值对；</p></li> <li><p>ZSCAN命令用于迭代有序集合中的元素（包括元素成员和元素分值）；</p></li></ul> <p>keys和scan的区别：</p> <ul><li>keys处理拥有大量数据的场景时，由于redis是单线程的，可能阻塞服务器长达数秒；</li> <li>scan是基于增量式迭代的，默认返回有限条数据，在scan返回数据的过程中，键值可能会被修改；</li></ul> <h2 id="kafka"><a href="#kafka" class="header-anchor">#</a> Kafka</h2> <h3 id="架构模型"><a href="#架构模型" class="header-anchor">#</a> 架构模型</h3> <p><img src="/assets/img/kafka架构模型.c2f93438.png" alt="kafka架构模型"></p> <p>正常情况下，kafka里的数据都不能只有一份。假设我们保存了N个副本，即topic每个partition都有N个副本（Replica）。并且<strong>副本的个数一定小于broker个数</strong>（因为每份数据的副本必须保存在不同的broker，否则没有意义，因为如果一份数据的副本保存在同一个broker，那么这个broker挂了，则数据依然丢）。所以对于每个partition而言，每个broker上最多<strong>只有一个</strong>副本，因此我们常常使用broker-id表示副本。kafka还有个机制，就是会默认将副本均匀分布到所有的broker上。当replication-factor为N时，Partition会有N个副本，其中N为leader和follower的<strong>总和</strong>。</p> <p>分区的副本是通过follower副本向leader副本发送pull命令进行请求同步的；</p> <p>分区的同步可以分为<strong>同步复制</strong>、<strong>异步复制</strong>和<strong>commit</strong>：</p> <ul><li>同步复制：所有follower拉完数据后才commit，一致性好，可用性不高；</li> <li>异步复制：只要leader拿到数据后立即commit，再等follower进行复制，一致性差，可用性高；</li> <li>ISR机制：不是完全同步异步的方式，leader副本会位置一个ISR（in-sync replicas）列表，当一个消息发送给leader的时候，leader会等待ISR中所有的副本告诉它已经接收了这个消息，如果一个副本失败了，那么它会被移除ISR。</li></ul> <p><strong>自动提交</strong>和<strong>手动提交</strong></p> <ul><li>自动提交：<strong>enable.auto.commit=true</strong>，不是拉取的时候马上提交；在每次poll数据之前，检查是否到达<strong>auto.commit.interval.ms</strong>的时间，如果到达，则提交拉取消息的最大偏移量</li> <li>手动提交：<strong>enable.auto.commit=false</strong>，需要通过commitAsync()或者commitSync()进行提交处理</li></ul> <p><strong>ack的参数配置</strong>：</p> <ul><li>0：leader收到producer的消息没有写盘就返回ack，leader故障时会丢失数据</li> <li>1：leader收到数据落盘返回ack，大概率会发生数据丢失</li> <li>-1（ALL）：ISR中所有的follower都同步成功后才返回ack，但是如果在返回ack的时候突然挂掉，生产者还会重新发送一条数据，因此会造成数据的重复</li></ul> <h3 id="详细用例"><a href="#详细用例" class="header-anchor">#</a> 详细用例</h3> <p>在目录中创建3个文件夹，对应为9092-9094，分别对应kafka的占用端口，并将server.properties复制到对应的文件夹中，并且修改为以下内容</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>broker.id=[0-2]
listeners=PLAINTEXT://:[9092-9094]
log.dirs=/tmp/kafka-logs-[9092-9094]
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>启动zookeeper，<code>-daemon</code>命令表示使用后台运行</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>bin/zookeeper-server-start.sh -daemon ./config/zookeeper.properties
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>进入对应的[9092-9094]文件夹中，执行以下命令，<code>-daemon</code>命令表示使用后台运行</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>../kafka_2.12-2.4.1/bin/kafka-server-start.sh -daemon server.properties
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>创建主题， <code>--partitions</code>表示创建的分区数量，<code>--replication-factor</code>表示副本因子（对应一个节点上单个分区的数量）</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>bin/kafka-topics.sh --bootstrap-server localhost:9092 --create --topic test --partitions 3 --replication-factor 3
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>查看对应的主题列表</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>bin/kafka-topics.sh --bootstrap-server localhost:9092 --list
__consumer_offsets
test
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>查看主题详细信息</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>bin/kafka-topics.sh --bootstrap-server localhost:9092 --describe --topic test
Topic: test    PartitionCount: 3    ReplicationFactor: 3    Configs: segment.bytes=1073741824
    Topic: test    Partition: 0    Leader: 2    Replicas: 2,0,1    Isr: 2,0,1
    Topic: test    Partition: 1    Leader: 1    Replicas: 1,2,0    Isr: 1,2,0
    Topic: test    Partition: 2    Leader: 0    Replicas: 0,1,2    Isr: 0,1,2
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>创建2个消费者，<code>--group</code>指定对应的消费者群组，注意需要指定消费群组，若不指定，则终端会默认自己创建一个默认的消费者群组，这样结果会导致生产者发送消息后，所有的消费者都会<strong>消费到同一条信息</strong></p> <div class="language- line-numbers-mode"><pre class="language-text"><code>bin/kafka-console-consumer.sh --bootstrap-server localhost:9092 --topic test --group test
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>创建1个消费者</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>bin/kafka-console-producer.sh --broker-list localhost:9092 --topic test
&gt;0
&gt;1
&gt;2
&gt;3
&gt;4
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p><img src="/assets/img/kafka消费结果.9bc156be.png" alt="kafka消费结果"></p> <p>在test群组中多加入一个消费者时，消费者也可以继续消费。但是再加入一个后，test群组中的consumer数量为4，比分区数量3还多，因此有一个消费者<strong>无法消费</strong>信息。</p> <h3 id="kafka如何保证消息有序性"><a href="#kafka如何保证消息有序性" class="header-anchor">#</a> Kafka如何保证消息有序性</h3> <ul><li>Kafka topic只设置一个partition分区：kafka默认保证同一个partition分区内的消息是有序的，设置全局一个分区这样就保证全局有序，但缺点是只能被consumer group里的一个消费者消费，不适合高并发的情况；</li> <li>producer将消息发送到指定分区：
<ul><li>指定分区</li> <li>不指定分区，由指定key，根据key的hash规则确定发送到哪个分区</li> <li>不指定分区，不指定key，轮询发送</li></ul></li></ul> <h3 id="一些有用的资料："><a href="#一些有用的资料：" class="header-anchor">#</a> 一些有用的资料：</h3> <ul><li>https://juejin.cn/post/7176576097205616700</li> <li>https://zhuanlan.zhihu.com/p/377209008</li></ul> <h2 id="zookeeper"><a href="#zookeeper" class="header-anchor">#</a> Zookeeper</h2> <h4 id="角色分类"><a href="#角色分类" class="header-anchor">#</a> 角色分类</h4> <ul><li>Leader：维护各个follower以及心跳，所有写操作通过leader进行写操作并广播给其他服务器，只要超过半数节点写入，写请求就会被提交；</li> <li>Follower：响应leader的心跳请求，响应客户端的读请求，并将写请求转发给leader处理；</li> <li>Observer：与follower类似，不参与投票，响应读请求，把写请求转发给leader。</li></ul> <p><img src="/assets/img/zookeeper模型.0eb6ac5c.png" alt="zookeeper模型"></p> <h4 id="数据模型"><a href="#数据模型" class="header-anchor">#</a> 数据模型</h4> <p>类似数据结构中的树模型，类似文件系统中的目录。zookeeper中对应节点名字叫znode，使用方式是<strong>路径引用</strong>。znode中包含以下的信息：</p> <ul><li>data：存储的数据信息；</li> <li>ACL：访问权限；</li> <li>stat：元数据，比如事务zxid、版本号、时间戳、大小等；</li> <li>child：当前节点的子节点引用，类似树的各种孩子。</li></ul> <p>可以分为4种形式的目录节点：</p> <ul><li>persistent：持久节点；</li> <li>ephemeral：暂时节点；</li> <li>persistent_sequential：持久化顺序编号目录节点；</li> <li>ephemeral_sequential：暂时化顺序编号目录节点。</li></ul> <h4 id="zab协议"><a href="#zab协议" class="header-anchor">#</a> Zab协议</h4> <p>事务编号Zxid：共64位，低32位是单调递增的计数器，针对客户端每一个事务请求，计数器加1；高32位代表leader周期epoch的编号，每个当选的leader会从所有节点本地日志中选出最大的zxid，并读取其epoch值，然后加1，以此作为新的epoch，并将低32位从0开始计数。zxid是保持<strong>单调递增</strong>的。</p> <ul><li><p>恢复模式：机器启动、leader崩溃、leader失去大部分follower支持都会进入该阶段</p> <ul><li>Leader election（选举阶段）：<em><strong>选出准leader</strong></em>，集群节点处于looing状态，带上自己<strong>服务器id和本地最新的zxid</strong>，与其他节点进行通讯投票，当收到请求后，节点会用自身的zxid和其他节点的zxid做比较，如果发现其他节点的zxid比自己大（说明数据比自己新），那么重新发起投票，投票给目前<strong>已知最大的zxid</strong>所属节点。当一个节点得到超过半数节点的票数，那么可以当选<strong>准leader</strong>；</li> <li>Discovery（发现阶段）：<em><strong>接受提议、生成epoch、接受epoch</strong></em>，follower和准leader进行通讯，准leader同步各个follower最新接收到的事务提议。在所有follower各自发来的<strong>最新epoch值</strong>中选出最大的epoch值加1，并以这个值作为最新的epoch，通知给所有follower；</li> <li>Synchronization（同步阶段）：<em><strong>同步follower副本</strong></em>，利用上一个阶段获得的最新历史提议，同步到集群中的所有副本。只有大多数节点同步完成，准leader才会成为真诚的leader，<strong>follower只会接受zxid比自己的最大zxid还大的提议</strong>，此时leader的状态改为leading，follower的状态改为following。</li></ul></li> <li><p>广播模式：zookeeper集群对外正式开始提供服务，并且leader可以进行消息广播，如果有新的节点计入，还需要对新节点进行同步。</p> <p><img src="data:image/jpeg;base64,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AAIBAwECCgcGBQMDBQAAAAECAwAEEZMFEhAhMDFRUlOSstEGEyBBVLHSFCJAYWKkMkNQcXIjM8EVNHNCgZGUov/aAAgBAQAJPwATGR9/JEzgcTEULjXehca70LjXehca70LjXehca70LjXehca70LjXehca70LjXehca70LjXehca70LjXehca70LjXehca70LjXehca70LjXehca70LjXehca70LjXehca70LjXehca70LjXehca70LjXehca70LjXehca70swkhtpZFJmkIBVaN3LFb28MozvxSEuWGAM4K5FbOvDcPLIgiNy6DEYDEhmI61Wd4ALS3uCDcNzTuUA//NWV8UjaZBIsrnLwjJHPVjMpkvUgkR7p8oGQvkgHIIoXGu9C413oXGu9C413oXGu9C413oXGu9C413oXGu9C413oXGu9C413oXGu9C413oXGu9C413oXGu9C413oXGu9C413ozq5nVCfXPzFSa6X8R/oaB45FKsp5iCMHNQIxkhET9BQEkKR7+erRPVrIXHWDEYJznOTzGoEmMEKxB26FOQCBVqnrZAQ7YznIwfyyRzmrRAolWUc+QyjAP4X4tfA1dL+I/134tfA1dL+I/0V9yKGNpHbjOFUZJwKbejljV1PGMhxkcR/D/Fr4GrpfxH+i8cl0BbRL1mmISv5UKR9xQPw/wAWvgaul/Ef6JIqRopLOxAUAc5JNIRsiwYm13wR9on7X/FfxHxa+Bq6X8R/oW1IEPUDb791a2Ddz5/nzj7PDV8LhAQwsoAUth9dKFVVACgYAA5gB+I+LXwNXS/iP4+VY4Yxl3biAFWcdrZnmvbznf8A8cVbYv8AaB96esMMPcjrZttEeuEG93j+L+LXwNXS/iP46VEaUkRhiFLkcZC55zUiDZeyIo5plcgI88oyu/8AkoogoygqRzEEcRH434tfA1dL+I8u5R47WVkYc4YKTQd0mntooEupQ5DO2GJKA8VQw7qzSQbu8fWh44jKXK9Q1HaljDaSKUkJjT7U25iVvyqO3/3LhJXLkoRAwXKAcZDdNW6CJZ2hJLAPkR7+/wD48lgTY34T1ZF5qkmeCFxLdhyf5XEA3IzTgwfZin+oBCm/ktvoefNRWyD/AKkbOJ3cgDHO0hqG2A+x/aGV5CC+JDGRD0551qKExi4eALvkS5SL1u/0BDUEBm9fDGFDEqnr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" alt="zookeeper广播实例图"></p> <ol><li>客户端发送写入请求到任意的follower；</li> <li>server把写入数据请求转发给leader；</li> <li>leader采用二段提交方式，发送propose广播给follower；</li> <li>follower接收到propose消息，写入日志成功后，返回ack消息给leader；</li> <li>leader接收到半数以上ack消息，返回成功给客户端，并且广播commit请求给follower。</li></ol></li></ul> <h2 id="flink"><a href="#flink" class="header-anchor">#</a> Flink</h2> <h3 id="flink原理介绍"><a href="#flink原理介绍" class="header-anchor">#</a> flink原理介绍</h3> <h4 id="集群功能任务介绍"><a href="#集群功能任务介绍" class="header-anchor">#</a> 集群功能任务介绍</h4> <p><img src="/assets/img/集群功能任务介绍.f028b2d0.svg" alt="flink执行原理图"></p> <ul><li>JobManager：
<ul><li>分布式协调调度</li> <li>提交/终止task</li> <li>调度checkpoint</li> <li>失败恢复</li></ul></li> <li>TaskManager：
<ul><li>对应分配资源的单位：对应每一台机器/虚拟机，是独立的一个JVM</li> <li>根据不同的slot执行对应的子任务</li> <li>数据的序列化与反序列化，数据网络交换</li></ul></li></ul> <h4 id="算子，槽，并行度概念"><a href="#算子，槽，并行度概念" class="header-anchor">#</a> 算子，槽，并行度概念</h4> <p><img src="/assets/img/算子，槽，并行度概念1.dad70837.svg" alt="算子，槽，并行度概念1"></p> <p><img src="/assets/img/算子，槽，并行度概念2.4f06a541.svg" alt="算子，槽，并行度概念2"></p> <ul><li>算子：进行独立功能计算的功能对象方法</li> <li>槽（Slot）：内存分配的单位，不会与其他槽进行内存竞争（内存隔离），每一个槽都分配给一个独立的线程执行任务，因此<strong>推荐槽与CPU数量呈1：1对应关系</strong>，其他的例如TCP，CPU资源还是共享的关系；上图，表示2个TaskManger节点，每个节点有3个槽，每个槽占据每个TaskManager的内存的三分之一；可以理解为：<strong>一台特定的机器上启动多少个并行执行的实例</strong></li> <li>并行度（Parallelism）：表示实际的子任务同时处理的数量，<strong>最大只能设置为槽的数量</strong></li></ul> <h4 id="核心数据功能"><a href="#核心数据功能" class="header-anchor">#</a> 核心数据功能</h4> <ul><li>Source：输入</li> <li>Sink：输出</li> <li>DataStream：输入到系统后成为的流，也是应用各种function的对象</li> <li>Function：各种对流的操作，例如
<ul><li>FlatMap：数据拆分映射，不过给了一个collector，可以进行数据的丢弃</li> <li>Map：数据映射，数据是不能丢弃的（如果返回null下游是可以收到null数据的）</li> <li>Filter：数据过滤器</li> <li>Reduce：把两个元素聚合为一个</li> <li>Window：数据归窗</li></ul></li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Public</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">SourceFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">Function</span><span class="token punctuation">,</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{</span>
    
    <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">SourceContext</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> ctx<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">;</span>

    <span class="token keyword">void</span> <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">interface</span> <span class="token class-name">SourceContext</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

        <span class="token keyword">void</span> <span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">T</span> element<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">void</span> <span class="token function">collectWithTimestamp</span><span class="token punctuation">(</span><span class="token class-name">T</span> element<span class="token punctuation">,</span> <span class="token keyword">long</span> timestamp<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">void</span> <span class="token function">emitWatermark</span><span class="token punctuation">(</span><span class="token class-name">Watermark</span> mark<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">void</span> <span class="token function">markAsTemporarilyIdle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Object</span> <span class="token function">getCheckpointLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">SinkFunction</span><span class="token generics"><span class="token punctuation">&lt;</span>IN<span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">Function</span><span class="token punctuation">,</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{</span>

    <span class="token keyword">default</span> <span class="token keyword">void</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">IN</span> value<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

    <span class="token keyword">default</span> <span class="token keyword">void</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">IN</span> value<span class="token punctuation">,</span> <span class="token class-name">Context</span> context<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token function">invoke</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">interface</span> <span class="token class-name">Context</span> <span class="token punctuation">{</span>

        <span class="token keyword">long</span> <span class="token function">currentProcessingTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">long</span> <span class="token function">currentWatermark</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Long</span> <span class="token function">timestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">MapFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">O</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">Function</span><span class="token punctuation">,</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{</span>

    <span class="token class-name">O</span> <span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">T</span> value<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">FlatMapFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">O</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">Function</span><span class="token punctuation">,</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{</span>

    <span class="token keyword">void</span> <span class="token function">flatMap</span><span class="token punctuation">(</span><span class="token class-name">T</span> value<span class="token punctuation">,</span> <span class="token class-name">Collector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">O</span><span class="token punctuation">&gt;</span></span> out<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">FilterFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">Function</span><span class="token punctuation">,</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{</span>

    <span class="token keyword">boolean</span> <span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">T</span> value<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">WindowFunction</span><span class="token generics"><span class="token punctuation">&lt;</span>IN<span class="token punctuation">,</span> OUT<span class="token punctuation">,</span> KEY<span class="token punctuation">,</span> <span class="token class-name">W</span> <span class="token keyword">extends</span> <span class="token class-name">Window</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">Function</span><span class="token punctuation">,</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{</span>

    <span class="token keyword">void</span> <span class="token function">apply</span><span class="token punctuation">(</span><span class="token class-name">KEY</span> key<span class="token punctuation">,</span> <span class="token class-name">W</span> window<span class="token punctuation">,</span> <span class="token class-name">Iterable</span><span class="token generics"><span class="token punctuation">&lt;</span>IN<span class="token punctuation">&gt;</span></span> input<span class="token punctuation">,</span> <span class="token class-name">Collector</span><span class="token generics"><span class="token punctuation">&lt;</span>OUT<span class="token punctuation">&gt;</span></span> out<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br></div></div><p>其他高级额外功能：</p> <ul><li>windows：
<ul><li><strong>Tumbling Windows</strong>：滚动窗口，窗口的<strong>大小是固定的</strong>，且<strong>各自范围不重叠</strong>；</li> <li><strong>Sliding Windows</strong>：滑动窗口，<strong>window size窗口大小</strong>，<em><strong>window slide滑动距离</strong></em>，如果 slide 小于窗口大小，滑动窗口可以允许窗口重叠。这种情况下，一个元素可能会被分发到多个窗口；</li> <li>Session Windows：会话窗口，不会相互重叠，且没有固定的开始或结束时间。 会话窗口在一段时间没有收到数据之后会关闭；</li> <li>Global Windows：全局窗口，所有的key分配到一个窗口，自定义trigger很有用</li></ul></li> <li>Window Functions：
<ul><li>aggregate：窗口元素聚合</li> <li>reduce：合并到一个输出数据，是aggregate的特例</li> <li>processWindow：能获取包含窗口内所有元素的 Iterable， 以及用来获取时间和状态信息的 Context 对象，比其他窗口函数更加灵活</li></ul></li> <li>Triggers ：决定窗口什么时候被处理</li> <li>Evictors ：移除窗口内的元素</li></ul> <p><img src="/assets/img/flink核心数据功能.508d0b61.jpg" alt="原理图"></p> <h3 id="flink中的注意点"><a href="#flink中的注意点" class="header-anchor">#</a> flink中的注意点</h3> <ul><li>需要以<strong>数据流</strong>为切入点，如果需要做<strong>复杂业务</strong>处理flink是非常不合适的</li> <li>由于是<strong>CPU密集型</strong>，因此线程控制权交给flink管理</li> <li>算子处理任务出错时不能向框架抛出错误（例如json反序列化错误），因为算子异常会导致对应进程<strong>重启尝试</strong></li> <li>流中使用到的数据传输类，都<strong>必须实现Serializable</strong>，因为本质上就是要经过Java原生的序列化</li> <li>算子的声明周期是由manager进行管理的，当我们new算子的时候并不是真正的创建算子。因此不能在构造函数中执行初始化操作，而是在<strong>open方法</strong>中</li> <li>做对应的flink功能，功能内自行启动线程、使用线程池等去维护意义不大（flink已经管理好对应的slot和资源，这些资源都是已经<strong>相互隔离</strong>的）</li> <li>含大量的泛型类以及函数，很多情况下，算子处理函数后需要补充.returns函数以标志返回对应泛型的类型</li> <li><strong>无法解决业务数据依赖的问题</strong>：对于广播状态的功能，某个算子X中含有A广播流和B普通流，算子X对B的处理依赖A广播流的传入，此时必须要求在处理B流数据前A流先一步到达，这个功能不太好实现</li> <li>本质上不适合做很重业务逻辑性的操作，因为是CPU密集型的，会造成堵塞</li> <li>某个subtask提前finish导致savepoint失败</li></ul> <h2 id="nginx"><a href="#nginx" class="header-anchor">#</a> Nginx</h2> <p>目前Nginx集群没有好的解决方案，下面对应的技术方案可以简单实现：</p> <ol><li>构建DNS+CDN服务器</li> <li>在多个公网IP中搭建多台Nginx服务器</li> <li>通过DNS进行域名的动态切换，通过CDN进行动态流量输入</li></ol> <h2 id="activiti"><a href="#activiti" class="header-anchor">#</a> Activiti</h2> <ul><li>ProcessEngineConfiguration：加载activiti.cfg.xml配置文件</li> <li>ProcessEngine：快速获得各个service接口，生成activiti的工作环境以及25张表</li> <li>Service接口：
<ul><li>RepositoryService：对流程定义和部署的存储库的访问路径</li> <li>RuntimeService：实例流程相关</li> <li>TaskService：与正在执行的任务管理相关</li> <li>HistroyService：查询历史服务接口</li></ul></li></ul> <h2 id="elasticsearch"><a href="#elasticsearch" class="header-anchor">#</a> ElasticSearch</h2> <table><thead><tr><th>ElasticSearch</th> <th>关系数据库</th></tr></thead> <tbody><tr><td>Indices索引</td> <td>Databases数据库</td></tr> <tr><td>Types类型</td> <td>Tables表</td></tr> <tr><td>Documents文档</td> <td>Rows行</td></tr> <tr><td>Fields域</td> <td>Columns列</td></tr></tbody></table> <table><thead><tr><th>内容</th> <th>语法</th></tr></thead> <tbody><tr><td>查看所有索引</td> <td>GET _cat/indices</td></tr> <tr><td>查看索引结构</td> <td>GET /local_es_order/_mapping</td></tr> <tr><td>新建索引</td> <td>PUT /local_my_test<br>{&quot;mappings&quot;:{&quot;properties&quot;:{&quot;gender&quot;:{&quot;type&quot;:&quot;integer&quot;},&quot;name&quot;:{&quot;type&quot;:&quot;keyword&quot;},&quot;age&quot;:{&quot;type&quot;:&quot;integer&quot;}}}}</td></tr> <tr><td>获取索引详细信息</td> <td>GET /local_my_test</td></tr> <tr><td>删除索引</td> <td>DELETE /local_my_test</td></tr> <tr><td>插入索引</td> <td>PUT /local_my_test/_doc/1<br>{&quot;gender&quot;:1,&quot;name&quot;:&quot;test&quot;,&quot;age&quot;:30}</td></tr> <tr><td>根据id查找索引内容</td> <td>GET /local_my_test/_doc/1</td></tr></tbody></table></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/technology/test.html" class="prev">
        测试
      </a></span> <span class="next"><a href="/technology/database.html">
        数据库
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.4bf8400b.js" defer></script><script src="/assets/js/2.7cac40fb.js" defer></script><script src="/assets/js/5.a2a3c506.js" defer></script>
  </body>
</html>
